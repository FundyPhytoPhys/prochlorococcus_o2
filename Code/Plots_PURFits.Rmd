---
title: "Plots_PURFits"
author: 
- Mireille Savoie
- Douglas A. Campbell
date: "`r format(Sys.Date())`"
output:
  bookdown::html_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_float: TRUE
    toc_depth: 6
    fig_caption: yes
    pandoc_args: 
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
  bookdown::word_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_depth: 6
    fig_caption: yes
    pandoc_args: 
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
bibliography: [Manuscript_O2.bib, RPackages.bib]
csl: plos-one.csl
editor_options: 
  markdown: 
    wrap: 72
---

# Introduction

This .Rmd generates a one-way ANOVA to examine statistical differences between Harrison and Platt four parameter model fit to 660 nm (red light) and 450 nm (blue light) growth data for each combination of strain and [O~2~]. Additionally, a one-way ANOVA was used to examine statistical differences between Harrison and Platt [53] four parameter model fit to each photoperiod (4 h, 8 h, 12 h, 16 h) and pooled photoperiod growth data for each combination of strain and [O~2~]. Photoperiod growth data that showed complete growth inhibition for each combination of strain, [O~2~] and imposed spectral waveband were omitted from the pooled photoperiod model. Statistical differences were determined at P value < 0.05. It can be safely assumed that *P.marinus* dies at PAR of 0 µE therefore, dummy values of no growth (µ = 0) for dark conditions were assigned for each combination of [O~2~], photoperiod and spectral waveband for each strain to anchor the starting point of the model. 

The four parameters are:
I: incident light, umol photons m^-2^ s^-1^
a: alpha, initial slope of light response curve under limiting light; the 'affinity' of the culture for light.
Pmax: maximum rate of photosynthesis; umol O~2~ chl^-1^ s^-1^; the 'capacity' of the culture for photosynthesis.
b: beta 'photoinhibition' term for decline in oxygen evolution under increasing incident light.  This decrease can result from multiple mechanisms.

"PICO_Merged_GrowthFitsPURPAR.Rds" is called in from \Data\CleanData folder and generated PUR fit plots are saved as .png in \Output\Figures folder. 


## Set figure caption font size
```{css, echo=FALSE}
p.caption {
  font-size: 25px;
}
```


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = F)
knitr::opts_chunk$set(fig.path='Figs/')
```



```{r load libraries, include=FALSE}
# libraries; Note check actual dependencies
library(tidyverse)
library(lubridate)
library(broom)
library(knitr)
library(zoo)
library(grid)
library(gridExtra)
library(egg)
library(photobiology)
library(minpack.lm)

```




```{r set project variables}

#"..", takes up a level in the directory path
Project <- "PICO"
DataIn <- file.path("..","Data", "CleanData")
PlotsOut <- file.path("..","Output", "Figures")
PlotsOutPLOS <- file.path("..", "OutPut", "PLOSFiguresRound1")

```


Read .Rds
Multiple 'list' columns removed; this can sometimes happen if early steps generate 2 values for a single data frame column element; this converts the column to 'list' format to accomodate more than one value in a single data from column/row position.

```{r read ProcessFile}

PURPARFits <- readRDS(file = file.path(DataIn,"PICO_Merged_GrowthFitsPURPAR.Rds")) 

glimpse(PURPARFits)

PURPARFits <- PURPARFits|>
  select(-c("tubedata")) |>
  select(-contains("OD720")) |>
  select(-c("ExpCul", "Optode", "OptodeCh", "ExpEndDate", "ExpEndHour")) |>
  select(-contains("trunc_")) |>
  select(-contains("predict")) |>
  select(-c("deltaOD_Lmax", "deltaOD_Lmu_raw", "deltaOD_Lintercept",  "deltaOD_Lmax_se",  "deltaOD_Lintercept_se")) |>
  select(-c("GrowthAmpdeltaOD_14days", "PurData")) |>
  select(-c("ReplicateMean_deltaOD_Lmu_corr", "ReplicateSD_deltaOD_Lmu_corr", "ReplicateSE_deltaOD_Lmu_corr" )) |>
 filter(Par_ue %in% c(30,90,180)) |>
  filter(!is.na(PURPhotonDose_day)) # PURPhotonDose_day NA mess up fits Strain = MED4 x 250 =  O2_uM


 # y = ReplicateMean_deltaOD_Lmu_corr_day

PURPARFits <- PURPARFits |>
  mutate(deltaOD_Lmu_corr_day = deltaOD_Lmu_corr * 24)
  
glimpse(PURPARFits)

```

Make O2_uM and WL as factor levels from highest to lowest and remove all green light (WL= 530) growth data
```{r factor O2 WL and photoperiod}

PURPARFits <- PURPARFits %>%
  filter(WL %in% c("WW", 660, 450)) %>% 
  mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         WL= factor(WL, levels = c("WW", 660, 450)),
        Photoperiod = factor(Photoperiod, levels = c("16", "12", "8", "4" )))

 # Par_ue = factor(Par_ue, levels =  c(180, 120, 100,90,60, 30, 15))
```

```{r set colours and shapes}


MyWavelengths = c("WW", 660, 530, 450)
MCMIXColours = c("black", "#f40d30", w_length2rgb(530),  w_length2rgb(450))

names(MCMIXColours) <- MyWavelengths
MCMIXColours


MyPhotoperiods = as.factor(c(4, 8, 12, 16))
PhotoperiodShapes = c(15, 18, 16, 17)

names(PhotoperiodShapes) <- MyPhotoperiods
PhotoperiodShapes

```
# set linetypes
```{r linetypes}

MyPhotoperiods = c(16, 12, 8, 4)
MyLineTypes = c("dotdash","dashed", "dotted", "aa")

names(MyLineTypes) <- MyPhotoperiods
MyLineTypes

```


```{r create dummy no growths for dark conditions}


#DummyDF for SS120; SS120 is a low light strain, based on literature it can only grow up to 300 uE WW; SS120 consistently died at various light colors and oxygen levels latest at ~PUR 400; it can safely be assumed it dies at par_ue = 0
Dummy_Strain <- c("SS120")
Dummy_Photoperiod <- c(4, 8, 12, 16)
Dummy_Par_ue<- c(0)
Dummy_O2_uM <- c(2.5, 25.0, 250.0)
Dummy_WL <- c(450, 660, "WW")
Dummy_deltaOD_Lmu_corr <- c(0)
Dummy_Pur_ue<- c(0)
Dummy_deltaOD_Lmu_corr_day <- c(0)
Dummy_PUR_day <- c(0)


DummyDF_SS120 <- expand_grid(
  Dummy_Strain, Dummy_Photoperiod, Dummy_Par_ue, Dummy_O2_uM, Dummy_WL, Dummy_deltaOD_Lmu_corr, Dummy_Pur_ue, Dummy_deltaOD_Lmu_corr_day,Dummy_PUR_day
  ) %>%
  mutate(SampleID = "DummySS120")

DummyDF_Expand_SS120 <- rbind(DummyDF_SS120, DummyDF_SS120, DummyDF_SS120) %>% 
        rename(Strain = "Dummy_Strain",
        Photoperiod = "Dummy_Photoperiod",
        Par_ue = "Dummy_Par_ue",
        O2_uM = "Dummy_O2_uM", 
        WL = "Dummy_WL", 
        deltaOD_Lmu_corr = "Dummy_deltaOD_Lmu_corr",
        Pur_ue = "Dummy_Pur_ue",
        deltaOD_Lmu_corr_day = "Dummy_deltaOD_Lmu_corr_day",
        PURPhotonDose_day = "Dummy_PUR_day")


Dummy_Strain <- c("MIT9313")

DummyDF_MIT9313 <- expand_grid(
  Dummy_Strain, Dummy_Photoperiod, Dummy_Par_ue, Dummy_O2_uM, Dummy_WL, Dummy_deltaOD_Lmu_corr, Dummy_Pur_ue, Dummy_deltaOD_Lmu_corr_day,Dummy_PUR_day
  ) %>%
  mutate(SampleID = "DummyMIT9313")

DummyDF_Expand_MIT9313 <- rbind(DummyDF_MIT9313, DummyDF_MIT9313, DummyDF_MIT9313) %>% 
  rename(Strain = "Dummy_Strain",
        Photoperiod = "Dummy_Photoperiod",
        Par_ue = "Dummy_Par_ue",
        O2_uM = "Dummy_O2_uM", 
        WL = "Dummy_WL", 
        deltaOD_Lmu_corr = "Dummy_deltaOD_Lmu_corr",
        Pur_ue = "Dummy_Pur_ue",
        deltaOD_Lmu_corr_day = "Dummy_deltaOD_Lmu_corr_day",
        PURPhotonDose_day = "Dummy_PUR_day")


Dummy_Strain <- c("MED4")

DummyDF_MED4 <- expand_grid(
  Dummy_Strain, Dummy_Photoperiod, Dummy_Par_ue, Dummy_O2_uM, Dummy_WL, Dummy_deltaOD_Lmu_corr, Dummy_Pur_ue, Dummy_deltaOD_Lmu_corr_day,Dummy_PUR_day
  ) %>%
  mutate(SampleID = "DummyMED4")

DummyDF_Expand_MED4 <- rbind(DummyDF_MED4, DummyDF_MED4, DummyDF_MED4) %>% 
  rename(Strain = "Dummy_Strain",
        Photoperiod = "Dummy_Photoperiod",
        Par_ue = "Dummy_Par_ue",
        O2_uM = "Dummy_O2_uM", 
        WL = "Dummy_WL", 
        deltaOD_Lmu_corr = "Dummy_deltaOD_Lmu_corr",
        Pur_ue = "Dummy_Pur_ue",
        deltaOD_Lmu_corr_day = "Dummy_deltaOD_Lmu_corr_day",
        PURPhotonDose_day = "Dummy_PUR_day")

DummyDF_Expand <- rbind(DummyDF_Expand_SS120, DummyDF_Expand_MIT9313, DummyDF_Expand_MED4)

remove(DummyDF_MED4)
remove(DummyDF_MIT9313)
remove(DummyDF_SS120)
remove(DummyDF_Expand_MED4)
remove(DummyDF_Expand_MIT9313)
remove(DummyDF_Expand_SS120)

```


# Join dummy df to growth df
```{r add dummy dark growth to DF}

library(plyr)
PURPARFits_dummy<- rbind.fill(PURPARFits, DummyDF_Expand) # Apply the rbind.fill plyr function

detach("package:plyr")

remove(DummyDF_Expand)
remove(PURPARFits)

```


```{r testplot}
 PURPARFits_dummy %>% 
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, colour = WL)) +
    scale_colour_manual(values = MCMIXColours, labels = c("White LED", "660", "450" )) +
  facet_grid(rows = vars(Par_ue), cols = vars(Strain)) +
  theme_bw()
```


Citations: Ma X, Liu Q, Zhang Z, Zhang Z, Zhou Z, Jiang Y, et al. (2021) Effects of photosynthetic models on the calculation results of photosynthetic response parameters in young Larix principis- rupprechtii Mayr. plantation. PLoS ONE 16(12): e0261683. https://doi.org/10.1371/journal.pone.0261683

https://www.frontiersin.org/articles/10.3389/fpls.2020.581851/full

I: incident light, umol photons m-2 s-1
a: alpha, initial slope of light response curve under limiting light; the 'affinity' of the culture for light.
Pmax: maximum rate of photosynthesis; umol O2 chl-1 s-1; the 'capacity' of the culture for photosynthesis.

R: dark respiration, umol O2 chl-1 s-1

b: beta 'photoinhibition' term for decline in oxygen evolution under increasing incident light.  This decrease can result from multiple mechanisms.

g: gamma fitting term related to curvature of response.

d: change in respiration under illumination.
```{r grc models}
# simple saturating function; rectangular hyperbola
grc <- function(I, a, Pmax){((a * I * Pmax)/((a*I) + Pmax))
}
  #(equivalent to mm <- function(I, KM, Pmax){(Pmax* I)/(KM + I)})

TestI = c(0:14)

plot(x = TestI, y = grc(I = TestI, a = 0.1, Pmax = 1))

# # function with beta photoinhibition;
#https://www.frontiersin.org/articles/10.3389/fpls.2020.581851/full
 grcbeta <- function(I, a, b, g){(a * ((1 - (b*I))/(1 + (g*I)))*I)
 }
# 
 plot(x = TestI, y = grcbeta(I = TestI, a = 0.1, b = 0.1, g = 0.01))

#Platt et al., 1980
#Harrison & Platt, 1986
grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}

plot(x = TestI, y = grcplatt(I = TestI, a = 0.1, b = 0.1, Pmax = 1))



# linear equation to deal with photoperiods and exclusively no growth
LinEqn <- function(x, M, Intercept){((x*M)+ Intercept)}
  
LinEqnStart <- list(M = 0, Intercept = 0)

```


Issue with MED4 data at 250 uM; lhs of model 42, right hand 40; for some reason lhs prediction missing for two of the rhs diel PUR values

Causes 'augment' to fail.
Get around other ways if needed.

Issue: OrgPur_day is 'NA' for 3 rows of MED4 x O2_um = 250
Substitute in PURPhotonDose_day which includes extrapolated estimates of PUR for strain x growth light that lack OLIS spectra
 
```{r growthPURfits}

# model with dummy dark, 0 PAR,  growth rates. Nested by strain and [O2]. Filtered out data if no growth occurred for an O2 and photoperiod combination for each strain so that the model including all photoperiods would not be skewed towards zero.
PURPARStrainO2NestModels_filtered <- PURPARFits_dummy |>
  mutate(remove = case_when(Strain == "MED4" & Photoperiod == 4 ~ 1,
                            Strain == "MED4" & O2_uM == 25 & Photoperiod == 8 & WL == "WW" ~ 1,
                            Strain == "MIT9313" & O2_uM == 2.5 & Photoperiod == 16 ~ 1,
                            Strain == "MIT9313" & O2_uM == 2.5 & Photoperiod == 12 & WL == "WW" ~ 1,
                            Strain == "SS120"  & O2_uM == 2.5 & Photoperiod %in% c(16,8,4) ~ 1,
                            Strain == "SS120"  & O2_uM == 25 & Photoperiod %in% c(16) & WL == 450 ~ 1,
                            Strain == "SS120"  & O2_uM == 250 & Photoperiod %in% c(4) & WL == 450 ~ 1,
                            TRUE ~ 0)) |>
   filter(remove == 0) |>
  nest(data = -c("Strain","O2_uM")) |>
  mutate(GRCplatt_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ grcplatt(I = PURPhotonDose_day, a, b, Pmax),
                              data = .x,
                              start = list(a = 1e-7, b = 1e-8, Pmax = 1), 
                              lower = c(0, 0, 0),
                              upper = c(1,1,100),
                              control = list(maxiter = 500)
                         ), NULL)
                         )
         ) |>
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         ) |>
  mutate(GRClm_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ LinEqn(x = PURPhotonDose_day,  M, Intercept),
                              data = .x,
                              start = LinEqnStart
                         ), NULL)
                         )
         ) |>
  mutate(GRClm_Param = map(GRClm_Model, tidy),
         GRClm_Predict = map(GRClm_Model, possibly(augment)),
         GRClm_Glance = map(GRClm_Model, possibly(glance))
         )

# nest unfiltered data and join with filtered data to have all data to plot later 
AllData <- PURPARFits_dummy |>
    nest(Data_all = -c("Strain","O2_uM"))

PURPARStrainO2NestModels_filtered <- full_join(PURPARStrainO2NestModels_filtered, AllData)

# model with dummy dark, 0 PAR,  growth rates. Nested by strain, [O2] and photoperiod.
PURPARStrainO2PhotoNestModels <- PURPARFits_dummy |>
 nest(data = -c("Strain","O2_uM", "Photoperiod")) |>
  mutate(GRCplatt_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ grcplatt(I = PURPhotonDose_day, a, b, Pmax),
                              data = .x,
                              start = list(a = 1e-8, b = 1e-9, Pmax = 1),
                              lower = c(-0, 0, 0),
                              upper = c(1,1,100),
                              control = list(maxiter = 500)
                         ), NULL)
                         )
         ) |>
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         ) |>
  mutate(GRClm_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ LinEqn(x = PURPhotonDose_day,  M, Intercept),
                              data = .x,
                              start = LinEqnStart
                         ), NULL)
                         )
         ) |>
  mutate(GRClm_Param = map(GRClm_Model, tidy),
         GRClm_Predict = map(GRClm_Model, possibly(augment)),
         GRClm_Glance = map(GRClm_Model, possibly(glance))
         )

# model with dummy dark, 0 PAR,  growth rates. Nested by strain, [O2] and wavelength.
PURPARStrainO2WLNestModels <- PURPARFits_dummy |>
  nest(data = -c("Strain","O2_uM", "WL")) |>
  mutate(GRCplatt_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ grcplatt(I = PURPhotonDose_day, a, b, Pmax),
                              data = .x,
                              start = list(a = 1e-7, b = 1e-8, Pmax = 1),
                              lower = c(0, 0, 0),
                              upper = c(1,1,100),
                              control = list(maxiter = 500)
                         ), NULL)
                         )
         ) |>
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         )|>
  mutate(GRClm_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ LinEqn(x = PURPhotonDose_day,  M, Intercept),
                              data = .x,
                              start = LinEqnStart
                         ), NULL)
                         )
         ) |>
  mutate(GRClm_Param = map(GRClm_Model, tidy),
         GRClm_Predict = map(GRClm_Model, possibly(augment)),
         GRClm_Glance = map(GRClm_Model, possibly(glance))
         )


remove(AllData)

```

# Plot fits
```{r growthPURplots, fig.height= 10, fig.width= 10}

# PURPARStrainO2NestModels |>
#   filter(!map_lgl(GRC_Model, is.null)) |> #https://stackoverflow.com/questions/57336319/how-to-filter-out-null-elements-of-tibbles-list-column 
PURPARStrainO2NestModels_filtered|>
  filter(!map_lgl(GRCplatt_Model, is.null)) |>
  unnest(GRCplatt_Predict, data) |>
   mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         Photoperiod = factor(Photoperiod, levels = c(16, 12, 8, 4))) |>
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, colour = Photoperiod)) + 
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`)) + 
  facet_grid(rows = vars(O2_uM), cols = vars(Strain)) + 
  labs(title = "PURPARStrainO2NestModels_filtered Platt") +
  theme_bw()


PURPARStrainO2PhotoNestModels |>
  filter(!map_lgl(GRCplatt_Model, is.null)) |>
  unnest(GRCplatt_Predict, data) |>
   mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         Photoperiod = factor(Photoperiod, levels = c(16, 12, 8, 4))) |>
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, colour = WL)) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`)) +   
  scale_colour_manual(values = MCMIXColours) +
  facet_grid(rows = vars(O2_uM, Photoperiod), cols = vars(Strain)) +
    labs(title = "PURPARStrainO2PhotoNestModels Platt") +
  theme_bw()

PURPARStrainO2PhotoNestModels |>
  filter(!map_lgl(GRClm_Model, is.null)) |>
  unnest(GRClm_Predict, data) |>
   mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         Photoperiod = factor(Photoperiod, levels = c(16, 12, 8, 4))) |>
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, colour = WL)) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`)) +
   scale_colour_manual(values = MCMIXColours) +
  facet_grid(rows = vars(O2_uM, Photoperiod), cols = vars(Strain)) +
    labs(title = "PURPARStrainO2PhotoNestModels Linear Model") +
  theme_bw()

PURPARFits_dummy |>
  # unnest(data) |>
   mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         Photoperiod = factor(Photoperiod, levels = c(16, 12, 8, 4))) |>
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, colour = WL)) +
     scale_colour_manual(values = MCMIXColours) +
    facet_grid(rows = vars(O2_uM, Photoperiod), cols = vars(Strain)) +
    labs(title = "PURPARStrainO2PhotoNestModels all data no filter") +
  theme_bw()

PURPARStrainO2WLNestModels|>
  filter(!map_lgl(GRCplatt_Model, is.null)) |>
  unnest(GRCplatt_Predict, data) |>
   mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         Photoperiod = factor(Photoperiod, levels = c(16, 12, 8, 4))) |>
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, colour = WL)) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`)) +
   scale_colour_manual(values = MCMIXColours) +
  facet_grid(rows = vars(O2_uM, WL), cols = vars(Strain)) +
    labs(title = "PURPARStrainO2WLNestModels Linear Model") +
  theme_bw()

PURPARStrainO2WLNestModels|>
  filter(!map_lgl(GRClm_Model, is.null)) |>
  unnest(GRClm_Predict, data) |>
   mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         Photoperiod = factor(Photoperiod, levels = c(16, 12, 8, 4))) |>
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, colour = WL)) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`)) +
   scale_colour_manual(values = MCMIXColours) +
  facet_grid(rows = vars(O2_uM, WL), cols = vars(Strain)) +
    labs(title = "PURPARStrainO2WLNestModels Linear Model") +
  theme_bw()


```

# Want platt model for all fits that did not fail and lm for platt models that returned a NULL. NULLs were returned due to no growth across strain, O2 and photoperiod conditions.
```{r}
# O2 and Photoperiod nested data frame containing the fits for each photoperiod for each strain
#filter to keep platt models
KeepPlattModel <- PURPARStrainO2PhotoNestModels|>
  select(-c(GRClm_Glance, GRClm_Model, GRClm_Param, GRClm_Predict)) |>
   filter(!map_lgl(GRCplatt_Model, is.null))

#filter to keep only the models that failed to fit a platt model, fits by lm remains. 
KeepLmModel <- PURPARStrainO2PhotoNestModels|>
  filter(map_lgl(GRCplatt_Model, is.null)) |>
 select(-c(GRCplatt_Glance, GRCplatt_Model, GRCplatt_Param, GRCplatt_Predict))
   
# Join  
 StrainO2Photoperiod_PlattLmModel <- full_join(KeepPlattModel, KeepLmModel) 
 
 
 remove(KeepPlattModel)
 remove(KeepLmModel)

# O2 and Photoperiod nested data frame containing the fits for each photoperiod for each strain
 StrainO2Photoperiod_PlattLmModel <-  StrainO2Photoperiod_PlattLmModel |>
   pivot_longer(cols = -c(Strain, O2_uM, Photoperiod, data)) |>
  drop_na(value) |>
  filter(str_detect(name, pattern = "Model") | str_detect(name, pattern = "Glance") | str_detect(name, pattern = "Param") | str_detect(name, pattern = "Predict")) |>
  separate(col = name , into = c("ModelType", "Output"), sep = "_") |>
  pivot_wider(names_from = Output, values_from = value) |>
filter(!map_lgl(Model, is.null)) |>
  filter(!map_lgl(Glance, is.null)) |>
  mutate(AIC = map_dbl(Glance, ~ as.numeric(pluck(.x, "AIC")))) |>
  group_by(Strain, O2_uM, Photoperiod) |>
  filter(AIC == min(AIC)) |>
  ungroup() |>
  select(-c(Glance)) |>
  unnest(Param) |>
  select(-c(statistic)) |>
  pivot_wider(names_from = term, values_from = c(estimate, std.error, p.value))
 
 
 
# O2 nested data frame containing the single fit of pooled photoperiods 
 #filter to keep platt models
KeepPlattModel <- PURPARStrainO2NestModels_filtered|>
  select(-c(GRClm_Glance, GRClm_Model, GRClm_Param, GRClm_Predict)) |>
   filter(!map_lgl(GRCplatt_Model, is.null))

#filter to keep only the models that failed to fit a platt model, fits by lm remains. 
KeepLmModel <- PURPARStrainO2NestModels_filtered|>
  filter(map_lgl(GRCplatt_Model, is.null)) |>
 select(-c(GRCplatt_Glance, GRCplatt_Model, GRCplatt_Param, GRCplatt_Predict))
   
# Join  
StrainO2filtered_PlattLmModel <- full_join(KeepPlattModel, KeepLmModel) 
 
 
# O2 nested data frame containing the single fit of pooled photoperiods 
 StrainO2filtered_PlattLmModel <- StrainO2filtered_PlattLmModel|>
  pivot_longer(cols = -c(Strain, O2_uM, data, Data_all)) |>
  drop_na(value) |>
  filter(str_detect(name, pattern = "Model") | str_detect(name, pattern = "Glance") | str_detect(name, pattern = "Param") | str_detect(name, pattern = "Predict")) |>
  separate(col = name , into = c("ModelType", "Output"), sep = "_") |>
  pivot_wider(names_from = Output, values_from = value) |>
  filter(!map_lgl(Model, is.null)) |>
  filter(!map_lgl(Glance, is.null)) |>
  mutate(AIC = map_dbl(Glance, possibly(~ as.numeric(pluck(.x, "AIC"))))) |>
  group_by(Strain, O2_uM) |>
  filter(AIC == min(AIC)) |>
  ungroup() |>
  select(-c(Glance))|>
  unnest(Param) |>
  select(-c(statistic)) |>
  pivot_wider(names_from = term, values_from = c(estimate, std.error, p.value))
 
 remove(KeepPlattModel)
 remove(KeepLmModel)
 remove(PURPARStrainO2NestModels_filtered)
 remove(PURPARStrainO2PhotoNestModels)
 
```



Linear models do not have alpha, beta and pmax so inf and NA are generated. Change them to 0.
```{r lm platt parameters set to zero}

# O2 nested data frame containing the single fit of pooled photoperiods for each strain 
StrainO2filtered_PlattLmModel <- StrainO2filtered_PlattLmModel|>
  mutate(estimate_a = if_else(ModelType == "GRClm", 0, estimate_a),
         estimate_b = if_else(ModelType == "GRClm", 0, estimate_b),
         estimate_Pmax = if_else(ModelType == "GRClm", 0, estimate_Pmax),
         AIC = if_else(ModelType == "GRClm" & is.infinite(AIC), 0, AIC)) 
 
StrainO2filtered_PlattLmModel
  
# O2 and Photoperiod nested data frame containing the fits for each photoperiod for each strain
StrainO2Photoperiod_PlattLmModel <- StrainO2Photoperiod_PlattLmModel|>
  mutate(estimate_a = if_else(ModelType == "GRClm", 0, estimate_a),
         estimate_b = if_else(ModelType == "GRClm", 0, estimate_b),
         estimate_Pmax = if_else(ModelType == "GRClm", 0, estimate_Pmax),
         AIC = if_else(ModelType == "GRClm" & is.infinite(AIC), 0, AIC)) 
 
StrainO2Photoperiod_PlattLmModel


```



```{r plot models}

# O2 nested data frame containing the single fit of pooled photoperiods for each strain
StrainO2filtered_PlattLmModel |>
  unnest(Predict, data) |>
  mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         WL= factor(WL, levels = c("WW", 660, 450)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         Photoperiod = factor(Photoperiod, levels = c("16", "12", "8", "4"))) |>
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL))) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`)) + 
   geom_text(aes(x = 500000, y = 0.75, label = paste(ModelType), show.legend = FALSE)
  ) +
     scale_colour_manual(values = MCMIXColours) +
   scale_shape_manual(values = PhotoperiodShapes)  +
  facet_grid(rows = vars(O2_uM), cols = vars(Strain)) +
    labs(title = "Single fit and model indicated. Data omitted that showed complete growth \n inhibition for each combination of strain, [O2] and photoperiod except when \n complete inhibition occurred for a combination of strain and [O2].") +
  theme_bw()

# O2 and Photoperiod nested data frame containing the fits for each photoperiod for each strain
StrainO2Photoperiod_PlattLmModel |>
  unnest(Predict, data) |>
  mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         Photoperiod = factor(Photoperiod, levels = c(16, 12, 8, 4))) |>
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, colour = WL)) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`)) + 
   geom_text(aes(x = 500000, y = 0.75, label = paste(ModelType), show.legend = FALSE)
  ) +
     scale_colour_manual(values = MCMIXColours) +
  facet_grid(rows = vars(O2_uM, Photoperiod), cols = vars(Strain)) +
    labs(title = "Photoperiod fits to be used for ANOVA comparison to single fit across each \n strain and [O2].") +
  theme_bw()

```


# ANOVA comparison of single fit through pooled photoperiods for each strain and [O2] to the fit of each photoperiod in that pool. 
```{r compare 1 fit of all photoperiod to each photoperiods using platt or lm}

# make wider to join with DF that contains the 1 fit through all photoperiods
Wider_Photoperiods <- StrainO2Photoperiod_PlattLmModel %>% 
  select(Strain, Photoperiod, O2_uM, Model, Predict) %>% 
  pivot_wider(names_from = Photoperiod, values_from = c(Model, Predict))

# this contains 1 fit through all photoperiods for each strain and [O2] combination. Data omitted that showed complete growth inhibition for each combination of strain, [O2] and photoperiod except when complete inhibition occurred for a combination of strain and [O2].
AllPhotoperiods <- StrainO2filtered_PlattLmModel %>% 
  select(Strain, O2_uM, Model, Predict, Data_all, data) %>% 
 rename(All = 'Model',
        Predict_pooled = 'Predict',
        Data_filtered = 'data')


AllFitsCombinedPhoto <- left_join(Wider_Photoperiods, AllPhotoperiods)


ANOVA_AllPhotoperiods <- AllFitsCombinedPhoto %>% 
  mutate(twelve = `Model_12`,
         four = `Model_4`,
         eight = `Model_8`,
         sixteen = `Model_16`) %>%
  mutate(fourvsAll = map(map2(four, All, possibly(anova, otherwise = NULL)), tidy),
         eightvsAll = map(map2(eight, All, possibly(anova, otherwise = NA)), tidy),
         twelvevsAll = map(map2(twelve, All, possibly(anova, otherwise = NULL)), tidy),
         sixteenvsAll = map(map2(sixteen, All, possibly(anova, otherwise = NULL)), tidy)) %>% 
  select(Strain, O2_uM, fourvsAll, eightvsAll, twelvevsAll, sixteenvsAll) %>% 
  pivot_longer(cols = c(fourvsAll, eightvsAll, twelvevsAll, sixteenvsAll)) %>% 
  unnest(value, keep_empty = TRUE) %>% 
  filter(is.na(term) & is.na(p.value) |
           !is.na(term) & !is.na(p.value) | is.nan(p.value)) %>%
  select(Strain, O2_uM, name, p.value) %>% 
  separate(name, into = c("Photoperiod1", "AllPhotoperiod"), sep = "vs") %>% 
  mutate(pvalue = signif(`p.value`, digits = 2))

  
ANOVA_AllPhotoperiods %>% 
  mutate(Photoperiod1 = as.numeric(case_when(Photoperiod1 == 'four' ~ 4,
                                  Photoperiod1 == 'eight' ~ 8,
                                  Photoperiod1 == 'twelve' ~ 12,
                                  Photoperiod1 == 'sixteen' ~ 16)),
         O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313"))) %>%
  ggplot() +
  geom_text(aes(x = Photoperiod1, y = AllPhotoperiod, label = pvalue), data = . %>% filter(pvalue < 0.05), size = 2.5) +
  geom_text(aes(x = Photoperiod1, y = AllPhotoperiod), data = . %>% filter(pvalue > 0.05), label = "ns") +
  geom_text(aes(x = Photoperiod1, y = AllPhotoperiod), data = . %>% filter(is.na(pvalue)), label = "NA") +
  facet_grid(rows = vars(O2_uM), cols = vars(Strain)) +
  labs(title = "ANOVA compare all models",
       caption = "NA = atleast one model did not fit due to lack of data points; 
       ns = not significantly different from all photoperiod model (*P* value > 0.05); 
       numbers = significantly different pvalues from all photoperiod model (*P* value < 0.05)")


remove(Wider_Photoperiods)
remove(AllPhotoperiods)
remove(StrainO2filtered_PlattLmModel)
remove(StrainO2Photoperiod_PlattLmModel)


```

```{r PhotoperiodAnovaTable, include = FALSE}

PhotoperiodAnovaTable <- ANOVA_AllPhotoperiods %>% 
  mutate(Photoperiod = as.numeric(case_when(Photoperiod1 == 'four' ~ 4,
                                  Photoperiod1 == 'eight' ~ 8,
                                  Photoperiod1 == 'twelve' ~ 12,
                                  Photoperiod1 == 'sixteen' ~ 16)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         O2_uM = factor(O2_uM, levels = c(250, 25, 2.5))) %>% 
  select(-c(Photoperiod1, p.value, AllPhotoperiod))  %>%
  relocate(Photoperiod, .after = O2_uM) %>%
  arrange(Strain, O2_uM,Photoperiod) 
  
```


```{r PhotoperiodAnovaTable, fig.height = 6, fig.width = 8, echo = FALSE }

knitr::kable(PhotoperiodAnovaTable,
             caption = "pvalues for each photoperiod from ANOVA comparison with a fit of pooled photoperiods in each O~2~ experiment for each strain.",
            col.names =  c("Strain",
                           "[O~2~] (µM)",
                          "Photoperiod (h)",
                          "pvalue"),
              align = "lccc"
             )
```


# Individual fits are added that are sig different from the pooled photoperiod fit. 
Better way to do this is dynamically using p values from the ANOVA. 
```{r Pur plot strain faceted in columns, fig.height=10, fig.width=10}

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }


PhotoperiodPurFitsPlots <- AllFitsCombinedPhoto |>
  unnest(cols = c(Data_all), names_sep = "_", keep_empty = TRUE) |>
  mutate(PhotoperiodLabelTitle = "Photoperiod (h)",
         OxygenLabel = "Oxygen concentration (µM)",
         Photoperiod = factor(Data_all_Photoperiod, levels = c(16, 12, 8, 4)),
         O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         WL = factor(Data_all_WL, levels = c("WW", 660, 450)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313"))) %>%
  ggplot() +
  geom_line(aes(x = Data_all_PURPhotonDose_day, y = Data_all_ReplicateMean_deltaOD_Lmu_corr_day, linetype = as.factor(Photoperiod)), size = 0.01, alpha = 5, show.legend = F) +
  geom_line(aes(x = PURPhotonDose_day, y = .fitted, linetype = PhotoperiodPooled), size = 0.80, data = . %>% unnest(Predict_pooled) %>%  filter(Strain == "MED4") %>% mutate(PhotoperiodPooled = "Pooled")) +
  geom_rect(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "white") +
  geom_point(aes(x = Data_all_PURPhotonDose_day, y = Data_all_ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 3.5, alpha = 1.0) +
    geom_point(aes(x = Data_all_PURPhotonDose_day, y = Data_all_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 2.0, alpha = 0.6) +
  geom_line(aes(x = PURPhotonDose_day, y = .fitted), size = 0.80, linetype = "solid", show.legend = F, data = . %>% unnest(Predict_pooled) %>%  filter(Strain == "MED4")) +
   geom_line(aes(x = PURPhotonDose_day, y = .fitted), size = 0.6, linetype = "dotted", show.legend = F, data = . %>% unnest(Predict_8) %>%  filter(O2_uM != 2.5, Strain == "MED4")) +
   geom_line(aes(x = PURPhotonDose_day, y = .fitted), size = 0.6, linetype = "aa", show.legend = F, data = . %>% unnest(Predict_4) %>%  filter(O2_uM != 2.5, Strain == "MED4")) +
  geom_line(aes(x = PURPhotonDose_day, y = .fitted), size = 0.80, linetype = "solid", show.legend = F, data = . %>% unnest(Predict_pooled) %>%  filter(Strain == "SS120")) +
   geom_line(aes(x = PURPhotonDose_day, y = .fitted), size = 0.6, linetype = "dotdash", show.legend = F, data = . %>% unnest(Predict_16) %>%  filter(O2_uM == 2.5, Strain == "SS120")) +
   geom_line(aes(x = PURPhotonDose_day, y = .fitted), size = 0.6, linetype = "dashed", show.legend = F, data = . %>% unnest(Predict_12) %>%  filter(O2_uM == 250, Strain == "SS120")) +
   geom_line(aes(x = PURPhotonDose_day, y = .fitted), size = 0.6, linetype = "dotted", show.legend = F, data = . %>% unnest(Predict_8) %>%  filter(Strain == "SS120")) +
   geom_line(aes(x = PURPhotonDose_day, y = .fitted), size = 0.6, linetype = "aa", show.legend = F, data = . %>% unnest(Predict_4) %>%  filter(Strain == "SS120")) +
  geom_line(aes(x = PURPhotonDose_day, y = .fitted), size = 0.80, linetype = "solid", data = . %>% unnest(Predict_pooled) %>%  filter(Strain == "MIT9313")) +
  geom_line(aes(x = PURPhotonDose_day, y = .fitted), size = 0.6, linetype = "dotdash", show.legend = F, data = . %>% unnest(Predict_16) %>%  filter(O2_uM == 2.5, Strain == "MIT9313")) +
   geom_line(aes(x = PURPhotonDose_day, y = .fitted), size = 0.6, linetype = "dashed", data = . %>% unnest(Predict_12) %>%  filter(O2_uM == 25, Strain == "MIT9313")) +
   geom_line(aes(x = PURPhotonDose_day, y = .fitted), size = 0.6, linetype = "dotted", show.legend = F, data = . %>% unnest(Predict_8) %>%  filter(O2_uM != 2.5, Strain == "MIT9313")) +
   geom_line(aes(x = PURPhotonDose_day, y = .fitted), size = 0.6, linetype = "aa", show.legend = F, data = . %>% unnest(Predict_4) %>%  filter(Strain == "MIT9313")) +
 labs(y = "Chlorophyll specific growth rate " ~  " ("  ~ d^-1~")", x = "PUR (µmol photons" ~m^-2 ~d^-1~")") +
  scale_x_continuous(label=scientific_10) +
  scale_y_continuous(breaks = c(0,0.25, 0.5, 0.75, 1.0), limits = c (0, 1.05)) +
  scale_colour_manual(values = MCMIXColours, labels = c("White LED", "660 nm", "450 nm")) +
  scale_linetype_manual(values = c("solid", "dotdash", "dashed", "dotted", "aa"),
                        labels = c("Pooled", "16 h",  "12 h", "8 h", "4 h")) +
  scale_shape_manual(values = PhotoperiodShapes, labels = c("16 h",  "12 h", "8 h", "4 h") )  +
  ggh4x::facet_nested(rows = vars(OxygenLabel, O2_uM), cols = vars(Strain), 
                    labeller = labeller(Strain = label_value, O2_uM = label_value, OxygenLabel = label_value)) +
 guides(
   linetype = guide_legend(order = 1),
        fill = "none",) +
  theme_bw() +
   theme( strip.text = element_text(size = 25),
        axis.title.y = element_text(color = "black", size = 30,  hjust = 0.40),
        axis.title.x = element_text(color = "black", size = 30),
        axis.text.x = element_text(size = 20, color = "black", angle = 45, hjust = 1.0),
        axis.text.y = element_text(size = 20, color = "black", angle = 0, hjust = 1.0),
        legend.key.size = unit(1.8, 'cm'), #change legend key size
        legend.key.height = unit(0.5, 'cm'), #change legend key height
        # legend.key.width = unit(2.5, 'cm'), #change legend key width
        legend.background = element_rect(color = "black"),
        legend.title =  element_text(size = 25),  #change legend title font size
        legend.title.align = 0.5,
        legend.text = element_text(size = 25),   #change legend text font size
        legend.position = "top",
        legend.direction = "vertical",
        legend.spacing.x = unit(0.75, 'cm'),
        tagger.panel.tag.background = element_blank()) +
  labs( linetype = "Fits",
        shape = "Photoperiod",
        color = "Growth waveband",
       
      ) +
  tagger::tag_facets(tag_levels  = c("A", "I"), tag_suffix = "")

PhotoperiodPurFitsPlots

```


Would like to add Compact Letter Displays (cld). Some examples:
https://stackoverflow.com/questions/70854552/any-other-options-besides-the-traditional-cld-bar-graph/70863531#70863531
https://stackoverflow.com/questions/72756490/loop-tukey-post-hoc-letters-extraction/73274274#73274274
  
```{r, save PURFitPlots}

ggsave(file = file.path(PlotsOut, paste("PhotoperiodPurFitsPlots",".png",sep = "")), plot = PhotoperiodPurFitsPlots, device = NULL, scale = 1, height=40, width= 54, units = c("cm"),dpi = 300, limitsize = TRUE)

ggsave(file = file.path(PlotsOutPLOS, "S4_Fig.tiff"), plot = PhotoperiodPurFitsPlots, device = NULL, scale = 1, height=40, width= 54, units = c("cm"),dpi = 300, compression = "lzw", limitsize = TRUE)

```


# WL models for each strain for each O2 experiment
```{r Generate platt and lm for WL}

# model with dummy dark, 0 PAR,  growth rates. Nested by strain and [O2].
PURPARStrainO2NestModels <- PURPARFits_dummy |>
  nest(data = -c("Strain","O2_uM")) |>
  mutate(GRCplatt_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ grcplatt(I = PURPhotonDose_day, a, b, Pmax),
                              data = .x,
                              start = list(a = 1e-7, b = 1e-8, Pmax = 1), 
                              lower = c(0, 0, 0),
                              upper = c(1,1,100),
                              control = list(maxiter = 500)
                         ), NULL)
                         )
         ) |>
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         ) |>
  mutate(GRClm_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ LinEqn(x = PURPhotonDose_day,  M, Intercept),
                              data = .x,
                              start = LinEqnStart
                         ), NULL)
                         )
         ) |>
  mutate(GRClm_Param = map(GRClm_Model, tidy),
         GRClm_Predict = map(GRClm_Model, possibly(augment)),
         GRClm_Glance = map(GRClm_Model, possibly(glance))
         )

# nest unfiltered data and join with filtered data to have all data to plot later 
AllData <- PURPARFits_dummy |>
    nest(Data_all = -c("Strain","O2_uM"))

PURPARStrainO2NestModels <- full_join(PURPARStrainO2NestModels, AllData)


remove(AllData)
remove(PURPARFits_dummy)

```


# Want platt model for all fits that did not fail and lm for platt models that returned a NULL
```{r models for WL}
# O2 and WL nested data frame containing the fits for each WL for each strain
#filter to keep platt models
KeepPlattModel <- PURPARStrainO2WLNestModels|>
  select(-c(GRClm_Glance, GRClm_Model, GRClm_Param, GRClm_Predict)) |>
   filter(!map_lgl(GRCplatt_Model, is.null))

#filter to keep only the models that failed to fit a platt model, fits by lm remains. 
KeepLmModel <- PURPARStrainO2WLNestModels|>
  filter(map_lgl(GRCplatt_Model, is.null)) |>
 select(-c(GRCplatt_Glance, GRCplatt_Model, GRCplatt_Param, GRCplatt_Predict))
   
# Join  
 StrainO2WL_PlattLmModel <- bind_rows(KeepPlattModel, KeepLmModel) 
 
 
 remove(KeepPlattModel)
 remove(KeepLmModel)

# O2 and WL nested data frame containing the fits for each WL for each strain
 StrainO2WL_PlattLmModel <-  StrainO2WL_PlattLmModel |>
   pivot_longer(cols = -c(Strain, O2_uM, WL, data)) |>
  drop_na(value) |>
  filter(str_detect(name, pattern = "Model") | str_detect(name, pattern = "Glance") | str_detect(name, pattern = "Param") | str_detect(name, pattern = "Predict")) |>
  separate(col = name , into = c("ModelType", "Output"), sep = "_") |>
  pivot_wider(names_from = Output, values_from = value) |>
filter(!map_lgl(Model, is.null)) |>
  filter(!map_lgl(Glance, is.null)) |>
  mutate(AIC = map_dbl(Glance, ~ as.numeric(pluck(.x, "AIC")))) |>
  group_by(Strain, O2_uM, WL) |>
  filter(AIC == min(AIC)) |>
  ungroup() |>
  select(-c(Glance)) |>
  unnest(Param) |>
  select(-c(statistic)) |>
  pivot_wider(names_from = term, values_from = c(estimate, std.error, p.value))
 
 
# O2 nested data frame containing the single fit of pooled WL
 #filter to keep platt models
KeepPlattModel <- PURPARStrainO2NestModels|>
  select(-c(GRClm_Glance, GRClm_Model, GRClm_Param, GRClm_Predict)) |>
   filter(!map_lgl(GRCplatt_Model, is.null))

#filter to keep only the models that failed to fit a platt model, fits by lm remains. 
KeepLmModel <- PURPARStrainO2NestModels|>
  filter(map_lgl(GRCplatt_Model, is.null)) |>
 select(-c(GRCplatt_Glance, GRCplatt_Model, GRCplatt_Param, GRCplatt_Predict))
   
# Join  
StrainO2_PlattLmModel <- full_join(KeepPlattModel, KeepLmModel) 
 
 
# O2 nested data frame containing the single fit of pooled WLs 
 StrainO2_PlattLmModel <- StrainO2_PlattLmModel|>
  pivot_longer(cols = -c(Strain, O2_uM, data, Data_all)) |>
  drop_na(value) |>
  filter(str_detect(name, pattern = "Model") | str_detect(name, pattern = "Glance") | str_detect(name, pattern = "Param") | str_detect(name, pattern = "Predict")) |>
  separate(col = name , into = c("ModelType", "Output"), sep = "_") |>
  pivot_wider(names_from = Output, values_from = value) |>
  filter(!map_lgl(Model, is.null)) |>
  filter(!map_lgl(Glance, is.null)) |>
  mutate(AIC = map_dbl(Glance, possibly(~ as.numeric(pluck(.x, "AIC"))))) |>
  group_by(Strain, O2_uM) |>
  filter(AIC == min(AIC)) |>
  ungroup() |>
  select(-c(Glance))|>
  unnest(Param) |>
  select(-c(statistic)) |>
  pivot_wider(names_from = term, values_from = c(estimate, std.error, p.value))
 
 remove(KeepPlattModel)
 remove(KeepLmModel)
 remove(PURPARStrainO2NestModels)
 remove(PURPARStrainO2WLNestModels)
 
```



Linear models do not have alpha, beta and pmax so inf and NA are generated. Change them to 0.
```{r lm platt parameters set to zero}

# O2 nested data frame containing the single fit of pooled photoperiods for each strain 
StrainO2_PlattLmModel <- StrainO2_PlattLmModel|>
  mutate(estimate_a = if_else(ModelType == "GRClm", 0, estimate_a),
         estimate_b = if_else(ModelType == "GRClm", 0, estimate_b),
         estimate_Pmax = if_else(ModelType == "GRClm", 0, estimate_Pmax),
         AIC = if_else(ModelType == "GRClm" & is.infinite(AIC), 0, AIC)) 
 
StrainO2_PlattLmModel
  
# O2 and Photoperiod nested data frame containing the fits for each photoperiod for each strain
StrainO2WL_PlattLmModel <- StrainO2WL_PlattLmModel|>
  mutate(estimate_a = if_else(ModelType == "GRClm", 0, estimate_a),
         estimate_b = if_else(ModelType == "GRClm", 0, estimate_b),
         estimate_Pmax = if_else(ModelType == "GRClm", 0, estimate_Pmax),
         AIC = if_else(ModelType == "GRClm" & is.infinite(AIC), 0, AIC)) 
 
StrainO2WL_PlattLmModel


```


```{r plot WL models}

# O2 nested data frame containing the single fit of pooled photoperiods for each strain
StrainO2_PlattLmModel |>
  unnest(Predict, data) |>
  mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         WL= factor(WL, levels = c("WW", 660, 450)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         Photoperiod = factor(Photoperiod, levels = c("16", "12", "8", "4"))) |>
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL))) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`)) + 
   geom_text(aes(x = 500000, y = 0.75, label = paste(ModelType), show.legend = FALSE)
  ) +
     scale_colour_manual(values = MCMIXColours) +
   scale_shape_manual(values = PhotoperiodShapes)  +
  facet_grid(rows = vars(O2_uM), cols = vars(Strain)) +
    labs(title = "Single fit for each strain in each [O2]- all WL ") +
  theme_bw()

# O2 and Photoperiod nested data frame containing the fits for each photoperiod for each strain
StrainO2WL_PlattLmModel |>
  unnest(Predict, data) |>
  mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         Photoperiod = factor(Photoperiod, levels = c(16, 12, 8, 4))) |>
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, colour = WL)) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`)) + 
   geom_text(aes(x = 500000, y = 0.75, label = paste(ModelType), show.legend = FALSE)
  ) +
     scale_colour_manual(values = MCMIXColours) +
  facet_grid(rows = vars(O2_uM, WL), cols = vars(Strain)) +
    labs(title = "Fits across wavelengths used for one-way ANOVA comparison \n to eachother for each strain and [O2] combination") +
  theme_bw()

```

# ANOVA comparison of red light to blue light for each strain and [O2] combination. 
```{r compare 1 red and blue light fits}

# make wider to join with DF that contains the 1 fit through all photoperiods
Wider_WL <- StrainO2WL_PlattLmModel %>% 
  select(Strain, WL, O2_uM, Model, Predict) %>% 
  pivot_wider(names_from = WL, values_from = c(Model, Predict))



# this contains 1 fit through all WL.
AllWL <- StrainO2_PlattLmModel %>% 
  select(Strain, O2_uM, Model, Predict, Data_all) %>% 
 rename(All = 'Model',
        Predict_pooled = 'Predict')


AllFitsCombinedWL <- left_join(Wider_WL, AllWL)


ANOVA_AllWL <- AllFitsCombinedWL %>% 
  mutate(Blue = `Model_450`,
         Red = `Model_660`,
         White = `Model_WW`,
         Pooled = `All`) %>%
  mutate(BluevsPooled = map(map2(Blue, Pooled, possibly(anova, otherwise = NULL)), tidy),
         RedvsPooled = map(map2(Red, Pooled, possibly(anova, otherwise = NA)), tidy),
         WhitevsPooled = map(map2(White, Pooled, possibly(anova, otherwise = NULL)), tidy),
         BluevsRed = map(map2(Blue, Red, possibly(anova, otherwise = NULL)), tidy)) %>% 
  select(Strain, O2_uM, BluevsPooled, RedvsPooled, WhitevsPooled, BluevsRed) %>% 
  pivot_longer(cols = c(BluevsPooled, RedvsPooled, WhitevsPooled, BluevsRed)) %>% 
  unnest(value, keep_empty = TRUE) %>% 
  filter(is.na(term) & is.na(p.value) |
           !is.na(term) & !is.na(p.value) | is.nan(p.value)) %>%
  select(Strain, O2_uM, name, p.value) %>% 
  separate(name, into = c("WL1", "WL2"), sep = "vs") %>% 
  mutate(pvalue = signif(`p.value`, digits = 2))


  
ANOVA_AllWL %>% 
  mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313"))) %>%
    # mutate(Photoperiod1 = factor(Photoperiod1, levels = c('four','eight', 'twelve', 'sixteen'))) %>% 
  ggplot() +
  geom_text(aes(x = WL1, y = WL2, label = pvalue), data = . %>% filter(pvalue < 0.05), size = 2.5) +
  geom_text(aes(x = WL1, y = WL2), data = . %>% filter(pvalue > 0.05), label = "ns") +
  geom_text(aes(x = WL1, y = WL2), data = . %>% filter(is.na(pvalue)), label = "NA") +
  facet_grid(rows = vars(O2_uM), cols = vars(Strain)) +
  labs(title = "ANOVA compare all models",
       caption = "NA = atleast one model did not fit due to lack of data points; 
       ns = not significantly different from WL model (*P* value > 0.05); 
       numbers = significantly different pvalues from all WL model (*P* value < 0.05)")


remove(Wider_WL)
remove(AllWL)
remove(StrainO2_PlattLmModel)
remove(StrainO2WL_PlattLmModel)
```

```{r Pur plot strain faceted in columns , fig.height=10, fig.width=10}

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x)))}


BluevsRedPurFitsPlots <- AllFitsCombinedWL |>
  unnest(cols = c(Data_all), names_sep = "_", keep_empty = TRUE) |>
  filter(Data_all_WL %in% c(450,660)) %>% 
  mutate(PhotoperiodLabelTitle = "Photoperiod (h)",
         OxygenLabel = "Oxygen concentration (µM)",
         Photoperiod = factor(Data_all_Photoperiod, levels = c(16, 12, 8, 4)),
         O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         WL = factor(Data_all_WL, levels = c(660, 450)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313"))) %>%
  ggplot() +
  geom_line(aes(x = Data_all_PURPhotonDose_day, y = Data_all_ReplicateMean_deltaOD_Lmu_corr_day, linetype = as.factor(WL)), size = 1, show.legend = T) +
  geom_rect(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "white") +
  geom_point(aes(x = Data_all_PURPhotonDose_day, y = Data_all_ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 3.5, alpha = 1.0) +
    geom_point(aes(x = Data_all_PURPhotonDose_day, y = Data_all_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 2, alpha = 0.6) +
   geom_line(aes(x = PURPhotonDose_day, y = .fitted, color = as.factor(WL)), size = 0.6, data = . %>% unnest(Predict_450) %>%  filter(Strain == "MED4",  WL == 450), linetype = "solid", show.legend = F) +
  geom_line(aes(x = PURPhotonDose_day, y = .fitted, color = as.factor(WL)), size = 0.6, data = . %>% unnest(Predict_660) %>%  filter(Strain == "MED4", WL == 660) , linetype = "solid", show.legend = F) +
   geom_line(aes(x = PURPhotonDose_day, y = .fitted, color = as.factor(WL)), size = 0.6,  data = . %>% unnest(Predict_450) %>%  filter(Strain == "SS120", O2_uM == 25, WL == 450) , linetype = "solid", show.legend = F) +
 geom_line(aes(x = PURPhotonDose_day, y = .fitted, color = as.factor(WL)), size = 0.6,  data = . %>% unnest(Predict_660) %>%  filter(Strain == "SS120", O2_uM == 25, WL == 660) , linetype = "solid", show.legend = F) +
  geom_line(aes(x = PURPhotonDose_day, y = .fitted, color = as.factor(WL)), size = 0.6, linetype = "dashed", data = . %>% unnest(Predict_450) %>%  filter(Strain == "SS120", O2_uM != 25, WL == 450), show.legend = F) +
 geom_line(aes(x = PURPhotonDose_day, y = .fitted, color = as.factor(WL)), size = 0.6, linetype = "dashed",  data = . %>% unnest(Predict_660) %>%  filter(Strain == "SS120", O2_uM != 25, WL == 660), show.legend = F) +
  geom_line(aes(x = PURPhotonDose_day, y = .fitted, color = as.factor(WL)), size = 0.6, data = . %>% unnest(Predict_660) %>%  filter(Strain == "MIT9313", O2_uM != 250, WL == 660) , linetype = "solid", show.legend = F)+
    geom_line(aes(x = PURPhotonDose_day, y = .fitted, color = as.factor(WL)), size = 0.6, data = . %>% unnest(Predict_450) %>%  filter(Strain == "MIT9313", O2_uM != 250, WL == 450) , linetype = "solid", show.legend = F)+
  geom_line(aes(x = PURPhotonDose_day, y = .fitted, color = as.factor(WL)), size = 0.6, linetype = "dashed", data = . %>% unnest(Predict_450) %>%  filter(Strain == "MIT9313", O2_uM == 250, WL == 450), show.legend = F) +
 geom_line(aes(x = PURPhotonDose_day, y = .fitted, color = as.factor(WL)), size = 0.6, linetype = "dashed",  data = . %>% unnest(Predict_660) %>%  filter(Strain == "MIT9313", O2_uM == 250, WL == 660), show.legend = F) +
 labs(y = "Chlorophyll specific growth rate " ~  " ("  ~ d^-1~")", x = "PUR (µmol photons" ~m^-2 ~d^-1~")") +
  scale_x_continuous(label=scientific_10) +
  scale_y_continuous(breaks = c(0,0.25, 0.5, 0.75, 1.0), limits = c (0, 1.05)) +
  scale_linetype_manual(values = c("solid", "dashed"), labels = c(italic("P") ~ "value <0.05", italic("P") ~ "value >0.05")) +
  scale_colour_manual(values = MCMIXColours, labels = c("660 nm", "450 nm")) +
  scale_shape_manual(values = PhotoperiodShapes, labels = c("16 h", "12 h", "8 h", "4 h"))  +
  ggh4x::facet_nested(rows = vars(OxygenLabel, O2_uM), cols = vars(Strain), 
                    labeller = labeller(Strain = label_value, O2_uM = label_value, OxygenLabel = label_value)) +
 guides(
   linetype = guide_legend(order = 1),
         fill = "none",
         shape = guide_legend(override.aes = list(linetype = 0)),
         color = guide_legend(override.aes = list(linetype = 0))) +
  theme_bw()  +
   theme( strip.text = element_text(size = 25),
        axis.title.y = element_text(color = "black", size = 30,  hjust = 0.40),
        axis.title.x = element_text(color = "black", size = 30),
        axis.text.x = element_text(size = 20, color = "black", angle = 45, hjust = 1.0),
        axis.text.y = element_text(size = 20, color = "black", angle = 0, hjust = 1.0),
        legend.key.size = unit(1.8, 'cm'), #change legend key size
        legend.key.height = unit(0.5, 'cm'), #change legend key height
        # legend.key.width = unit(2.5, 'cm'), #change legend key width
        legend.background = element_rect(color = "black"),
        legend.title =  element_text(size = 25),  #change legend title font size
        legend.title.align = 0.5,
        legend.text = element_text(size = 25),   #change legend text font size
        legend.position = "top",
        legend.direction = "vertical",
        legend.spacing.x = unit(0.75, 'cm'),
        tagger.panel.tag.background = element_blank()) +
  labs( linetype = "Fits",
        shape = "Photoperiod",
        color = "Growth waveband",
      ) +
  tagger::tag_facets(tag_levels  = c("A", "I"), tag_suffix = "")


BluevsRedPurFitsPlots

```
  
```{r, save PURWLFitPlots}

ggsave(file = file.path(PlotsOut, paste("BluevsRedPurFitsPlots",".png",sep = "")), plot = BluevsRedPurFitsPlots, device = NULL, scale = 1, height=40, width= 54, units = c("cm"),dpi = 300, limitsize = TRUE)

 ggsave(file = file.path(PlotsOutPLOS, paste("Fig9.tiff",sep = "")), plot = BluevsRedPurFitsPlots, device = NULL, scale = 1, height=40, width= 54, units = c("cm"),dpi = 300, compression = "lzw", limitsize = TRUE)

```


```{r WLAnovaTable, include = FALSE}

WLAnovaTable <- ANOVA_AllWL %>% 
  filter(WL2 == "Red") %>% 
  mutate(Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         O2_uM = factor(O2_uM, levels = c(250, 25, 2.5))) %>% 
  select(-c(p.value)) %>% 
  arrange(Strain, O2_uM) 
  
```


```{r WLAnovaTable, fig.height = 6, fig.width = 8, echo = FALSE }

knitr::kable(WLAnovaTable,
             caption = "p values for each ANOVA comparison of fit of red and blue light in each O~2~ experiment for each strain.",
            col.names =  c("Strain",
                           "[O~2~] (µM)",
                          "WL1",
                          "WL2",
                          "pvalue"),
              align = "lcccc"
             )
```