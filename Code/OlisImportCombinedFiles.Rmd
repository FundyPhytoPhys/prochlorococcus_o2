---
title: "Import OLIS spectral data import"
author: "Douglas A. Campbell, Sylwia Sliwinska-Wilczewska, Sarah Gore, Adrian Kryk, Mireille Savoie"
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
---

# Import spectral files generated by OLIS spectrophotometer
# Specifically ascii files generated with more than 1 sample in a tab seperated format
# User input is needed to rename columns with the appropriate sample name according to users notes.
# Automation of renaming is not possible given that sometimes there were gaps in the sample id codes or codes were not sequential.
# Imported and renamed spectras are merged with meta catalog.
# output .RDS sent to folder that imports ascii files containing single spectras.
# Next .rmd to run is 'OlisImportCorrPICO_MS.rmd' which imports single spectras from .asc files, merge with meta catelog and will merge the already imported spectras generated from this .rmd.   

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

```{r set project variables}
Project <- "PICO"
DataOut <- file.path("..", "OLISSpectraCorr", "MiSa")

#Sylwia's file path
#DataIn <- file.path("..", "OLISSpectraCorr", "SySlCCASingleTest", fsep = .Platform$file.sep)

#Mireille's file path
DataIn <- file.path("..", "OLISSpectraCorr", "OtherCombinedData_375710", fsep = .Platform$file.sep)

FileID <- "Smooth"

#MDPicoGoogle <- "https://docs.google.com/spreadsheets/d/1Lerp5u25kzBtaBbnOYElYqUP59cn68gJpxxayhnGdkw/edit#gid=0"

FileEncode <- "UTF-8" 


HeaderRows <- 1
RollWindow <- 10

FileEncode <- "UTF-8" 
Delimiter <- "\t"


Skip <- 0  
Comment <- "#"

```


```{r load libraries} 
# libraries; Note check actual dependencies
library(tidyverse)
library(lubridate)

library(broom)
library(knitr)
library(OneR)

library(magrittr)
library(googledrive)
library(googlesheets4)
library(readxl)

library(ggspectra)
library(ggpubr)
library(caret)
```

```{r set colours}
Wavelengths_nm = c(405, 450, 475, 530, 615, 660, 730, "WW")
Colours_nm = c("violet", "darkblue", "dodgerblue", "darkgreen","orange","red","purple", "black")


names(Colours_nm) <- Wavelengths_nm
Colours_nm

```

For SySl files 'baseline' in filename means baseline spectra already subtracted within OLIS software.
This was not universallly true across all projects; be careful.
For SySl files 'raw' means spectra of undiluted culture; other spectra are 1 or 4 ml culture + 8 or 4 ml media.

Ideally: we want to read and tidy some user-selected set of files taken from multiple dates

```{r list available OLIS Files}
OlisFiles <- list.files(path = DataIn, pattern = ".asc", full.names = TRUE)
OlisFiles

#test for duplicate file names
unique(duplicated(OlisFiles))
```

Must import 1 file at time in order to assign proper culture id codes to the corresponding column.  Automation is not possible because each ascii file was generated with different column header names.
```{r set TargetFile}

TargetFile <- file.path(DataIn, "20220203_PICO_MiSa1081_MiSa1088_375710_baseline_JavCorr_Smooth.asc")

TargetFileName <- str_split(string = TargetFile, "/")[[1]][4] %>%
  str_remove(pattern = ".asc")

TargetFileName

```

# set up read_tsv_plus
```{r}
#make this more robust to variable file formats
#FileEncode <- "UTF-8"
#Delimiter <- ""
#.asc files from export from OLIS seem to use spaces as delimiter
# 
#HeaderRows <- 0

# read.delim_plus <- function(flnm, filencode, delimiter, headerrows){read.delim(flnm, fileEncoding = filencode, sep = delimiter,  skip = headerrows, header = TRUE, row.names = NULL) %>%
#      mutate(Filename = flnm, Cdatetime = ymd_hms(file.info(flnm)$ctime))
# }

#reads in tab as delimiter for multi columns of data of the combined ascii file
read_tsv_plus <- function(Flnm = TargetFile, HeaderRows){read_tsv(Flnm,  col_names = TRUE,  comment = Comment, locale=locale(encoding="latin1"), skip = HeaderRows) %>%
    #mutate(Filename = TargetFileName)}
     mutate(Filename = Flnm, Cdatetime = ymd_hms(file.info(Flnm)$ctime))}

```


# Import OLISSpectra corrected files
```{r import from specific OLIS corrected file containing multiple spectra}


OLIS_Data <- read_tsv_plus(Flnm = TargetFile, HeaderRows = Skip)  

glimpse(OLIS_Data)





```

Rename columns with proper SampleID
```{r}
OLIS_Data <- OLIS_Data %>%
  rename(nm = `OLIS-3D-ASCII`,
         MiSa1081 = `3`,  
         MiSa1082 = `4`,
         MiSa1083 = `5`,
         MiSa1084 = `6`,
         MiSa1085 = `7`,
         MiSa1086 = `8`,
         MiSa1087 = `9`,
         MiSa1088 = `10`) 

glimpse(OLIS_Data)

```


#Pivot Longer to get in same format as single sample saved ascii files.
```{r set up DF}
OLIS_Data <- OLIS_Data %>%
pivot_longer(., -c(`nm`, Filename, Cdatetime), values_to = "Absorbance", names_to = c("SampleID"))

glimpse(OLIS_Data)



OLIS_Data <- OLIS_Data %>%
  separate(col = Filename, into = c("Directory","Folder", "SubFolder", "Subsubfolder",  "Date", "Project", "FirstID", "LastID", "Range", "Source", "Correction", "Type"), sep = "([\\/\\_\\:])", remove = FALSE) %>% 
  arrange(SampleID, nm) %>%
  select(-c(Type, Correction, Source, Folder, Directory, SubFolder, Subsubfolder, Date,  FirstID, LastID)) %>% 
  rename(CultureID = SampleID) %>% 
 mutate(SpectraDate = str_extract(Filename, "[:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:][:digit:]_"),
         SpectraDate = str_remove_all(SpectraDate, "_"),
         SpectraDate = str_remove_all(SpectraDate, "/"),
         SpectraDate = ymd(SpectraDate))

glimpse(OLIS_Data)
```



#Load Multiculti catalog
```{r load local multiculticatalog, message = FALSE, warning = FALSE, echo=FALSE}
gs4_deauth()

# imagine this is the URL or ID of a Sheet readable by anyone (with a link)
# MultiCulti metadata
MetaData <- read_sheet("https://docs.google.com/spreadsheets/d/1ZXpwR7Gfto-uRzVdXzMpQF4frbrvMLH_IyLqonFZRSw/edit#gid=0") %>%
  # read_sheet has an annoying "feature" to set the type of columns it can't parse to a list.
  # ggplot/dplyr doesn't like working with a dataframe of lists.
  # In this case WL is set to a list since some values are numbers, some are strings, some are blank.
  # To fix this, first drop all rows missing WL, then unlist.
  # Must first drop NA rows since unlist will collapse NULL lists, then the unlisted WL is a shorter length than original WL column, which mutate doesn't like.
  drop_na(WL) %>%
  mutate(WL = unlist(WL))

as.data.frame(MetaData)

MetaData <- MetaData %>%
   mutate(ExpDate = ymd(ExpDate),
          ExpEndDate = ymd_hms(`ExpEndDate`))
```


# Merge OLISSpectra with MetaData
```{r OLISDateSpectra with MetaData}

#OLISSpectraMeta <- left_join(x = TargetSpectraLong2, y = MetaData, by = c("CultureID" = "ID"))

#OLISSpectraDirtyMeta <- left_join(x = OLISSpectraDirty, y = MetaData,  by = c("SampleID" = "ID"))

# rm(MetaData)
# rm(OLISSpectra)
#remove large MetaData dataframe to lower memory overhead


OLISSpectraMeta <- MetaData %>%
  right_join(., OLIS_Data, by = c("ID" = "CultureID"))


OLISSpectraMeta <- OLISSpectraMeta %>%
group_by(ID) %>%
  arrange(SpectraDate) %>%
  mutate(E_days = as.numeric((SpectraDate - ExpDate[1]))) %>%
ungroup()


```


# Save assembled spectra data set
```{r save Olis}

saveRDS(object = OLISSpectraMeta, file = file.path(DataOut, paste(TargetFileName, "CombinedLabeled.Rds",  sep = "_")), ascii = FALSE, version = NULL,
        compress = TRUE, refhook = NULL)

```
