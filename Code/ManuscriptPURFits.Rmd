---
title: "ManuscriptPURFits"
author: 
- Mireille Savoie
- Douglas A. Campbell
date: "`r format(Sys.Date())`"
output:
  bookdown::html_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_float: TRUE
    toc_depth: 6
    fig_caption: yes
    pandoc_args: 
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
  bookdown::word_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_depth: 6
    fig_caption: yes
    pandoc_args: 
      - '--lua-filter=scholarly-metadata.lua'
      - '--lua-filter=author-info-blocks.lua'
bibliography: [Manuscript_O2.bib, RPackages.bib]
csl: plos-one.csl
editor_options: 
  markdown: 
    wrap: 72
---

To Do


## Set figure caption font size
```{css, echo=FALSE}
p.caption {
  font-size: 25px;
}
```


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = F)
knitr::opts_chunk$set(fig.path='Figs/')
```



```{r load libraries, include=FALSE}
# libraries; Note check actual dependencies
library(tidyverse)
library(lubridate)
#library(stringr)
library(broom)
library(knitr)
library(zoo)
#library(AICcmodavg)
# library(RColorBrewer)
# library(grid)
# library(bookdown)
# library(glue)
# library(egg)
# library(ggspectra)
# library(photobiologyWavebands)
# library(photobiology)
#library(ggpubr)
#library(ggh4x)
#library(cowplot)
#library(jmv)
# library(pgirmess) # for the post hoc kruskalalmc test
#library(rcompanion) # for Scheirer-Ray-Hare non-parametric 2 way test, derived from Kruskal-Wallis
# library(FSA) # for Dunn test
#library(dunn.test)
# library(rstatix)
library(minpack.lm)

```




```{r set project variables}

#"..", takes up a level in the directory path
Project <- "PICO"
DataIn <- file.path("..","Data", "CleanData")
PlotsOut <- file.path("..","Output", "Figures")

```


Read .Rds
Multiple 'list' columns removed; this can sometimes happen if early steps generate 2 values for a single data frame column element; this converts the column to 'list' format to accomodate more than one value in a single data from column/row position.

```{r read ProcessFile}

PURPARFits <- readRDS(file = file.path(DataIn,"PICO_Merged_GrowthFitsPURPAR.Rds")) 

glimpse(PURPARFits)

PURPARFits <- PURPARFits|>
  select(-c("tubedata")) |>
  select(-contains("OD720")) |>
  select(-c("ExpCul", "Optode", "OptodeCh", "ExpEndDate", "ExpEndHour")) |>
  select(-contains("trunc_")) |>
  select(-contains("predict")) |>
  select(-c("deltaOD_Lmax", "deltaOD_Lmu_raw", "deltaOD_Lintercept",  "deltaOD_Lmax_se",  "deltaOD_Lintercept_se")) |>
  select(-c("GrowthAmpdeltaOD_14days", "PurData")) |>
  select(-c("ReplicateMean_deltaOD_Lmu_corr", "ReplicateSD_deltaOD_Lmu_corr", "ReplicateSE_deltaOD_Lmu_corr" )) |>
 filter(Par_ue %in% c(30,90,180)) |>
  filter(!is.na(PURPhotonDose_day)) # PURPhotonDose_day NA mess up fits Strain = MED4 x 250 =  O2_uM


 # y = ReplicateMean_deltaOD_Lmu_corr_day

PURPARFits <- PURPARFits |>
  mutate(deltaOD_Lmu_corr_day = deltaOD_Lmu_corr * 24)
  
glimpse(PURPARFits)

```

Make O2_uM and WL as factor levels from highest to lowest and remove all green light (WL= 530) growth data
```{r O2 levels}

PURPARFits <- PURPARFits %>%
  filter(WL %in% c("WW", 660, 450)) %>% 
  mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         WL= factor(WL, levels = c("WW", 660, 450)),
        Photoperiod = factor(Photoperiod, levels = c("16", "12", "8", "4" )))

 # Par_ue = factor(Par_ue, levels =  c(180, 120, 100,90,60, 30, 15))
```

```{r set colours and shapes}

library(photobiology)


MyWavelengths = c("WW", 660, 530, 450)
MCMIXColours = c("black", w_length2rgb(660), w_length2rgb(530),  w_length2rgb(450))

names(MCMIXColours) <- MyWavelengths
MCMIXColours


MyPhotoperiods = as.factor(c(4, 8, 12, 16))
PhotoperiodShapes = c(6, 18, 16, 17)


names(PhotoperiodShapes) <- MyPhotoperiods
PhotoperiodShapes

```


```{r create dummy no growths for dark conditions}


#DummyDF for SS120; SS120 is a low light strain, based on literature it can only grow up to 300 uE WW; SS120 consistently died at various light colors and oxygen levels latest at ~PUR 400; it can safely be assumed it dies at par_ue = 0
Dummy_Strain <- c("SS120")
Dummy_Photoperiod <- c(4, 8, 12, 16)
Dummy_Par_ue<- c(0)
Dummy_O2_uM <- c(2.5, 25.0, 250.0)
Dummy_WL <- c(450, 660, "WW")
Dummy_deltaOD_Lmu_corr <- c(0)
Dummy_Pur_ue<- c(0)
Dummy_deltaOD_Lmu_corr_day <- c(0)
Dummy_PUR_day <- c(0)



DummyDF_SS120 <- expand_grid(
  Dummy_Strain, Dummy_Photoperiod, Dummy_Par_ue, Dummy_O2_uM, Dummy_WL, Dummy_deltaOD_Lmu_corr, Dummy_Pur_ue, Dummy_deltaOD_Lmu_corr_day,Dummy_PUR_day
  ) %>%
  mutate(SampleID = "DummySS120")

DummyDF_Expand_SS120 <- rbind(DummyDF_SS120, DummyDF_SS120, DummyDF_SS120) %>% 
        rename(Strain = "Dummy_Strain",
        Photoperiod = "Dummy_Photoperiod",
        Par_ue = "Dummy_Par_ue",
        O2_uM = "Dummy_O2_uM", 
        WL = "Dummy_WL", 
        deltaOD_Lmu_corr = "Dummy_deltaOD_Lmu_corr",
        Pur_ue = "Dummy_Pur_ue",
        deltaOD_Lmu_corr_day = "Dummy_deltaOD_Lmu_corr_day",
        PURPhotonDose_day = "Dummy_PUR_day")


Dummy_Strain <- c("MIT9313")

DummyDF_MIT9313 <- expand_grid(
  Dummy_Strain, Dummy_Photoperiod, Dummy_Par_ue, Dummy_O2_uM, Dummy_WL, Dummy_deltaOD_Lmu_corr, Dummy_Pur_ue, Dummy_deltaOD_Lmu_corr_day,Dummy_PUR_day
  ) %>%
  mutate(SampleID = "DummyMIT9313")

DummyDF_Expand_MIT9313 <- rbind(DummyDF_MIT9313, DummyDF_MIT9313, DummyDF_MIT9313) %>% 
  rename(Strain = "Dummy_Strain",
        Photoperiod = "Dummy_Photoperiod",
        Par_ue = "Dummy_Par_ue",
        O2_uM = "Dummy_O2_uM", 
        WL = "Dummy_WL", 
        deltaOD_Lmu_corr = "Dummy_deltaOD_Lmu_corr",
        Pur_ue = "Dummy_Pur_ue",
        deltaOD_Lmu_corr_day = "Dummy_deltaOD_Lmu_corr_day",
        PURPhotonDose_day = "Dummy_PUR_day")


Dummy_Strain <- c("MED4")

DummyDF_MED4 <- expand_grid(
  Dummy_Strain, Dummy_Photoperiod, Dummy_Par_ue, Dummy_O2_uM, Dummy_WL, Dummy_deltaOD_Lmu_corr, Dummy_Pur_ue, Dummy_deltaOD_Lmu_corr_day,Dummy_PUR_day
  ) %>%
  mutate(SampleID = "DummyMED4")

DummyDF_Expand_MED4 <- rbind(DummyDF_MED4, DummyDF_MED4, DummyDF_MED4) %>% 
  rename(Strain = "Dummy_Strain",
        Photoperiod = "Dummy_Photoperiod",
        Par_ue = "Dummy_Par_ue",
        O2_uM = "Dummy_O2_uM", 
        WL = "Dummy_WL", 
        deltaOD_Lmu_corr = "Dummy_deltaOD_Lmu_corr",
        Pur_ue = "Dummy_Pur_ue",
        deltaOD_Lmu_corr_day = "Dummy_deltaOD_Lmu_corr_day",
        PURPhotonDose_day = "Dummy_PUR_day")

DummyDF_Expand <- rbind(DummyDF_Expand_SS120, DummyDF_Expand_MIT9313, DummyDF_Expand_MED4)



remove(DummyDF_MED4)
remove(DummyDF_MIT9313)
remove(DummyDF_SS120)
remove(DummyDF_Expand_MED4)
remove(DummyDF_Expand_MIT9313)
remove(DummyDF_Expand_SS120)


```


# Join dummy df to growth df
```{r add dummy dark growth to DF}

library(plyr)
PURPARFits_dummy<- rbind.fill(PURPARFits, DummyDF_Expand) # Apply the rbind.fill plyr function

detach("package:plyr")

remove(DummyDF_Expand)
remove(PURPARFits)

```


```{r testplot}
 PURPARFits_dummy %>% 
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, colour = WL)) +
    scale_colour_manual(values = MCMIXColours, labels = c("White LED", "660", "450" )) +
  facet_grid(rows = vars(Par_ue), cols = vars(Strain)) +
  theme_bw()
```


Citations: Ma X, Liu Q, Zhang Z, Zhang Z, Zhou Z, Jiang Y, et al. (2021) Effects of photosynthetic models on the calculation results of photosynthetic response parameters in young Larix principis- rupprechtii Mayr. plantation. PLoS ONE 16(12): e0261683. https://doi.org/10.1371/journal.pone.0261683

https://www.frontiersin.org/articles/10.3389/fpls.2020.581851/full

I: incident light, umol photons m-2 s-1
a: alpha, initial slope of light response curve under limiting light; the 'affinity' of the culture for light.
Pmax: maximum rate of photosynthesis; umol O2 chl-1 s-1; the 'capacity' of the culture for photosynthesis.

R: dark respiration, umol O2 chl-1 s-1

b: beta 'photoinhibition' term for decline in oxygen evolution under increasing incident light.  This decrease can result from multiple mechanisms.

g: gamma fitting term related to curvature of response.

d: change in respiration under illumination.
```{r grc models}
# simple saturating function; rectangular hyperbola
grc <- function(I, a, Pmax){((a * I * Pmax)/((a*I) + Pmax))
}
  #(equivalent to mm <- function(I, KM, Pmax){(Pmax* I)/(KM + I)})

TestI = c(0:14)

plot(x = TestI, y = grc(I = TestI, a = 0.1, Pmax = 1))

# # function with beta photoinhibition;
#https://www.frontiersin.org/articles/10.3389/fpls.2020.581851/full
 grcbeta <- function(I, a, b, g){(a * ((1 - (b*I))/(1 + (g*I)))*I)
 }
# 
 plot(x = TestI, y = grcbeta(I = TestI, a = 0.1, b = 0.1, g = 0.01))

#Platt et al., 1980
#Harrison & Platt, 1986
grcplatt <- function(I, a, b, Pmax){Pmax * (1-exp(-a*I/Pmax)) * exp(-b*I/Pmax)}

plot(x = TestI, y = grcplatt(I = TestI, a = 0.1, b = 0.1, Pmax = 1))



# linear equation to deal with photoperiods and exclusively no growth
LinEqn <- function(x, M, Intercept){((x*M)+ Intercept)}
  
LinEqnStart <- list(M = 0, Intercept = 0)

```


Issue with MED4 data at 250 uM; lhs of model 42, right hand 40; for some reason lhs prediction missing for two of the rhs diel PUR values

Causes 'augment' to fail.
Get around other ways if needed.

Issue: OrgPur_day is 'NA' for 3 rows of MED4 x O2_um = 250
Substitute in PURPhotonDose_day which includes extrapolated estimates of PUR for strain x growth light that lack OLIS spectra
 
```{r growthPURfits}

# model with dummy dark, 0 PAR,  growth rates. Also removed data if no growth occurred for an O2 and photoperiod combination so that the model including all photoperiods would not be skewed towards zero. As per Amanda and Doug's advice, filtered out PUR d-1 above 2.0e+06 because only photoperiods greater than 4 hrs have PUR d-1 above.
PURPARStrainO2NestModels <- PURPARFits_dummy |>
  mutate(remove = case_when(Strain == "MED4" & Photoperiod == 4 ~ 1,
                            Strain == "MED4" & O2_uM == 25 & Photoperiod == 8 & WL == "WW" ~ 1,
                            Strain == "MIT9313" & O2_uM == 2.5 & Photoperiod == 16 ~ 1,
                            Strain == "MIT9313" & O2_uM == 2.5 & Photoperiod == 12 & WL == "WW" ~ 1,
                            Strain == "SS120"  & O2_uM == 2.5 & Photoperiod %in% c(16,8,4) ~ 1,
                            Strain == "SS120"  & O2_uM == 25 & Photoperiod %in% c(16) & WL == 450 ~ 1,
                            Strain == "SS120"  & O2_uM == 250 & Photoperiod %in% c(4) & WL == 450 ~ 1,
                            TRUE ~ 0)) |>
   filter(remove == 0) |>
          # PURPhotonDose_day <= 2.0e+06) |>
  nest(data = -c("Strain","O2_uM")) |>
  mutate(GRCplatt_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ grcplatt(I = PURPhotonDose_day, a, b, Pmax),
                              data = .x,
                              start = list(a = 1e-7, b = 1e-8, Pmax = 1), 
                              lower = c(0, 0, 0),
                              upper = c(1,1,100),
                              control = list(maxiter = 500)
                         ), NULL)
                         )
         ) |>
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         ) |>
  mutate(GRClm_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ LinEqn(x = PURPhotonDose_day,  M, Intercept),
                              data = .x,
                              start = LinEqnStart
                         ), NULL)
                         )
         ) |>
  mutate(GRClm_Param = map(GRClm_Model, tidy),
         GRClm_Predict = map(GRClm_Model, possibly(augment)),
         GRClm_Glance = map(GRClm_Model, possibly(glance))
         )

# Nest all data before photoperiods with no growths were filtered out
NoFilter <- PURPARFits_dummy |>
   # filter(PURPhotonDose_day <= 2.0e+06) |>
  mutate(Photoperiod_all = Photoperiod) %>% 
  nest(Data_all = -c("Strain","O2_uM"))
  
  
 # Join nested df with all data to df containing filtered data 
  PURPARStrainO2NestModels <- full_join(PURPARStrainO2NestModels, NoFilter) %>% 
    rename(Data_filtered = 'data')

remove(NoFilter)
  
# PURPARStrainO2NestModels <- PURPARFits_dummy |>
#   nest(data = -c("Strain","O2_uM")) |>
#   mutate(GRCplatt_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ grcplatt(I = PURPhotonDose_day, a, b, Pmax),
#                               data = .x,
#                               start = list(a = 1e-7, b = 1e-8, Pmax = 1), 
#                               lower = c(0, 0, 0),
#                               upper = c(1,1,100),
#                               control = list(maxiter = 500)
#                          ), NULL)
#                          )
#          ) |>
#   mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),
#          GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),
#          GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
#          ) |>
#   mutate(GRClm_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ LinEqn(x = PURPhotonDose_day,  M, Intercept),
#                               data = .x,
#                               start = LinEqnStart
#                          ), NULL)
#                          )
#          ) |>
#   mutate(GRClm_Param = map(GRClm_Model, tidy),
#          GRClm_Predict = map(GRClm_Model, possibly(augment)),
#          GRClm_Glance = map(GRClm_Model, possibly(glance))
#          )

# # model with dummy dark, 0 PAR, 0 growth rates
# PURPARStrainO2PhotoNestModels <- PURPARFits_dummy  |>
#  nest(data = -c("Strain","O2_uM", "Photoperiod")) |>
#   mutate(GRCplatt_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ grcplatt(I = PURPhotonDose_day, a, b, Pmax),
#                               data = .x,
#                               start = list(a = 1e-8, b = 1e-9, Pmax = 1),
#                               lower = c(-0, 0, 0),
#                               upper = c(1,1,100),
#                               control = list(maxiter = 500)
#                          ), NULL)
#                          )
#          ) |>
#   mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),
#          GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),
#          GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
#          ) |>
#   mutate(GRClm_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ LinEqn(x = PURPhotonDose_day,  M, Intercept),
#                               data = .x,
#                               start = LinEqnStart
#                          ), NULL)
#                          )
#          ) |>
#   mutate(GRClm_Param = map(GRClm_Model, tidy),
#          GRClm_Predict = map(GRClm_Model, possibly(augment)),
#          GRClm_Glance = map(GRClm_Model, possibly(glance))
#          )

PURPARStrainO2PhotoNestModels <- PURPARFits_dummy |>
   # filter(PURPhotonDose_day <= 2.0e+06) |>
 nest(data = -c("Strain","O2_uM", "Photoperiod")) |>
  mutate(GRCplatt_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ grcplatt(I = PURPhotonDose_day, a, b, Pmax),
                              data = .x,
                              start = list(a = 1e-8, b = 1e-9, Pmax = 1),
                              lower = c(-0, 0, 0),
                              upper = c(1,1,100),
                              control = list(maxiter = 500)
                         ), NULL)
                         )
         ) |>
  mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),
         GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),
         GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
         ) |>
  mutate(GRClm_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ LinEqn(x = PURPhotonDose_day,  M, Intercept),
                              data = .x,
                              start = LinEqnStart
                         ), NULL)
                         )
         ) |>
  mutate(GRClm_Param = map(GRClm_Model, tidy),
         GRClm_Predict = map(GRClm_Model, possibly(augment)),
         GRClm_Glance = map(GRClm_Model, possibly(glance))
         )

# # model with dummy dark, 0 PAR,  growth rates 
# PURPARStrainO2WLNestModels <- PURPARFits_dummy |>
#   nest(data = -c("Strain","O2_uM", "WL")) |>
#   mutate(GRCplatt_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ grcplatt(I = PURPhotonDose_day, a, b, Pmax),
#                               data = .x,
#                               start = list(a = 1e-7, b = 1e-8, Pmax = 1),
#                               lower = c(0, 0, 0),
#                               upper = c(1,1,100),
#                               control = list(maxiter = 500)
#                          ), NULL)
#                          )
#          ) |>
#   mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),
#          GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),
#          GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
#          )|>
#   mutate(GRClm_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ LinEqn(x = PURPhotonDose_day,  M, Intercept),
#                               data = .x,
#                               start = LinEqnStart
#                          ), NULL)
#                          )
#          ) |>
#   mutate(GRClm_Param = map(GRClm_Model, tidy),
#          GRClm_Predict = map(GRClm_Model, possibly(augment)),
#          GRClm_Glance = map(GRClm_Model, possibly(glance))
#          )
# 
# 
# # model with dummy dark, 0 PAR,  growth rates
# PURPARStrainO2PeriodWLNest <- PURPARFits_dummy |>
#   nest(data = -c("Strain","O2_uM", "Photoperiod", "WL")) |>
#   mutate(GRCplatt_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ grcplatt(I = PURPhotonDose_day, a, b, Pmax),
#                               data = .x,
#                               start = list(a = 1e-7, b = 1e-8, Pmax = 1),
#                               lower = c(0, 0, 0),
#                               upper = c(1,1,100),
#                               control = list(maxiter = 500)
#                          ), NULL)
#                          )
#          ) |>
#   mutate(GRCplatt_Param = map(GRCplatt_Model, tidy),
#          GRCplatt_Predict = map(GRCplatt_Model, possibly(augment)),
#          GRCplatt_Glance = map(GRCplatt_Model, possibly(glance))
#          )|>
#   mutate(GRClm_Model = map(data, possibly(~nlsLM(deltaOD_Lmu_corr_day ~ LinEqn(x = PURPhotonDose_day,  M, Intercept),
#                               data = .x,
#                               start = LinEqnStart
#                          ), NULL)
#                          )
#          ) |>
#   mutate(GRClm_Param = map(GRClm_Model, tidy),
#          GRClm_Predict = map(GRClm_Model, possibly(augment)),
#          GRClm_Glance = map(GRClm_Model, possibly(glance))
#          )

```

# Plot fits
```{r growthPURplots, fig.height= 10, fig.width= 10}

# PURPARStrainO2NestModels |>
#   filter(!map_lgl(GRC_Model, is.null)) |> #https://stackoverflow.com/questions/57336319/how-to-filter-out-null-elements-of-tibbles-list-column 

PURPARStrainO2NestModels|>
  filter(!map_lgl(GRCplatt_Model, is.null)) |>
  unnest(GRCplatt_Predict, Data_filtered) |>
   mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         Photoperiod = factor(Photoperiod, levels = c(16, 12, 8, 4))) |>
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, colour = Photoperiod)) + 
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`)) + 
  facet_grid(rows = vars(O2_uM), cols = vars(Strain)) + 
  labs(title = "PURPARStrainO2NestModels Platt") +
  theme_bw()


PURPARStrainO2PhotoNestModels |>
  filter(!map_lgl(GRCplatt_Model, is.null)) |>
  unnest(GRCplatt_Predict, data) |>
   mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         Photoperiod = factor(Photoperiod, levels = c(16, 12, 8, 4))) |>
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, colour = WL)) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`)) +   
  scale_colour_manual(values = MCMIXColours) +
  facet_grid(rows = vars(O2_uM, Photoperiod), cols = vars(Strain)) +
    labs(title = "PURPARStrainO2PhotoNestModels Platt") +
  theme_bw()

PURPARStrainO2PhotoNestModels |>
  filter(!map_lgl(GRClm_Model, is.null)) |>
  unnest(GRClm_Predict, data) |>
   mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         Photoperiod = factor(Photoperiod, levels = c(16, 12, 8, 4))) |>
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, colour = WL)) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`)) +
   scale_colour_manual(values = MCMIXColours) +
  facet_grid(rows = vars(O2_uM, Photoperiod), cols = vars(Strain)) +
    labs(title = "PURPARStrainO2PhotoNestModels Linear Model") +
  theme_bw()

PURPARFits_dummy |>
  # unnest(data) |>
   mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         Photoperiod = factor(Photoperiod, levels = c(16, 12, 8, 4))) |>
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, colour = WL)) +
  # geom_line(aes(x = PURPhotonDose_day, y = `.fitted`)) +
     scale_colour_manual(values = MCMIXColours) +
    facet_grid(rows = vars(O2_uM, Photoperiod), cols = vars(Strain)) +
    labs(title = "PURPARStrainO2PhotoNestModels all data no filter") +
  theme_bw()


```

# Want platt model for all fits that did not fail and lm for platt models that returned a NULL
```{r}
# O2 and Photoperiod nested data frame containing the fits for each photoperiod for each strain
#filter to keep platt models
KeepPlattModel <- PURPARStrainO2PhotoNestModels|>
  select(-c(GRClm_Glance, GRClm_Model, GRClm_Param, GRClm_Predict)) |>
   filter(!map_lgl(GRCplatt_Model, is.null))

#filter to keep only the models that failed to fit a platt model, fits by lm remains. 
KeepLmModel <- PURPARStrainO2PhotoNestModels|>
  filter(map_lgl(GRCplatt_Model, is.null)) |>
 select(-c(GRCplatt_Glance, GRCplatt_Model, GRCplatt_Param, GRCplatt_Predict))
   
# Join  
StrainO2Photoperiod_AllModels <- full_join(KeepPlattModel, KeepLmModel) 
 
 
 remove(KeepPlattModel)
 remove(KeepLmModel)

# O2 and Photoperiod nested data frame containing the fits for each photoperiod for each strain
 StrainO2Photoperiod_PlattLmModel <- StrainO2Photoperiod_AllModels |>
   pivot_longer(cols = -c(Strain, O2_uM, Photoperiod, data)) |>
  drop_na(value) |>
  filter(str_detect(name, pattern = "Model") | str_detect(name, pattern = "Glance") | str_detect(name, pattern = "Param") | str_detect(name, pattern = "Predict")) |>
  separate(col = name , into = c("ModelType", "Output"), sep = "_") |>
  pivot_wider(names_from = Output, values_from = value) |>
filter(!map_lgl(Model, is.null)) |>
  filter(!map_lgl(Glance, is.null)) |>
  mutate(AIC = map_dbl(Glance, ~ as.numeric(pluck(.x, "AIC")))) |>
  group_by(Strain, O2_uM, Photoperiod) |>
  filter(AIC == min(AIC)) |>
  ungroup() |>
  select(-c(Glance)) |>
  unnest(Param) |>
  select(-c(statistic)) |>
  pivot_wider(names_from = term, values_from = c(estimate, std.error, p.value))
 
 
 
# O2 nested data frame containing the single fit of pooled photoperiods 
 #filter to keep platt models
KeepPlattModel <- PURPARStrainO2NestModels|>
  select(-c(GRClm_Glance, GRClm_Model, GRClm_Param, GRClm_Predict)) |>
   filter(!map_lgl(GRCplatt_Model, is.null))

#filter to keep only the models that failed to fit a platt model, fits by lm remains. 
KeepLmModel <- PURPARStrainO2NestModels|>
  filter(map_lgl(GRCplatt_Model, is.null)) |>
 select(-c(GRCplatt_Glance, GRCplatt_Model, GRCplatt_Param, GRCplatt_Predict))
   
# Join  
StrainO2_AllModels <- full_join(KeepPlattModel, KeepLmModel) 
 
 
# O2 nested data frame containing the single fit of pooled photoperiods 
 StrainO2filtered_PlattLmModel <- StrainO2_AllModels|>
  # select(-c(data)) |>
  pivot_longer(cols = -c(Strain, O2_uM, Data_filtered, Data_all)) |>
  drop_na(value) |>
  filter(str_detect(name, pattern = "Model") | str_detect(name, pattern = "Glance") | str_detect(name, pattern = "Param") | str_detect(name, pattern = "Predict")) |>
  separate(col = name , into = c("ModelType", "Output"), sep = "_") |>
  pivot_wider(names_from = Output, values_from = value) |>
  filter(!map_lgl(Model, is.null)) |>
  filter(!map_lgl(Glance, is.null)) |>
  mutate(AIC = map_dbl(Glance, possibly(~ as.numeric(pluck(.x, "AIC"))))) |>
  group_by(Strain, O2_uM) |>
  filter(AIC == min(AIC)) |>
  ungroup() |>
  select(-c(Glance))|>
  unnest(Param) |>
  select(-c(statistic)) |>
  pivot_wider(names_from = term, values_from = c(estimate, std.error, p.value))
 
 remove(KeepPlattModel)
 remove(KeepLmModel)
  remove(StrainO2Photoperiod_AllModels)
  remove(StrainO2_AllModels)
 
```



Linear models do not have alpha, beta and pmax so inf and NA are generated. Change them to 0.
```{r lm platt parameters set to zero}

# O2 nested data frame containing the single fit of pooled photoperiods for each strain 
StrainO2filtered_PlattLmModel <- StrainO2filtered_PlattLmModel|>
  mutate(estimate_a = if_else(ModelType == "GRClm", 0, estimate_a),
         estimate_b = if_else(ModelType == "GRClm", 0, estimate_b),
         estimate_Pmax = if_else(ModelType == "GRClm", 0, estimate_Pmax),
         AIC = if_else(ModelType == "GRClm" & is.infinite(AIC), 0, AIC)) 
 
StrainO2filtered_PlattLmModel
  
# O2 and Photoperiod nested data frame containing the fits for each photoperiod for each strain
StrainO2Photoperiod_PlattLmModel <- StrainO2Photoperiod_PlattLmModel|>
  mutate(estimate_a = if_else(ModelType == "GRClm", 0, estimate_a),
         estimate_b = if_else(ModelType == "GRClm", 0, estimate_b),
         estimate_Pmax = if_else(ModelType == "GRClm", 0, estimate_Pmax),
         AIC = if_else(ModelType == "GRClm" & is.infinite(AIC), 0, AIC)) 
 
StrainO2Photoperiod_PlattLmModel


```



```{r plot models}

# O2 nested data frame containing the single fit of pooled photoperiods for each strain
StrainO2filtered_PlattLmModel |>
  unnest(Predict, Data_filtered) |>
  mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         WL= factor(WL, levels = c("WW", 660, 450)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         Photoperiod = factor(Photoperiod, levels = c("16", "12", "8", "4"))) |>
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL))) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`)) + 
   geom_text(aes(x = 500000, y = 0.75, label = paste(ModelType), show.legend = FALSE)
  ) +
     scale_colour_manual(values = MCMIXColours) +
   scale_shape_manual(values = PhotoperiodShapes)  +
  facet_grid(rows = vars(O2_uM), cols = vars(Strain)) +
    labs(title = "Single fit for each strain in each [O2]- all photoperiods included that had growth") +
  theme_bw()

# O2 and Photoperiod nested data frame containing the fits for each photoperiod for each strain
StrainO2Photoperiod_PlattLmModel |>
  unnest(Predict, data) |>
  mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313")),
         Photoperiod = factor(Photoperiod, levels = c(16, 12, 8, 4))) |>
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, colour = WL)) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`)) + 
   geom_text(aes(x = 500000, y = 0.75, label = paste(ModelType), show.legend = FALSE)
  ) +
     scale_colour_manual(values = MCMIXColours) +
  facet_grid(rows = vars(O2_uM, Photoperiod), cols = vars(Strain)) +
    labs(title = "Fits to be used for ANOVA comparison to single fit across each strain and [O2]") +
  theme_bw()

```


# ANOVA comparison of single fit through pooled photoperiods for each strain and [O2] to the fit of each photoperiod in that pool. 
```{r compare 1 fit of all photoperiod to each photoperiods using platt or lm}

# make wider to join with DF that contains the 1 fit through all photoperiods
Wider_Photoperiods <- StrainO2Photoperiod_PlattLmModel %>% 
  select(Strain, Photoperiod, O2_uM, Model, Predict, data) %>% 
  pivot_wider(names_from = Photoperiod, values_from = c(Model, Predict, data))


# Wider_Photoperiods <- StrainO2Photoperiod_PlattLmModel %>% 
#   mutate(PhotoperiodLabel = Photoperiod) %>% 
#   select(Strain, Photoperiod, O2_uM, Model, Predict, data, PhotoperiodLabel) %>% 
#   pivot_wider(names_from = PhotoperiodLabel, values_from = c(Model, Predict)) %>% 
#     unnest(data) %>% 
#   group_by(Strain, O2_uM) %>% 
#     nest(Data_Photoperiod = -c(Strain, O2_uM, Model_16,Model_12, Model_8, Model_4, Predict_16, Predict_12, Predict_8, Predict_4)) %>% 
#   filter(!is.null(Model_16) & !is.null(Predict_16) |
#            !is.null(Model_12) & !is.null(Predict_12)|
#            !is.null(Model_8) & !is.null(Predict_8) |
#            !is.null(Model_4) & !is.null(Predict_4))

# Wider_Photoperiods <- StrainO2Photoperiod_PlattLmModel %>% 
#   select(Strain, Photoperiod, O2_uM, Model, Predict) %>% 
#   pivot_wider(names_from = Photoperiod, values_from = c(Model, Predict)) %>% 
#   unnest(Predict_16, keep_empty = TRUE) %>% 
#     mutate(Photoperiod = 16)%>% 
#     nest(Predict_16 = -c(Strain, O2_uM, Model_16, Model_12, Model_8, Model_4, Predict_12, Predict_8, Predict_4)) %>% 
#   unnest(Predict_12, keep_empty = TRUE) %>% 
#     mutate(Photoperiod = 12)%>% 
#     nest(Predict_12 = -c(Strain, O2_uM, Model_16, Model_12, Model_8, Model_4, Predict_16, Predict_8, Predict_4))%>% 
#   unnest(Predict_8, keep_empty = TRUE) %>% 
#     mutate(Photoperiod = 8)%>% 
#     nest(Predict_8 = -c(Strain, O2_uM, Model_16, Model_12, Model_8, Model_4, Predict_16, Predict_12, Predict_4))%>% 
#   unnest(Predict_4, keep_empty = TRUE) %>% 
#     mutate(Photoperiod = 4)%>% 
#     nest(Predict_4 = -c(Strain, O2_uM, Model_16, Model_12, Model_8, Model_4, Predict_16, Predict_12, Predict_8))

# this contains 1 fit through all photoperiods, the photoperiods with no growth were filtered out.
AllPhotoperiods <- StrainO2filtered_PlattLmModel %>% 
  select(Strain, O2_uM, Model, Predict, Data_filtered, Data_all) %>% 
 rename(All = 'Model',
        Predict_all = 'Predict')


AllFitsCombined <- left_join(Wider_Photoperiods, AllPhotoperiods)


ANOVA_AllPhotoperiods <- AllFitsCombined %>% 
  mutate(twelve = `Model_12`,
         four = `Model_4`,
         eight = `Model_8`,
         sixteen = `Model_16`) %>%
  mutate(fourvsAll = map(map2(four, All, possibly(anova, otherwise = NULL)), tidy),
         eightvsAll = map(map2(eight, All, possibly(anova, otherwise = NULL)), tidy),
         twelvevsAll = map(map2(twelve, All, possibly(anova, otherwise = NULL)), tidy),
         sixteenvsAll = map(map2(sixteen, All, possibly(anova, otherwise = NULL)), tidy)) %>% 
  select(Strain, O2_uM, fourvsAll, eightvsAll, twelvevsAll, sixteenvsAll) %>% 
  pivot_longer(cols = c(fourvsAll, eightvsAll, twelvevsAll, sixteenvsAll)) %>% 
  unnest(value, keep_empty = TRUE) %>% 
  filter(is.na(term) & is.na(p.value) |
           !is.na(term) & !is.na(p.value)) %>%
  select(Strain, O2_uM, name, p.value) %>% 
  separate(name, into = c("Photoperiod1", "AllPhotoperiod"), sep = "vs") %>% 
  mutate(pvalue = signif(`p.value`, digits = 2))

# %>% 
#   mutate(p.value = case_when(is.na(p.value) ~ 0,
#                              TRUE ~ p.value)) # Changed all failed fits to p.value = 0
  # mutate(pval = pluck(value, "p.value", 2))
  
ANOVA_AllPhotoperiods %>% 
  mutate(Photoperiod1 = as.numeric(case_when(Photoperiod1 == 'four' ~ 4,
                                  Photoperiod1 == 'eight' ~ 8,
                                  Photoperiod1 == 'twelve' ~ 12,
                                  Photoperiod1 == 'sixteen' ~ 16)),
         O2_uM = factor(O2_uM, levels = c(250, 25, 2.5)),
         Strain = factor(Strain, levels = c("MED4", "SS120", "MIT9313"))) %>%
    # mutate(Photoperiod1 = factor(Photoperiod1, levels = c('four','eight', 'twelve', 'sixteen'))) %>% 
  ggplot() +
  geom_text(aes(x = Photoperiod1, y = AllPhotoperiod, label = pvalue), data = . %>% filter(pvalue < 0.05), size = 2.5) +
  geom_text(aes(x = Photoperiod1, y = AllPhotoperiod), data = . %>% filter(pvalue > 0.05), label = "ns") +
  geom_text(aes(x = Photoperiod1, y = AllPhotoperiod), data = . %>% filter(is.na(pvalue)), label = "NA") +
  facet_grid(rows = vars(O2_uM), cols = vars(Strain)) +
  labs(title = "ANOVA compare all models",
       caption = "NA = atleast one model did not fit due to lack of data points; 
       ns = not significantly different from all photoperiod model (p value > 0.05); 
       numbers = significantly different pvalues from all photoperiod model (p value < 0.05)")


remove(Wider_Photoperiods)
remove(AllPhotoperiods)
```


# Unnest predict df for each photoperiod and join with pooled fit in order to plot fitted 
```{r}

Unnest_16 <- AllFitsCombined %>% 
  select(c(Strain, O2_uM, Predict_16)) %>%  
  unnest(Predict_16, keep_empty = TRUE) %>% 
  mutate(FitCategory = "sixteen",
         Photoperiod = 16)

Unnest_12 <- AllFitsCombined %>% 
  select(c(Strain, O2_uM, Predict_12)) %>%  
  unnest(Predict_12, keep_empty = TRUE) %>% 
  mutate(FitCategory = "twelve",
         Photoperiod = 12)

Unnest_8 <- AllFitsCombined %>% 
  select(c(Strain, O2_uM, Predict_8)) %>%  
  unnest(Predict_8, keep_empty = TRUE) %>% 
  mutate(FitCategory = "eight",
         Photoperiod = 8)

Unnest_4 <- AllFitsCombined %>% 
  select(c(Strain, O2_uM, Predict_4)) %>%  
  unnest(Predict_4, keep_empty = TRUE) %>% 
  mutate(FitCategory = "four",
         Photoperiod = 4)

Unnest_pooled <- AllFitsCombined %>% 
  select(c(Strain, O2_uM, Predict_all, Data_all)) %>% 
  # unnest(Data_all, keep_empty = TRUE) %>% 
  unnest(Predict_all, keep_empty = TRUE) %>% 
  mutate(FitCategory = "Pooled")

ForFitPlots <- bind_rows(Unnest_pooled, Unnest_16, Unnest_12, Unnest_8, Unnest_4)

remove(Unnest_16, Unnest_12, Unnest_8, Unnest_4, Unnest_pooled)

ForFitPlots <- left_join(ForFitPlots, ANOVA_AllPhotoperiods %>% select(Strain, O2_uM, Photoperiod1, pvalue), by = c("Strain", "O2_uM", "FitCategory" = "Photoperiod1"))

```



#Mirelle left off here,
# Need to use the DF with all data (all the photoperiods that showed complete no growth )
#next add fits that were sig different, do this dynamically
```{r Plot fits, fig.height= 20, fig.width= 20 }

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }


ForFitPlots |>
    filter(Strain == "MED4") |>
    unnest(cols = c(Data_all), names_sep = "_", keep_empty = TRUE) |>
  # unnest(Predict_4, names_sep = "_", keep_empty = TRUE) |>
  # unnest(Predict_8, names_sep = "_", keep_empty = TRUE) |>
  # unnest(Predict_12, names_sep = "_", keep_empty = TRUE) |>
  # unnest(Predict_16, names_sep = "_", keep_empty = TRUE) |>
  mutate(PhotoperiodLabel_title = "Photoperiod (h)",
         OxygenLabel = "Oxygen Concentration (µM)",
         Photoperiod = factor(Data_all_Photoperiod, levels = c("16", "12", "8", "4")),
         O2_uM = factor(O2_uM, levels = c(250, 25, 2.5))) %>%
  ggplot()  +
   geom_point(aes(x = Data_all_PURPhotonDose_day, y = Data_all_ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(Data_all_WL), fill = as.factor(Data_all_WL)), size = 6, alpha = 0.8) +
  geom_point(aes(x = Data_all_PURPhotonDose_day, y = Data_all_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(Data_all_WL), fill = as.factor(Data_all_WL)), size = 2, alpha = 1.0) +
  geom_line(aes(x = PURPhotonDose_day, y = .fitted), data = . %>% filter(FitCategory == "Pooled"), size = 2, color = "Blue") + 
  geom_line(aes(x = PURPhotonDose_day, y = .fitted, linetype = "twodash"), data = . %>% filter(FitCategory == "sixteen" & O2_uM == 25), size = 0.5) +
  geom_line(aes(x = PURPhotonDose_day, y = .fitted, linetype = "dotdash"), data = . %>% filter(FitCategory == "eight"), size = 0.5) +
  geom_line(aes(x = PURPhotonDose_day, y = .fitted,  linetype = "aa"), data = . %>% filter(FitCategory == "four"), size = 0.5) +
  # geom_line(aes(x = PURPhotonDose_day, y = .fitted, shape = as.factor(Photoperiod), linetype = as.factor(Photoperiod)), data = . %>% filter(FitCategory == "four"), size = 0.5) +
 # labs(title = "MED4", y = "Chlorophyll Specific Growth Rate " ~  " ("  ~ d^-1~")", x = "PUR (µmol photons" ~m^-2 ~d^-1~")") +
 #geom_text(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr, label= Run),hjust=0.3, vjust=0) +
  # geom_ribbon(aes(x = PURPhotonDose_day, ymin = ReplicateMean_deltaOD_Lmu_corr_day - ReplicateSE_deltaOD_Lmu_corr_day, ymax = ReplicateMean_deltaOD_Lmu_corr_day + ReplicateSE_deltaOD_Lmu_corr_day, fill = as.factor(WL)), alpha = 0.2, color = NA) +
  # geom_errorbar(aes(x = PURPhotonDose_day, ymin = (ReplicateMean_deltaOD_Lmu_corr_day - deltaOD_Lmu_se), ymax = (ReplicateMean_deltaOD_Lmu_corr_day + deltaOD_Lmu_se)), size = 0.3, color = 'black', data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
    # scale_x_continuous(labels=scales::trans_format('log10', scales::math_format(10^.x)),
    #                    # limits = c(10^4, 10^7),
    #                    breaks = c(10^4, 10^5, 10^6)) +
  scale_x_continuous(label=scientific_10) +
      # scale_x_continuous(breaks = c(10^5, 10^6.0, 10^7), limits = c(10^5, 10^7)) +
    # scale_x_continuous(breaks = c(10^4.2, 10^6, 10^6.7), limits = c(10^4.2, 10^6.7)) +
  # coord_cartesian(xlim = c (0, 16)) +
   scale_y_continuous(breaks = c(0,0.2, 0.4, 0.6, 0.8, 1.0), limits = c (0, 1.05)) +
  # coord_cartesian(ylim = c (0, 0.07)) +
  scale_colour_manual(values = MCMIXColours) +
   # scale_x_continuous(values = c(min(PURPARFits$PURPhotonDose_day), max(PURPARFits$PURPhotonDose_day)), breaks = seq) +
   # scale_x_log10(labels=scales::trans_format('log10',scales::math_format(10^.x)), breaks = c(10^4, 10^5, 10^6, 10^7), limits = c(10^4, 10^7)) +
  # scale_y_continuous(limits = c(-0.05,0.050)) +
   scale_linetype_manual(values = c("twodash", "dotdash", "aa"),labels = c("16 hr", "8 hr", "4 hr")) +
   scale_shape_manual(values = PhotoperiodShapes)  +
  ggh4x::facet_nested(rows = vars(OxygenLabel, O2_uM), 
                    labeller = labeller(Strain = label_both, WL = label_both, O2_uM = label_value, Photoperiod = label_value, PhotoperiodLabel_title = label_value, OxygenLabel = label_value)) +
 guides(linetype = guide_legend(nrow = 5),
        fill = "none",
        colour = guide_legend(nrow = 4)) +
 guides(shape = guide_legend(nrow = 4)) +
  theme_bw() +
   theme( strip.text = element_text(size = 30),
        axis.title = element_text(size = 30, color = "black"),
        axis.text.x = element_text(size = 20, color = "black", angle = 45, hjust = 1.0),
        axis.text.y = element_text(size = 20, color = "black", angle = 0, hjust = 1.0),
        strip.background=element_rect(color="grey87", fill = "grey82"),
        # strip.background=element_rect(fill = "white"),
        legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(1, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width
        legend.title =  element_text(size = 25),  #change legend title font size
        legend.text = element_text(size = 25),   #change legend text font size
        legend.position = "top") +
  labs( shape = "Photoperiod (h)",
        color = "Growth Waveband (nm)",
       linetype = "Photoperiod (h) "
      )

AllFitsCombined |>
   filter(Strain == "SS120") |>
  unnest(cols = c(Data_all, Predict_all), names_sep = "_", keep_empty = TRUE) |>
  mutate(PhotoperiodLabel_title = "Photoperiod (h)",
         OxygenLabel = "Oxygen Concentration (µM)",
         Photoperiod = factor(Data_all_Photoperiod, levels = c("16", "12", "8", "4" )),
         O2_uM = factor(O2_uM, levels = c(250, 25, 2.5))) %>%
  ggplot()  +
  geom_point(aes(x = Data_all_PURPhotonDose_day, y = Data_all_ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Data_all_Photoperiod), color = as.factor(Data_all_WL), fill = as.factor(Data_all_WL)), size = 6, alpha = 1.0) +
    geom_point(aes(x = Data_all_PURPhotonDose_day, y = Data_all_deltaOD_Lmu_corr_day, shape = as.factor(Data_all_Photoperiod), color = as.factor(Data_all_WL), fill = as.factor(Data_all_WL)), size = 2, alpha = 0.8) +
  geom_line(aes(x = Predict_all_PURPhotonDose_day, y = Predict_all_.fitted), size = 1) + 
 # geom_line(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), linetype = as.factor(WL)), size = 0.5) +
 labs(title = "SS120", y = "Chlorophyll Specific Growth Rate " ~  " ("  ~ d^-1~")", x = "PUR (µmol photons" ~m^-2 ~d^-1~")") +
 #geom_text(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr, label= Run),hjust=0.3, vjust=0) +
  # geom_ribbon(aes(x = PURPhotonDose_day, ymin = ReplicateMean_deltaOD_Lmu_corr_day - ReplicateSE_deltaOD_Lmu_corr_day, ymax = ReplicateMean_deltaOD_Lmu_corr_day + ReplicateSE_deltaOD_Lmu_corr_day, fill = as.factor(WL)), alpha = 0.2, color = NA) +
  # geom_errorbar(aes(x = PURPhotonDose_day, ymin = (ReplicateMean_deltaOD_Lmu_corr_day - deltaOD_Lmu_se), ymax = (ReplicateMean_deltaOD_Lmu_corr_day + deltaOD_Lmu_se)), size = 0.3, color = 'black', data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
    # scale_x_continuous(labels=scales::trans_format('log10', scales::math_format(10^.x)),
    #                    # limits = c(10^4, 10^7),
    #                    breaks = c(10^4, 10^5, 10^6)) +
  scale_x_continuous(label=scientific_10) +
      # scale_x_continuous(breaks = c(10^5, 10^6.0, 10^7), limits = c(10^5, 10^7)) +
    # scale_x_continuous(breaks = c(10^4.2, 10^6, 10^6.7), limits = c(10^4.2, 10^6.7)) +
  # coord_cartesian(xlim = c (0, 16)) +
   scale_y_continuous(breaks = c(0,0.2, 0.4, 0.6, 0.8, 1.0), limits = c (0, 1.05)) +
  # coord_cartesian(ylim = c (0, 0.07)) +
  scale_colour_manual(values = MCMIXColours) +
   # scale_x_continuous(values = c(min(PURPARFits$PURPhotonDose_day), max(PURPARFits$PURPhotonDose_day)), breaks = seq) +
   # scale_x_log10(labels=scales::trans_format('log10',scales::math_format(10^.x)), breaks = c(10^4, 10^5, 10^6, 10^7), limits = c(10^4, 10^7)) +
  # scale_y_continuous(limits = c(-0.05,0.050)) +
  scale_linetype_manual(values = c("solid", "twodash", "dotted", "aa")) +
   scale_shape_manual(values = PhotoperiodShapes)  +
  ggh4x::facet_nested(rows = vars(OxygenLabel, O2_uM), 
                    labeller = labeller(Strain = label_both, WL = label_both, O2_uM = label_value, Photoperiod = label_value, PhotoperiodLabel_title = label_value, OxygenLabel = label_value)) +
 guides(linetype = guide_legend(nrow = 4),
        fill = "none",
        colour = guide_legend(nrow = 4)) +
 guides(shape = guide_legend(nrow = 4)) +
  theme_bw() +
   theme( strip.text = element_text(size = 30),
        axis.title = element_text(size = 30, color = "black"),
        axis.text.x = element_text(size = 20, color = "black", angle = 45, hjust = 1.0),
        axis.text.y = element_text(size = 20, color = "black", angle = 0, hjust = 1.0),
        strip.background=element_rect(color="grey87", fill = "grey82"),
        # strip.background=element_rect(fill = "white"),
        legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(1, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width
        legend.title =  element_text(size = 30),  #change legend title font size
        legend.text = element_text(size = 30),   #change legend text font size
        legend.position = "top") +
  labs( shape = "Photoperiod (h)",
        color = "Growth Waveband (nm)",
       linetype = "Photoperiod (h) "
      )

AllFitsCombined |>
   filter(Strain == "MIT9313") |>
  unnest(cols = c(Data_all, Predict_all), names_sep = "_", keep_empty = TRUE) |>
  mutate(PhotoperiodLabel_title = "Photoperiod (h)",
         OxygenLabel = "Oxygen Concentration (µM)",
         Photoperiod = factor(Data_all_Photoperiod, levels = c("16", "12", "8", "4" )),
         O2_uM = factor(O2_uM, levels = c(250, 25, 2.5))) %>%
  ggplot() +
  geom_point(aes(x = Data_all_PURPhotonDose_day, y = Data_all_ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Data_all_Photoperiod), color = as.factor(Data_all_WL), fill = as.factor(Data_all_WL)), size = 6, alpha = 1.0) +
    geom_point(aes(x = Data_all_PURPhotonDose_day, y = Data_all_deltaOD_Lmu_corr_day, shape = as.factor(Data_all_Photoperiod), color = as.factor(Data_all_WL), fill = as.factor(Data_all_WL)), size = 2, alpha = 0.8) +
  geom_line(aes(x = Predict_all_PURPhotonDose_day, y = Predict_all_.fitted), size = 1) + 
 # geom_line(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), linetype = as.factor(WL)), size = 0.5) +
 labs(title = "MIT9313", y = "Chlorophyll Specific Growth Rate " ~  " ("  ~ d^-1~")", x = "PUR (µmol photons" ~m^-2 ~d^-1~")") +
 #geom_text(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr, label= Run),hjust=0.3, vjust=0) +
  # geom_ribbon(aes(x = PURPhotonDose_day, ymin = ReplicateMean_deltaOD_Lmu_corr_day - ReplicateSE_deltaOD_Lmu_corr_day, ymax = ReplicateMean_deltaOD_Lmu_corr_day + ReplicateSE_deltaOD_Lmu_corr_day, fill = as.factor(WL)), alpha = 0.2, color = NA) +
  # geom_errorbar(aes(x = PURPhotonDose_day, ymin = (ReplicateMean_deltaOD_Lmu_corr_day - deltaOD_Lmu_se), ymax = (ReplicateMean_deltaOD_Lmu_corr_day + deltaOD_Lmu_se)), size = 0.3, color = 'black', data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
    # scale_x_continuous(labels=scales::trans_format('log10', scales::math_format(10^.x)),
    #                    # limits = c(10^4, 10^7),
    #                    breaks = c(10^4, 10^5, 10^6)) +
  scale_x_continuous(label=scientific_10) +
      # scale_x_continuous(breaks = c(10^5, 10^6.0, 10^7), limits = c(10^5, 10^7)) +
    # scale_x_continuous(breaks = c(10^4.2, 10^6, 10^6.7), limits = c(10^4.2, 10^6.7)) +
  # coord_cartesian(xlim = c (0, 16)) +
   scale_y_continuous(breaks = c(0,0.2, 0.4, 0.6, 0.8, 1.0), limits = c (0, 1.05)) +
  # coord_cartesian(ylim = c (0, 0.07)) +
  scale_colour_manual(values = MCMIXColours) +
   # scale_x_continuous(values = c(min(PURPARFits$PURPhotonDose_day), max(PURPARFits$PURPhotonDose_day)), breaks = seq) +
   # scale_x_log10(labels=scales::trans_format('log10',scales::math_format(10^.x)), breaks = c(10^4, 10^5, 10^6, 10^7), limits = c(10^4, 10^7)) +
  # scale_y_continuous(limits = c(-0.05,0.050)) +
  scale_linetype_manual(values = c("solid", "twodash", "dotted", "aa")) +
   scale_shape_manual(values = PhotoperiodShapes)  +
  ggh4x::facet_nested(rows = vars(OxygenLabel, O2_uM), 
                    labeller = labeller(Strain = label_both, WL = label_both, O2_uM = label_value, Photoperiod = label_value, PhotoperiodLabel_title = label_value, OxygenLabel = label_value)) +
 guides(linetype = guide_legend(nrow = 4),
        fill = "none",
        colour = guide_legend(nrow = 4)) +
 guides(shape = guide_legend(nrow = 4)) +
  theme_bw() +
   theme( strip.text = element_text(size = 30),
        axis.title = element_text(size = 30, color = "black"),
        axis.text.x = element_text(size = 20, color = "black", angle = 45, hjust = 1.0),
        axis.text.y = element_text(size = 20, color = "black", angle = 0, hjust = 1.0),
        strip.background=element_rect(color="grey87", fill = "grey82"),
        # strip.background=element_rect(fill = "white"),
        legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(1, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width
        legend.title =  element_text(size = 30),  #change legend title font size
        legend.text = element_text(size = 30),   #change legend text font size
        legend.position = "top") +
  labs( shape = "Photoperiod (h)",
        color = "Growth Waveband (nm)",
       linetype = "Photoperiod (h) "
      )

```








#Plot fits on same graph
```{r}

```


# TESTing additions to GGplot objects

```{r PUR per day, fig.height= 20, fig.width= 20 }

scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

TestAddition <- StrainO2filtered_PlattLmModel |>
  unnest(Predict, Data_filtered) |>
   filter(Strain == "MED4") %>%
  mutate(PhotoperiodLabel_title = "Photoperiod (h)",
         OxygenLabel = "Oxygen Concentration (µM)",
         Photoperiod = factor(Photoperiod, levels = c("16", "12", "8", "4" )),
         O2_uM = factor(O2_uM, levels = c(250, 25, 2.5))) %>%
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 6, alpha = 1.0) +
    geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 2, alpha = 0.8) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`, linetype = "solid"), size = 2, color ="blue") + 
 # geom_line(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), linetype = as.factor(WL)), size = 0.5) +
 labs(title = "MED4", y = "Chlorophyll Specific Growth Rate " ~  " ("  ~ d^-1~")", x = "PUR (µmol photons" ~m^-2 ~d^-1~")") +
 #geom_text(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr, label= Run),hjust=0.3, vjust=0) +
  # geom_ribbon(aes(x = PURPhotonDose_day, ymin = ReplicateMean_deltaOD_Lmu_corr_day - ReplicateSE_deltaOD_Lmu_corr_day, ymax = ReplicateMean_deltaOD_Lmu_corr_day + ReplicateSE_deltaOD_Lmu_corr_day, fill = as.factor(WL)), alpha = 0.2, color = NA) +
  # geom_errorbar(aes(x = PURPhotonDose_day, ymin = (ReplicateMean_deltaOD_Lmu_corr_day - deltaOD_Lmu_se), ymax = (ReplicateMean_deltaOD_Lmu_corr_day + deltaOD_Lmu_se)), size = 0.3, color = 'black', data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
    # scale_x_continuous(labels=scales::trans_format('log10', scales::math_format(10^.x)),
    #                    # limits = c(10^4, 10^7),
    #                    breaks = c(10^4, 10^5, 10^6)) +
  scale_x_continuous(label=scientific_10) +
      # scale_x_continuous(breaks = c(10^5, 10^6.0, 10^7), limits = c(10^5, 10^7)) +
    # scale_x_continuous(breaks = c(10^4.2, 10^6, 10^6.7), limits = c(10^4.2, 10^6.7)) +
  # coord_cartesian(xlim = c (0, 16)) +
   scale_y_continuous(breaks = c(0,0.2, 0.4, 0.6, 0.8, 1.0), limits = c (0, 1.05)) +
  # coord_cartesian(ylim = c (0, 0.07)) +
  scale_colour_manual(values = MCMIXColours) +
   # scale_x_continuous(values = c(min(PURPARFits$PURPhotonDose_day), max(PURPARFits$PURPhotonDose_day)), breaks = seq) +
   # scale_x_log10(labels=scales::trans_format('log10',scales::math_format(10^.x)), breaks = c(10^4, 10^5, 10^6, 10^7), limits = c(10^4, 10^7)) +
  # scale_y_continuous(limits = c(-0.05,0.050)) +
  scale_linetype_manual(values = c("solid", "twodash", "dotted", "aa")) +
   scale_shape_manual(values = PhotoperiodShapes)  +
  ggh4x::facet_nested(rows = vars(OxygenLabel, O2_uM), 
                    labeller = labeller(Strain = label_both, WL = label_both, O2_uM = label_value, Photoperiod = label_value, PhotoperiodLabel_title = label_value, OxygenLabel = label_value)) +
 guides(linetype = guide_legend(nrow = 4),
        fill = "none",
        colour = guide_legend(nrow = 4)) +
 guides(shape = guide_legend(nrow = 4)) +
  theme_bw() +
   theme( strip.text = element_text(size = 30),
        axis.title = element_text(size = 30, color = "black"),
        axis.text.x = element_text(size = 20, color = "black", angle = 45, hjust = 1.0),
        axis.text.y = element_text(size = 20, color = "black", angle = 0, hjust = 1.0),
        strip.background=element_rect(color="grey87", fill = "grey82"),
        # strip.background=element_rect(fill = "white"),
        legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(1, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width
        legend.title =  element_text(size = 30),  #change legend title font size
        legend.text = element_text(size = 30),   #change legend text font size
        legend.position = "top") +
  labs( shape = "Photoperiod (h)",
        color = "Growth Waveband (nm)",
       linetype = "Photoperiod (h) "
      )

TestAddition

AddPhotoperiod <- TestAddition %>% 
  

PURPARStrainO2PhotoNestModels |>
  filter(!map_lgl(GRCplatt_Model, is.null)) |>
  unnest(GRCplatt_Predict, data) |>
   filter(Strain == "MED4") %>%
  mutate(PhotoperiodLabel_title = "Photoperiod (h)",
         OxygenLabel = "Oxygen Concentration (µM)",
         Photoperiod = factor(Photoperiod, levels = c("16", "12", "8", "4" ))) %>%
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 6, alpha = 1.0) +
    geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 2, alpha = 0.8) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`, line = as.factor(Photoperiod), linetype = as.factor(Photoperiod)), size = 1) + 
 # geom_line(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), linetype = as.factor(WL)), size = 0.5) +
 labs(title = "MED4", y = "Chlorophyll Specific Growth Rate " ~  " ("  ~ d^-1~")", x = "PUR (µmol photons" ~m^-2 ~d^-1~")") +
 #geom_text(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr, label= Run),hjust=0.3, vjust=0) +
  # geom_ribbon(aes(x = PURPhotonDose_day, ymin = ReplicateMean_deltaOD_Lmu_corr_day - ReplicateSE_deltaOD_Lmu_corr_day, ymax = ReplicateMean_deltaOD_Lmu_corr_day + ReplicateSE_deltaOD_Lmu_corr_day, fill = as.factor(WL)), alpha = 0.2, color = NA) +
  # geom_errorbar(aes(x = PURPhotonDose_day, ymin = (ReplicateMean_deltaOD_Lmu_corr_day - deltaOD_Lmu_se), ymax = (ReplicateMean_deltaOD_Lmu_corr_day + deltaOD_Lmu_se)), size = 0.3, color = 'black', data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
    # scale_x_continuous(labels=scales::trans_format('log10', scales::math_format(10^.x)),
    #                    # limits = c(10^4, 10^7),
    #                    breaks = c(10^4, 10^5, 10^6)) +
  scale_x_continuous(label=scientific_10) +
      # scale_x_continuous(breaks = c(10^5, 10^6.0, 10^7), limits = c(10^5, 10^7)) +
    # scale_x_continuous(breaks = c(10^4.2, 10^6, 10^6.7), limits = c(10^4.2, 10^6.7)) +
  # coord_cartesian(xlim = c (0, 16)) +
   scale_y_continuous(breaks = c(0,0.2, 0.4, 0.6, 0.8, 1.0), limits = c (0, 1.05)) +
  # coord_cartesian(ylim = c (0, 0.07)) +
  scale_colour_manual(values = MCMIXColours) +
   # scale_x_continuous(values = c(min(PURPARFits$PURPhotonDose_day), max(PURPARFits$PURPhotonDose_day)), breaks = seq) +
   # scale_x_log10(labels=scales::trans_format('log10',scales::math_format(10^.x)), breaks = c(10^4, 10^5, 10^6, 10^7), limits = c(10^4, 10^7)) +
  # scale_y_continuous(limits = c(-0.05,0.050)) +
  scale_linetype_manual(values = c("solid", "twodash", "dotted", "aa")) +
   scale_shape_manual(values = PhotoperiodShapes)  +
  ggh4x::facet_nested(rows = vars(OxygenLabel, O2_uM), 
                    labeller = labeller(Strain = label_both, WL = label_both, O2_uM = label_value, Photoperiod = label_value, PhotoperiodLabel_title = label_value, OxygenLabel = label_value)) +
 guides(linetype = guide_legend(nrow = 4),
        fill = "none",
        colour = guide_legend(nrow = 4)) +
 guides(shape = guide_legend(nrow = 4)) +
  theme_bw() +
   theme( strip.text = element_text(size = 30),
        axis.title = element_text(size = 30, color = "black"),
        axis.text.x = element_text(size = 20, color = "black", angle = 45, hjust = 1.0),
        axis.text.y = element_text(size = 20, color = "black", angle = 0, hjust = 1.0),
        strip.background=element_rect(color="grey87", fill = "grey82"),
        # strip.background=element_rect(fill = "white"),
        legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(1, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width
        legend.title =  element_text(size = 30),  #change legend title font size
        legend.text = element_text(size = 30),   #change legend text font size
        legend.position = "top") +
  labs( shape = "Photoperiod (h)",
        color = "Growth Waveband (nm)",
       linetype = "Photoperiod (h) "
      )

PURPARStrainO2PhotoNestModels |>
  filter(!map_lgl(GRCplatt_Model, is.null)) |>
  unnest(GRCplatt_Predict, data) |>
   filter(Strain == "SS120") %>%
  mutate(PhotoperiodLabel_title = "Photoperiod (h)",
         OxygenLabel = "Oxygen Concentration (µM)",
         Photoperiod = factor(Photoperiod, levels = c("16", "12", "8", "4" ))) %>%
  ggplot()+
  geom_point(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 6, alpha = 1.0) +
    geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 2, alpha = 0.8) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`, line = as.factor(Photoperiod), linetype = as.factor(Photoperiod)), size = 1) + 
 # geom_line(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), linetype = as.factor(WL)), size = 0.5) +
 labs(title = "SS120", y = "Chlorophyll Specific Growth Rate " ~  " ("  ~ d^-1~")", x = "PUR (µmol photons" ~m^-2 ~d^-1~")") +
 #geom_text(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr, label= Run),hjust=0.3, vjust=0) +
  # geom_ribbon(aes(x = PURPhotonDose_day, ymin = ReplicateMean_deltaOD_Lmu_corr_day - ReplicateSE_deltaOD_Lmu_corr_day, ymax = ReplicateMean_deltaOD_Lmu_corr_day + ReplicateSE_deltaOD_Lmu_corr_day, fill = as.factor(WL)), alpha = 0.2, color = NA) +
  # geom_errorbar(aes(x = PURPhotonDose_day, ymin = (ReplicateMean_deltaOD_Lmu_corr_day - deltaOD_Lmu_se), ymax = (ReplicateMean_deltaOD_Lmu_corr_day + deltaOD_Lmu_se)), size = 0.3, color = 'black', data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
    # scale_x_continuous(labels=scales::trans_format('log10', scales::math_format(10^.x)),
    #                    # limits = c(10^4, 10^7),
    #                    breaks = c(10^4, 10^5, 10^6)) +
  scale_x_continuous(label=scientific_10) +
      # scale_x_continuous(breaks = c(10^5, 10^6.0, 10^7), limits = c(10^5, 10^7)) +
    # scale_x_continuous(breaks = c(10^4.2, 10^6, 10^6.7), limits = c(10^4.2, 10^6.7)) +
  # coord_cartesian(xlim = c (0, 16)) +
   scale_y_continuous(breaks = c(0,0.2, 0.4, 0.6, 0.8, 1.0), limits = c (0, 1.05)) +
  # coord_cartesian(ylim = c (0, 0.07)) +
  scale_colour_manual(values = MCMIXColours) +
   # scale_x_continuous(values = c(min(PURPARFits$PURPhotonDose_day), max(PURPARFits$PURPhotonDose_day)), breaks = seq) +
   # scale_x_log10(labels=scales::trans_format('log10',scales::math_format(10^.x)), breaks = c(10^4, 10^5, 10^6, 10^7), limits = c(10^4, 10^7)) +
  # scale_y_continuous(limits = c(-0.05,0.050)) +
  scale_linetype_manual(values = c("solid", "twodash", "dotted", "aa")) +
   scale_shape_manual(values = PhotoperiodShapes)  +
  ggh4x::facet_nested(rows = vars(OxygenLabel, O2_uM), 
                    labeller = labeller(Strain = label_both, WL = label_both, O2_uM = label_value, Photoperiod = label_value, PhotoperiodLabel_title = label_value, OxygenLabel = label_value)) +
 guides(linetype = guide_legend(nrow = 4),
        fill = "none",
        colour = guide_legend(nrow = 4)) +
 guides(shape = guide_legend(nrow = 4)) +
  theme_bw() +
   theme( strip.text = element_text(size = 30),
        axis.title = element_text(size = 30, color = "black"),
        axis.text.x = element_text(size = 20, color = "black", angle = 45, hjust = 1.0),
        axis.text.y = element_text(size = 20, color = "black", angle = 0, hjust = 1.0),
        strip.background=element_rect(color="grey87", fill = "grey82"),
        # strip.background=element_rect(fill = "white"),
        legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(1, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width
        legend.title =  element_text(size = 30),  #change legend title font size
        legend.text = element_text(size = 30),   #change legend text font size
        legend.position = "top") +
  labs( shape = "Photoperiod (h)",
        color = "Growth Waveband (nm)",
       linetype = "Photoperiod (h) "
      )

PURPARStrainO2PhotoNestModels |>
  filter(!map_lgl(GRCplatt_Model, is.null)) |>
  unnest(GRCplatt_Predict, data) |>
   filter(Strain == "MIT9313") %>%
  mutate(PhotoperiodLabel_title = "Photoperiod (h)",
         OxygenLabel = "Oxygen Concentration (µM)",
         Photoperiod = factor(Photoperiod, levels = c("16", "12", "8", "4" ))) %>%
  ggplot() +
  geom_point(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 6, alpha = 1.0) +
    geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 2, alpha = 0.8) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`, line = as.factor(Photoperiod), linetype = as.factor(Photoperiod)), size = 1) + 
 # geom_line(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), linetype = as.factor(WL)), size = 0.5) +
 labs(title = "MIT9313", y = "Chlorophyll Specific Growth Rate " ~  " ("  ~ d^-1~")", x = "PUR (µmol photons" ~m^-2 ~d^-1~")") +
 #geom_text(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr, label= Run),hjust=0.3, vjust=0) +
  # geom_ribbon(aes(x = PURPhotonDose_day, ymin = ReplicateMean_deltaOD_Lmu_corr_day - ReplicateSE_deltaOD_Lmu_corr_day, ymax = ReplicateMean_deltaOD_Lmu_corr_day + ReplicateSE_deltaOD_Lmu_corr_day, fill = as.factor(WL)), alpha = 0.2, color = NA) +
  # geom_errorbar(aes(x = PURPhotonDose_day, ymin = (ReplicateMean_deltaOD_Lmu_corr_day - deltaOD_Lmu_se), ymax = (ReplicateMean_deltaOD_Lmu_corr_day + deltaOD_Lmu_se)), size = 0.3, color = 'black', data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
    # scale_x_continuous(labels=scales::trans_format('log10', scales::math_format(10^.x)),
    #                    # limits = c(10^4, 10^7),
    #                    breaks = c(10^4, 10^5, 10^6)) +
  scale_x_continuous(label=scientific_10) +
      # scale_x_continuous(breaks = c(10^5, 10^6.0, 10^7), limits = c(10^5, 10^7)) +
    # scale_x_continuous(breaks = c(10^4.2, 10^6, 10^6.7), limits = c(10^4.2, 10^6.7)) +
  # coord_cartesian(xlim = c (0, 16)) +
   scale_y_continuous(breaks = c(0,0.2, 0.4, 0.6, 0.8, 1.0), limits = c (0, 1.05)) +
  # coord_cartesian(ylim = c (0, 0.07)) +
  scale_colour_manual(values = MCMIXColours) +
   # scale_x_continuous(values = c(min(PURPARFits$PURPhotonDose_day), max(PURPARFits$PURPhotonDose_day)), breaks = seq) +
   # scale_x_log10(labels=scales::trans_format('log10',scales::math_format(10^.x)), breaks = c(10^4, 10^5, 10^6, 10^7), limits = c(10^4, 10^7)) +
  # scale_y_continuous(limits = c(-0.05,0.050)) +
  scale_linetype_manual(values = c("solid", "twodash", "dotted", "aa")) +
   scale_shape_manual(values = PhotoperiodShapes)  +
  ggh4x::facet_nested(rows = vars(OxygenLabel, O2_uM), 
                    labeller = labeller(Strain = label_both, WL = label_both, O2_uM = label_value, Photoperiod = label_value, PhotoperiodLabel_title = label_value, OxygenLabel = label_value)) +
 guides(linetype = guide_legend(nrow = 4),
        fill = "none",
        colour = guide_legend(nrow = 4)) +
 guides(shape = guide_legend(nrow = 4)) +
  theme_bw() +
   theme( strip.text = element_text(size = 30),
        axis.title = element_text(size = 30, color = "black"),
        axis.text.x = element_text(size = 20, color = "black", angle = 45, hjust = 1.0),
        axis.text.y = element_text(size = 20, color = "black", angle = 0, hjust = 1.0),
        strip.background=element_rect(color="grey87", fill = "grey82"),
        # strip.background=element_rect(fill = "white"),
        legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(1, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width
        legend.title =  element_text(size = 30),  #change legend title font size
        legend.text = element_text(size = 30),   #change legend text font size
        legend.position = "top") +
  labs( shape = "Photoperiod (h)",
        color = "Growth Waveband (nm)",
       linetype = "Photoperiod (h) "
      )






```

Would like to add Compact Letter Displays (cld) but do not know how. Some examples:
https://stackoverflow.com/questions/70854552/any-other-options-besides-the-traditional-cld-bar-graph/70863531#70863531
https://stackoverflow.com/questions/72756490/loop-tukey-post-hoc-letters-extraction/73274274#73274274


Need test, other than nesting, to determine if Photoperiod has a significant influence (and interaction) on growth rate?

GrowthRate function of PUR, 
  separate models for Strain & O2_uM, 
  
GrowthRate function of PUR in interaction term with Photoperiod and/or light colour
  separate models for Strain & O2_uM, 
  
  
 

```{r PUR per day best, fig.height= 20, fig.width= 20 }


scientific_10 <- function(x) {   parse(text=gsub("e\\+*", " %*% 10^", scales::scientific_format()(x))) }

MED4PURFITPlot <- PURPARStrainO2PhotoNestModels |>
  # select(-c(data)) |>
  pivot_longer(cols = -c(Strain, O2_uM, Photoperiod, data)) |>  mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5))) |>  drop_na(value) |>
  filter(str_detect(name, pattern = "Model") | str_detect(name, pattern = "Glance") | str_detect(name, pattern = "Param")| str_detect(name, pattern = "Predict")) |>
  separate(col = name , into = c("ModelType", "Output"), sep = "_") |>
  pivot_wider(names_from = Output, values_from = value) |>
  filter(!map_lgl(Model, is.null)) |>
  mutate(AIC = map_dbl(Glance, ~ as.numeric(pluck(.x, "AIC")))) |>
  group_by(Strain, O2_uM, Photoperiod) |>
  filter(AIC == min(AIC)) |>
  ungroup() |>
   # filter(!map_lgl(GRClm_Model, is.null)) |>
  unnest(Predict, data) |>
   filter(Strain == "MED4") %>%
  mutate(PhotoperiodLabel_title = "Photoperiod (h)",
         OxygenLabel = "Oxygen Concentration (µM)",
         Photoperiod = factor(Photoperiod, levels = c("16", "12", "8", "4" ))) %>%
  ggplot() +
   geom_point(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 6, alpha = 1.0, data = . %>% filter(PURPhotonDose_day  != 0)) +
   geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 2, alpha = 0.8, data = . %>% filter(PURPhotonDose_day  != 0)) +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 6, alpha = 0.03, data = . %>% filter(PURPhotonDose_day  == 0)) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`, line = as.factor(Photoperiod), linetype = as.factor(Photoperiod)), size = 1.0) + 
 # geom_line(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), linetype = as.factor(WL)), size = 0.5) +
 labs(y = "Chlorophyll Specific Growth Rate " ~  " ("  ~ d^-1~")", x = "PUR (µmol photons" ~m^-2 ~d^-1~")") +
 #geom_text(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr, label= Run),hjust=0.3, vjust=0) +
  # geom_ribbon(aes(x = PURPhotonDose_day, ymin = ReplicateMean_deltaOD_Lmu_corr_day - ReplicateSE_deltaOD_Lmu_corr_day, ymax = ReplicateMean_deltaOD_Lmu_corr_day + ReplicateSE_deltaOD_Lmu_corr_day, fill = as.factor(WL)), alpha = 0.2, color = NA) +
  # geom_errorbar(aes(x = PURPhotonDose_day, ymin = (ReplicateMean_deltaOD_Lmu_corr_day - deltaOD_Lmu_se), ymax = (ReplicateMean_deltaOD_Lmu_corr_day + deltaOD_Lmu_se)), size = 0.3, color = 'black', data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
    # scale_x_continuous(labels=scales::trans_format('log10', scales::math_format(10^.x)),
    #                    # limits = c(10^4, 10^7),
    #                    breaks = c(10^4, 10^5, 10^6)) +
  scale_x_continuous(label=scientific_10) +
      # scale_x_continuous(breaks = c(10^5, 10^6.0, 10^7), limits = c(10^5, 10^7)) +
    # scale_x_continuous(breaks = c(10^4.2, 10^6, 10^6.7), limits = c(10^4.2, 10^6.7)) +
  # coord_cartesian(xlim = c (0, 16)) +
   scale_y_continuous(breaks = c(0,0.2, 0.4, 0.6, 0.8, 1.0), limits = c (0, 1.05)) +
  # coord_cartesian(ylim = c (0, 0.07)) +
   scale_colour_manual(values = MCMIXColours) +
   # scale_x_continuous(values = c(min(PURPARFits$PURPhotonDose_day), max(PURPARFits$PURPhotonDose_day)), breaks = seq) +
   # scale_x_log10(labels=scales::trans_format('log10',scales::math_format(10^.x)), breaks = c(10^4, 10^5, 10^6, 10^7), limits = c(10^4, 10^7)) +
  # scale_y_continuous(limits = c(-0.05,0.050)) +
  scale_linetype_manual(values = c("solid", "twodash", "dotted", "aa")) +
   scale_shape_manual(values = PhotoperiodShapes)  +
  ggh4x::facet_nested(rows = vars(OxygenLabel, O2_uM), 
                    labeller = labeller(Strain = label_both, WL = label_both, O2_uM = label_value, Photoperiod = label_value, PhotoperiodLabel_title = label_value, OxygenLabel = label_value)) +
 # guides(linetype = guide_legend(nrow = 4),
 #        fill = "none",
 #        colour = guide_legend(nrow = 4)) +
 # guides(shape = guide_legend(nrow = 4)) +
   guides(linetype = "none",
        fill = "none",
        colour = guide_legend(ncol = 4)) +
 guides(shape = guide_legend(nrow = 1)) +
 theme_bw() +
   theme( strip.text = element_text(size = 30),
        axis.title = element_text(size = 30, color = "black"),
        axis.text.x = element_text(size = 20, color = "black", angle = 45, hjust = 1.0),
        axis.text.y = element_text(size = 20, color = "black", angle = 0, hjust = 1.0),
        strip.background=element_rect(color="grey87", fill = "grey82"),
        # strip.background=element_rect(fill = "white"),
        legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(1, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width
        legend.title =  element_text(size = 20),  #change legend title font size
        legend.text = element_text(size = 20),   #change legend text font size
        legend.position = "top") +
  labs(color = "Growth Waveband (nm)",
       shape = "Photoperiod (h)")

MED4PURFITPlot


SS120PURFITPlot <- PURPARStrainO2PhotoNestModels |>
  # select(-c(data)) |>
  pivot_longer(cols = -c(Strain, O2_uM, Photoperiod, data)) |>  mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5))) |>  drop_na(value) |>
  filter(str_detect(name, pattern = "Model") | str_detect(name, pattern = "Glance") | str_detect(name, pattern = "Param")| str_detect(name, pattern = "Predict")) |>
  separate(col = name , into = c("ModelType", "Output"), sep = "_") |>
  pivot_wider(names_from = Output, values_from = value) |>
  filter(!map_lgl(Model, is.null)) |>
  mutate(AIC = map_dbl(Glance, ~ as.numeric(pluck(.x, "AIC")))) |>
  group_by(Strain, O2_uM, Photoperiod) |>
  filter(AIC == min(AIC)) |>
  ungroup() |>
   # filter(!map_lgl(GRClm_Model, is.null)) |>
  unnest(Predict, data) |>
   filter(Strain == "SS120") %>%
  mutate(PhotoperiodLabel_title = "Photoperiod (h)",
         OxygenLabel = "Oxygen Concentration (µM)",
         Photoperiod = factor(Photoperiod, levels = c("16", "12", "8", "4" ))) %>%
   ggplot() +
   geom_point(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 6, alpha = 1.0, data = . %>% filter(PURPhotonDose_day  != 0)) +
   geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 2, alpha = 0.8, data = . %>% filter(PURPhotonDose_day  != 0)) +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 6, alpha = 0.03, data = . %>% filter(PURPhotonDose_day  == 0)) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`, line = as.factor(Photoperiod), linetype = as.factor(Photoperiod)), size = 1.0) + 
 # geom_line(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), linetype = as.factor(WL)), size = 0.5) +
 labs( y = "Chlorophyll Specific Growth Rate " ~  " ("  ~ d^-1~")", x = "PUR (µmol photons" ~m^-2 ~d^-1~")") +
 #geom_text(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr, label= Run),hjust=0.3, vjust=0) +
  # geom_ribbon(aes(x = PURPhotonDose_day, ymin = ReplicateMean_deltaOD_Lmu_corr_day - ReplicateSE_deltaOD_Lmu_corr_day, ymax = ReplicateMean_deltaOD_Lmu_corr_day + ReplicateSE_deltaOD_Lmu_corr_day, fill = as.factor(WL)), alpha = 0.2, color = NA) +
  # geom_errorbar(aes(x = PURPhotonDose_day, ymin = (ReplicateMean_deltaOD_Lmu_corr_day - deltaOD_Lmu_se), ymax = (ReplicateMean_deltaOD_Lmu_corr_day + deltaOD_Lmu_se)), size = 0.3, color = 'black', data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
    # scale_x_continuous(labels=scales::trans_format('log10', scales::math_format(10^.x)),
    #                    # limits = c(10^4, 10^7),
    #                    breaks = c(10^4, 10^5, 10^6)) +
  scale_x_continuous(label=scientific_10) +
      # scale_x_continuous(breaks = c(10^5, 10^6.0, 10^7), limits = c(10^5, 10^7)) +
    # scale_x_continuous(breaks = c(10^4.2, 10^6, 10^6.7), limits = c(10^4.2, 10^6.7)) +
  # coord_cartesian(xlim = c (0, 16)) +
   scale_y_continuous(breaks = c(0,0.2, 0.4, 0.6, 0.8, 1.0), limits = c (0, 1.05)) +
  # coord_cartesian(ylim = c (0, 0.07)) +
   scale_colour_manual(values = MCMIXColours) +
   # scale_x_continuous(values = c(min(PURPARFits$PURPhotonDose_day), max(PURPARFits$PURPhotonDose_day)), breaks = seq) +
   # scale_x_log10(labels=scales::trans_format('log10',scales::math_format(10^.x)), breaks = c(10^4, 10^5, 10^6, 10^7), limits = c(10^4, 10^7)) +
  # scale_y_continuous(limits = c(-0.05,0.050)) +
 scale_linetype_manual(values = c("solid", "twodash", "dotted", "aa")) +
   scale_shape_manual(values = PhotoperiodShapes)  +
  ggh4x::facet_nested(rows = vars(OxygenLabel, O2_uM), 
                    labeller = labeller(Strain = label_both, WL = label_both, O2_uM = label_value, Photoperiod = label_value, PhotoperiodLabel_title = label_value, OxygenLabel = label_value)) +
 # guides(linetype = guide_legend(nrow = 4),
 #        fill = "none",
 #        colour = guide_legend(nrow = 4)) +
 # guides(shape = guide_legend(nrow = 4)) +
   guides(linetype = "none",
        fill = "none",
        colour = guide_legend(ncol = 4)) +
 guides(shape = guide_legend(nrow = 1)) +
 theme_bw() +
   theme( strip.text = element_text(size = 30),
        axis.title = element_text(size = 30, color = "black"),
        axis.text.x = element_text(size = 20, color = "black", angle = 45, hjust = 1.0),
        axis.text.y = element_text(size = 20, color = "black", angle = 0, hjust = 1.0),
        strip.background=element_rect(color="grey87", fill = "grey82"),
        # strip.background=element_rect(fill = "white"),
        legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(1, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width
        legend.title =  element_text(size = 20),  #change legend title font size
        legend.text = element_text(size = 20),   #change legend text font size
        legend.position = "top") +
  labs(color = "Growth Waveband (nm)",
       shape = "Photoperiod (h)")

SS120PURFITPlot


MIT9313PURFITPlot <- PURPARStrainO2PhotoNestModels |>
  # select(-c(data)) |>
  pivot_longer(cols = -c(Strain, O2_uM, Photoperiod, data)) |>
  mutate(O2_uM = factor(O2_uM, levels = c(250, 25, 2.5))) |>  drop_na(value) |>
  filter(str_detect(name, pattern = "Model") | str_detect(name, pattern = "Glance") | str_detect(name, pattern = "Param")| str_detect(name, pattern = "Predict")) |>
  separate(col = name , into = c("ModelType", "Output"), sep = "_") |>
  pivot_wider(names_from = Output, values_from = value) |>
  filter(!map_lgl(Model, is.null)) |>
  mutate(AIC = map_dbl(Glance, ~ as.numeric(pluck(.x, "AIC")))) |>
  group_by(Strain, O2_uM, Photoperiod) |>
  filter(AIC == min(AIC)) |>
  ungroup() |>
   # filter(!map_lgl(GRClm_Model, is.null)) |>
  unnest(Predict, data) |>
   filter(Strain == "MIT9313") %>%
  mutate(PhotoperiodLabel_title = "Photoperiod (h)",
         OxygenLabel = "Oxygen Concentration (µM)",
         Photoperiod = factor(Photoperiod, levels = c("16", "12", "8", "4" ))) %>%
  ggplot() +
   geom_point(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 6, alpha = 1.0, data = . %>% filter(PURPhotonDose_day  != 0)) +
   geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 2, alpha = 0.8, data = . %>% filter(PURPhotonDose_day  != 0)) +
  geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 6, alpha = 0.03, data = . %>% filter(PURPhotonDose_day  == 0)) +
  geom_line(aes(x = PURPhotonDose_day, y = `.fitted`, line = as.factor(Photoperiod), linetype = as.factor(Photoperiod)), size = 1.0) + 
 # geom_line(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), linetype = as.factor(WL)), size = 0.5) +
 labs(y = "Chlorophyll Specific Growth Rate " ~  " ("  ~ d^-1~")", x = "PUR (µmol photons" ~m^-2 ~d^-1~")") +
 #geom_text(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr, label= Run),hjust=0.3, vjust=0) +
  # geom_ribbon(aes(x = PURPhotonDose_day, ymin = ReplicateMean_deltaOD_Lmu_corr_day - ReplicateSE_deltaOD_Lmu_corr_day, ymax = ReplicateMean_deltaOD_Lmu_corr_day + ReplicateSE_deltaOD_Lmu_corr_day, fill = as.factor(WL)), alpha = 0.2, color = NA) +
  # geom_errorbar(aes(x = PURPhotonDose_day, ymin = (ReplicateMean_deltaOD_Lmu_corr_day - deltaOD_Lmu_se), ymax = (ReplicateMean_deltaOD_Lmu_corr_day + deltaOD_Lmu_se)), size = 0.3, color = 'black', data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
    # scale_x_continuous(labels=scales::trans_format('log10', scales::math_format(10^.x)),
    #                    # limits = c(10^4, 10^7),
    #                    breaks = c(10^4, 10^5, 10^6)) +
  scale_x_continuous(label=scientific_10) +
      # scale_x_continuous(breaks = c(10^5, 10^6.0, 10^7), limits = c(10^5, 10^7)) +
    # scale_x_continuous(breaks = c(10^4.2, 10^6, 10^6.7), limits = c(10^4.2, 10^6.7)) +
  # coord_cartesian(xlim = c (0, 16)) +
   scale_y_continuous(breaks = c(0,0.2, 0.4, 0.6, 0.8, 1.0), limits = c (0, 1.05)) +
  # coord_cartesian(ylim = c (0, 0.07)) +
    scale_colour_manual(values = MCMIXColours) +
   # scale_x_continuous(values = c(min(PURPARFits$PURPhotonDose_day), max(PURPARFits$PURPhotonDose_day)), breaks = seq) +
   # scale_x_log10(labels=scales::trans_format('log10',scales::math_format(10^.x)), breaks = c(10^4, 10^5, 10^6, 10^7), limits = c(10^4, 10^7)) +
  # scale_y_continuous(limits = c(-0.05,0.050)) +
  scale_linetype_manual(values = c("solid", "twodash", "dotted", "aa")) +
   scale_shape_manual(values = PhotoperiodShapes)  +
  ggh4x::facet_nested(rows = vars(OxygenLabel, O2_uM), 
                    labeller = labeller(Strain = label_both, WL = label_both, O2_uM = label_value, Photoperiod = label_value, PhotoperiodLabel_title = label_value, OxygenLabel = label_value)) +
 # guides(linetype = guide_legend(nrow = 4),
 #        fill = "none",
 #        colour = guide_legend(nrow = 4)) +
 # guides(shape = guide_legend(nrow = 4)) +
   guides(linetype = "none",
        fill = "none",
        colour = guide_legend(ncol = 4)) +
 guides(shape = guide_legend(nrow = 1)) +
 theme_bw() +
   theme( strip.text = element_text(size = 30),
        axis.title = element_text(size = 30, color = "black"),
        axis.text.x = element_text(size = 20, color = "black", angle = 45, hjust = 1.0),
        axis.text.y = element_text(size = 20, color = "black", angle = 0, hjust = 1.0),
        strip.background=element_rect(color="grey87", fill = "grey82"),
        # strip.background=element_rect(fill = "white"),
        legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(1, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width
        legend.title =  element_text(size = 20),  #change legend title font size
        legend.text = element_text(size = 20),   #change legend text font size
        legend.position = "top") +
  labs(color = "Growth Waveband (nm)",
       shape = "Photoperiod (h)")



MIT9313PURFITPlot
 
  
```



```{r, save PURFitPlots}


ggsave(file = file.path(PlotsPath, paste("MED4PURFITPlot",".png",sep = "")), plot = MED4PURFITPlot, device = NULL, scale = 1, height=25, width= 40, units = c("cm"),dpi = 300, limitsize = TRUE)

ggsave(file = file.path(PlotsPath, paste("SS120PURFITPlot",".png",sep = "")), plot = SS120PURFITPlot, device = NULL, scale = 1, height=25, width= 40, units = c("cm"),dpi = 300, limitsize = TRUE)

ggsave(file = file.path(PlotsPath, paste("MIT9313PURFITPlot",".png",sep = "")), plot = MIT9313PURFITPlot, device = NULL, scale = 1, height=25, width= 40, units = c("cm"),dpi = 300, limitsize = TRUE)


```

``` {r}
# PURPARStrainO2PeriodWLNest |>
#   filter(!map_lgl(GRCplatt_Model, is.null)) |>
#   unnest(GRCplatt_Predict, data) |>
#    filter(Strain == "MIT9313") %>%
#   mutate(PhotoperiodLabel_title = "Photoperiod (h)",
#          OxygenLabel = "Oxygen Concentration (µM)",
#          Photoperiod = factor(Photoperiod, levels = c("16", "12", "8", "4" ))) %>%
#   ggplot() +
#   geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 6, alpha = 1.0) +
#     geom_point(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), color = as.factor(WL), fill = as.factor(WL)), size = 1, alpha = 0.8) +
#   geom_line(aes(x = PURPhotonDose_day, y = `.fitted`, line = as.factor(WL), color = as.factor(WL))) + 
#  # geom_line(aes(x = PURPhotonDose_day, y = ReplicateMean_deltaOD_Lmu_corr_day, shape = as.factor(Photoperiod), linetype = as.factor(WL)), size = 0.5) +
#  labs( y = "Chlorophyll Specific Growth Rate " ~  " ("  ~ d^-1~")", x = "PUR (µmol photons" ~m^-2 ~d^-1~")") +
#  #geom_text(aes(x = PURPhotonDose_day, y = deltaOD_Lmu_corr, label= Run),hjust=0.3, vjust=0) +
#   # geom_ribbon(aes(x = PURPhotonDose_day, ymin = ReplicateMean_deltaOD_Lmu_corr_day - ReplicateSE_deltaOD_Lmu_corr_day, ymax = ReplicateMean_deltaOD_Lmu_corr_day + ReplicateSE_deltaOD_Lmu_corr_day, fill = as.factor(WL)), alpha = 0.2, color = NA) +
#   # geom_errorbar(aes(x = PURPhotonDose_day, ymin = (ReplicateMean_deltaOD_Lmu_corr_day - deltaOD_Lmu_se), ymax = (ReplicateMean_deltaOD_Lmu_corr_day + deltaOD_Lmu_se)), size = 0.3, color = 'black', data = . %>% filter(GrowthAmpdeltaODFlag_14days  == 1)) +
#     # scale_x_continuous(labels=scales::trans_format('log10', scales::math_format(10^.x)),
#     #                    # limits = c(10^4, 10^7),
#     #                    breaks = c(10^4, 10^5, 10^6)) +
# 
#       # scale_x_continuous(breaks = c(10^5, 10^6.0, 10^7), limits = c(10^5, 10^7)) +
#     # scale_x_continuous(breaks = c(10^4.2, 10^6, 10^6.7), limits = c(10^4.2, 10^6.7)) +
#   # coord_cartesian(xlim = c (0, 16)) +
#    scale_y_continuous(breaks = c(0,0.2, 0.4, 0.6, 0.8, 1.0), limits = c (0, 1.05)) +
#   # coord_cartesian(ylim = c (0, 0.07)) +
#   scale_colour_manual(values = MCMIXColours, labels = c("White LED", "660","530", "450" )) +
#    # scale_x_continuous(values = c(min(PURPARFits$PURPhotonDose_day), max(PURPARFits$PURPhotonDose_day)), breaks = seq) +
#    # scale_x_log10(labels=scales::trans_format('log10',scales::math_format(10^.x)), breaks = c(10^4, 10^5, 10^6, 10^7), limits = c(10^4, 10^7)) +
#   # scale_y_continuous(limits = c(-0.05,0.050)) +
#    scale_shape_manual(values = PhotoperiodShapes)  +
#   ggh4x::facet_nested(rows = vars(OxygenLabel, O2_uM, Photoperiod), 
#                     labeller = labeller(Strain = label_both, WL = label_both, O2_uM = label_value, Photoperiod = label_value, PhotoperiodLabel_title = label_value, OxygenLabel = label_value)) +
#  guides(linetype = "none",
#         fill = "none",
#         colour = guide_legend(ncol = 4)) +
#  guides(shape = guide_legend(nrow = 1)) +
#   theme_bw() +
#    theme( strip.text = element_text(size = 30),
#         axis.title = element_text(size = 30, color = "black"),
#         axis.text.x = element_text(size = 20, color = "black", angle = 45, hjust = 1.0),
#         axis.text.y = element_text(size = 20, color = "black", angle = 0, hjust = 1.0),
#         strip.background=element_rect(color="grey87", fill = "grey82"),
#         # strip.background=element_rect(fill = "white"),
#         legend.key.size = unit(1, 'cm'), #change legend key size
#         legend.key.height = unit(1, 'cm'), #change legend key height
#         legend.key.width = unit(0.5, 'cm'), #change legend key width
#         legend.title =  element_text(size = 20),  #change legend title font size
#         legend.text = element_text(size = 20),   #change legend text font size
#         legend.position = "top") +
#   labs(color = "Growth Waveband (nm)",
#        shape = "Photoperiod (h)")


```
  
  