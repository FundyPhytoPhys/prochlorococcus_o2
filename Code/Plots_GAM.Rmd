---
title: "Plots_GAM"
author:
- Max Berthold
- Mireille Savoie
output:
bookdown::html_document2:
    code_folding: show
    keep_md: yes
    toc: TRUE
    toc_float: TRUE
    toc_depth: 6
    fig_caption: yes
bibliography: [Manuscript_O2, RPackages.bib]
csl: plos-one.csl
editor_options: 
  markdown: 
    wrap: 72
---

# Introduction
This .Rmd produces a Generalized Additive Model (GAM) to examine the relationship between the chlorophyll proxy (ΔOD) growth rate across the blue and red spectral wavebands, photoperiod and PAR levels for each P.marinus ecotype in this study. The GAM function from the R package mgcv (Wood, 2022) was used to model the growth rate with smoothing terms to indicate the 90, 50 and 10% quantiles. "PICO_Merged_GrowthFitsPURPAR.Rds" is called in from \Data\CleanData folder and generated GAM plots are saved in \Output\Figures folder as .png.


# Set variables for project
```{r project data}

GamFit <- "PICO_Merged_GrowthFitsPURPAR.Rds"

#"..", takes up a level in the directory path
DataIn <- file.path("..","Data", "CleanData")
DataOut <- file.path("..","Data", "CleanData")
PlotsIn <- file.path("..","Output", "Figures")
PlotsOut <- file.path("..","Output", "Figures")
PlotsOutPLOS <- file.path("..", "OutPut", "PLOSFiguresRound1")


is_all_numeric <- function(x) { 
  !any(is.na(suppressWarnings(as.numeric(na.omit(x))))) & is.character(x) 
}
#https://stackoverflow.com/questions/22772279/converting-multiple-columns-from-character-to-numeric-format-in-r

```



```{r load libraries, message=FALSE}
library(tidyverse)
library(lubridate)
library(broom)
library(knitr)
library(minpack.lm)
library(nlstools)
library(nlsMicrobio)
library(plotly)
library(mgcv)
library(tidymv)
library(CCA)
library(vegan)
library(glue)
library(gtable)
library(car)
library(MASS) # estimating linear models through generalized least squares (GLS), fitting negative binomial linear models, the robust fitting of linear models, and Kruskal's non-metric multidimensional scaling.
library(faraway) # LM package
library(grid)
library(gridExtra)
library(ggh4x)
library(ggspectra) 
library(photobiologyWavebands) 
# library(photobiology)
library(metR)
library(Rcpp) #'Rcpp' package provides R functions as well as C++ classes which offer a seamless integration of R and C++.
library(patchwork)

```

```{r, set colors for wavelength}

MyWavelengths = c("WW", 660, 450)

MCMIXColours = c("black", "brown", "steelblue")

names(MCMIXColours) <- MyWavelengths
MCMIXColours

```


# Read data and select relevant columns
```{r read data and select relevant columns}

GrowthFits <- readRDS(file = file.path(DataIn, GamFit))  

GAMGrowthFits <- GrowthFits %>% 
 dplyr::select(c(Filename, PrimaryOperator, Tube, SampleID, Run, Photoperiod, Strain, WL, O2_Category, O2_uM, LightShape, Pur_ue, Par_ue, PURPhotonDose_day, PARPhotonDose_day, OD720_Lmu_corr, OD720_Lmax, OD720_Lintercept, OD720_Lmu_se, OD720_Lmax_se, OD720_Lintercept_se, deltaOD_Lmu_corr, deltaOD_Lmax, deltaOD_Lintercept,  deltaOD_Lmu_se, deltaOD_Lmax_se, deltaOD_Lintercept_se))

```

# make df longer for GAM
```{r set up df for GAM}
 Pivot_Longer_OD720_est <- GAMGrowthFits %>% 
  dplyr::select(-c(OD720_Lmu_se, OD720_Lmax_se, OD720_Lintercept_se, deltaOD_Lmu_corr, deltaOD_Lmax, deltaOD_Lintercept,  deltaOD_Lmu_se, deltaOD_Lmax_se, deltaOD_Lintercept_se)) %>%
   pivot_longer(c(OD720_Lmu_corr, OD720_Lmax, OD720_Lintercept), names_to = c("Wavelength", "term"), values_to = c("estimate"), names_sep = '\\_') 


# OD720 pivot longer  Lmu, Lmax and Lintercept standard error
Pivot_Longer_OD720_se <- GAMGrowthFits %>%
  dplyr::select(-c(OD720_Lmu_corr, OD720_Lmax, OD720_Lintercept, deltaOD_Lmu_corr, deltaOD_Lmax, deltaOD_Lintercept, deltaOD_Lmu_se, deltaOD_Lmax_se, deltaOD_Lintercept_se)) %>%
   pivot_longer(c(OD720_Lmu_se, OD720_Lmax_se, OD720_Lintercept_se), names_to = c("Wavelength", "term"), values_to = c("se"), names_sep = '\\_') 

# Join OD720 estimate and se DF 
Longer_OD720_Joined <- full_join(Pivot_Longer_OD720_est, Pivot_Longer_OD720_se)

remove(Pivot_Longer_OD720_est, Pivot_Longer_OD720_se)

# deltaOD pivot longer Lmu, Lmax and Lintercept estimates
Pivot_Longer_deltaOD_est <- GAMGrowthFits %>%
  dplyr::select(-c(OD720_Lmu_corr, OD720_Lmax, OD720_Lintercept, OD720_Lmu_se, OD720_Lmax_se, OD720_Lintercept_se,  deltaOD_Lmu_se, deltaOD_Lmax_se, deltaOD_Lintercept_se)) %>%
   pivot_longer(c(deltaOD_Lmu_corr, deltaOD_Lmax, deltaOD_Lintercept), names_to = c("Wavelength", "term"), values_to = c("estimate"), names_sep = '\\_') 

# deltaOD pivot longer Lmu, Lmax and Lintercept standard error
Pivot_Longer_deltaOD_se <- GAMGrowthFits %>%
  dplyr::select(-c(OD720_Lmu_corr, OD720_Lmax, OD720_Lintercept, OD720_Lmu_se, OD720_Lmax_se, OD720_Lintercept_se, deltaOD_Lmu_corr, deltaOD_Lmax, deltaOD_Lintercept)) %>%
   pivot_longer(c(deltaOD_Lmu_se, deltaOD_Lmax_se, deltaOD_Lintercept_se), names_to = c("Wavelength", "term"), values_to = c("se"), names_sep = '\\_') 

# Join deltaOD estimate and se DF 
Longer_deltaOD_Joined <- full_join(Pivot_Longer_deltaOD_est, Pivot_Longer_deltaOD_se)

remove(Pivot_Longer_deltaOD_est, Pivot_Longer_deltaOD_se, GAMGrowthFits)



#Join OD720 and deltaOD fits data
PicoGrowthFits <- rbind(Longer_OD720_Joined, Longer_deltaOD_Joined) %>%
  mutate_if(is.numeric, round, digits = 3) %>% 
  filter(Strain %in% c("MED4", "SS120", "MIT9313"),
         WL %in% c(450, 660, "WW"))

remove(Longer_OD720_Joined, Longer_deltaOD_Joined)
  
glimpse(PicoGrowthFits)

```

```{r DF preparation Prochloroccus}
GamWL = "deltaOD"
GamVar = "450"
GAMParaMod = "Lmu" # Stands for growth estimates determined by logistic model

PicoLmuAb <- PicoGrowthFits %>%
  filter(term %in% GAMParaMod) %>%
  filter(Wavelength %in% GamWL) %>%
  filter(WL %in% GamVar) %>%
  mutate(Strain = as.factor(Strain))

PicoLogGamAb <-  gam(estimate ~ s(Par_ue,  by = Strain, k = 3) + s(Photoperiod,  by = Strain, k = 3) + ti(Photoperiod, Par_ue, by = Strain, k = 3), data = PicoLmuAb, method = "REML")
summary(PicoLogGamAb)


PicoLogPar <- gam(estimate ~ s(Par_ue,  by = Strain, k = 3), data = PicoLmuAb, method = "REML")

PicoLogPhotPer <- gam(estimate ~ s(Photoperiod,  by = Strain, k = 3), data = PicoLmuAb, method = "REML")


AIC(PicoLogPar, PicoLogPhotPer, PicoLogGamAb)

ModelResid <- resid(PicoLogGamAb)
gam.check(PicoLogGamAb)
concurvity(PicoLogGamAb)
plot(PicoLogGamAb, residuals = TRUE, pch = 1, all.terms = TRUE)


#AIC of Gompertz-fitted model comparably low as to only-par and only-light model. 
#Next step, fitting Strain-specific models. 
#MED4 model to Par_ue-response falsely fits, due to badly fitted µ-rates -> cultures died, but model tried to fit anyway. Maybe filter everything below a certain R^2 in the fit? 

```

# Generate GAM for red light conditions for all strains using chlorophyll proxy logistic growth rate. 
```{r GAM separate niches hypervolume for red light}
GamWL = c("deltaOD") #deltaOD or OD720
GamParaMod = "Lmu" # logistic model growth estimates
GamVar = "660" # growth spectral wavelength
ErrorTolGrowth = 30 # the amplitude tolerance of the standard error of the fitted growth estimates
ErrorTol = 30 # the amplitude tolerance of the standard error of the fitted GAM

#https://stackoverflow.com/questions/49570452/is-it-possible-to-specify-lower-bound-in-response-variable-during-smooth-with-ga 
possibGAM = possibly(.f = mgcv::gam, otherwise = NULL)
possibPRED = possibly(.f = mgcv::predict.gam, otherwise = NULL)

PAR_Photoperiod_Model_predi <- expand_grid(
  Par_ue = seq(from=min(10), 
              to=max(200), 
              length.out = 100),
  Photoperiod = seq(from=min(2), 
              to=max(18), 
              length.out = 100)
)

PicoGAM <- PicoGrowthFits %>%
  ungroup() %>%
  dplyr::mutate(Lmu_seFlag = case_when(se/estimate*100 < ErrorTolGrowth ~ 1, # flag to include data where Standarderror smaller than +/- Errortolerance
                         FALSE ~ 0)) %>%
  dplyr::filter(
                estimate == 0 |
                estimate != 0 & Lmu_seFlag == 1, # include no growths and growths that meet se tolerance. 
                term %in% GamParaMod, 
                Wavelength %in% GamWL
                ) %>%
  mutate(estimate = estimate*24, # to convert growth from per hour to per day
         se = se*24) %>% # to convert standard error from per hour to per day
  group_by(Strain, Wavelength, WL, O2_uM) %>%
  nest() %>%
  dplyr::arrange(Strain, Wavelength, WL, O2_uM) %>%
  mutate(GamModel = map(data, ~possibGAM(estimate ~ s(Par_ue, k = 3) + s(Photoperiod, k = 3) + ti(Photoperiod, Par_ue, k = 3),  data = .x,
                                    family = "gaussian"(link = "log"), 
                                    method = "REML")),
         predicted = map(GamModel, ~possibPRED(.x, newdata = PAR_Photoperiod_Model_predi, type = 'response', se.fit=TRUE)),
         augmented = map(GamModel, ~augment(.x))
         )

PicoGAM_Pred <- PicoGAM %>%
  dplyr::select(Strain, Wavelength, WL, O2_uM, predicted) %>%
  dplyr::filter(predicted != "NULL") %>%
  rowwise() %>%
  mutate(db = list(cbind(predicted, PAR_Photoperiod_Model_predi))) %>%
  dplyr::select(-predicted) %>%
  unnest(col = db) %>%
  group_by(Strain, Wavelength, WL, O2_uM) %>%
  dplyr::filter(fit < 1.2) %>% # with two exceptions, growth rates were never higher than 1.2; GAM model creates some unrealistic high growth rates due to low data availability
  mutate(
    IsFitGood = case_when(se.fit/fit*100 < ErrorTol ~ 1, # flags faulty data where Standarderror larger +/- Errortolerance
                         se.fit/fit*100 > ErrorTol ~ 0
                    )
  ) %>% 
  dplyr::filter(IsFitGood == 1) 

```

# Generate GAM for blue light conditions for all strains using chlorophyll proxy logistic growth rate. 
```{r GAM separate niches hypervolume for blue light}
GamWL = c("deltaOD") #deltaOD or OD720
GamParaMod = "Lmu" # logistic model growth estimates
GamVar = "450" # growth spectral wavelength
ErrorTolGrowth = 30 # the amplitude tolerance of the standard error of the fitted growth estimates
ErrorTol = 30 # defined for the GAM fit

#https://stackoverflow.com/questions/49570452/is-it-possible-to-specify-lower-bound-in-response-variable-during-smooth-with-ga 
possibGAM = possibly(.f = mgcv::gam, otherwise = NULL)
possibPRED = possibly(.f = mgcv::predict.gam, otherwise = NULL)

PAR_Photoperiod_Model_predi <- expand_grid(
  Par_ue = seq(from=min(10), 
              to=max(200), 
              length.out = 100),
  Photoperiod = seq(from=min(2), 
              to=max(18), 
              length.out = 100)
)

PicoGAM <- PicoGrowthFits %>%
  ungroup() %>%
  dplyr::mutate(Lmu_seFlag = case_when(se/estimate*100 < ErrorTolGrowth ~ 1, #filters faulty data where Standarderror larger +/- Errortolerance
                         FALSE ~ 0)) %>%
  dplyr::filter(
                estimate == 0 |
                estimate != 0 & Lmu_seFlag == 1,
                term %in% GamParaMod, 
                Wavelength %in% GamWL
                ) %>%
  mutate(estimate = estimate*24, #to convert growth from per hour to per day
         se = se*24) %>%
  group_by(Strain, Wavelength, WL, O2_uM) %>%
  nest() %>%
  dplyr::arrange(Strain, Wavelength, WL, O2_uM) %>%
  mutate(GamModel = map(data, ~possibGAM(estimate ~ s(Par_ue, k = 3) + s(Photoperiod, k = 3) + ti(Photoperiod, Par_ue, k = 3),  data = .x,
                                    family = "gaussian"(link = "log"), 
                                    method = "REML")),
         predicted = map(GamModel, ~possibPRED(.x, newdata = PAR_Photoperiod_Model_predi, type = 'response', se.fit=TRUE)),
         augmented = map(GamModel, ~augment(.x))
         )

PicoGAM_Pred <- PicoGAM %>%
  dplyr::select(Strain, Wavelength, WL, O2_uM, predicted) %>%
  dplyr::filter(predicted != "NULL") %>%
  rowwise() %>%
  mutate(db = list(cbind(predicted, PAR_Photoperiod_Model_predi))) %>%
  dplyr::select(-predicted) %>%
  unnest(col = db) %>%
  group_by(Strain, Wavelength, WL, O2_uM) %>%
  dplyr::filter(fit < 1.2) %>% #with two exceptions, growth rates were never higher than 1.2; GAM model creates some unrealistic high growth rates due to low data availability
  mutate(
    IsFitGood = case_when(se.fit/fit*100 < ErrorTol ~ 1, # flags faulty data where Standarderror larger +/- Errortolerance
                         se.fit/fit*100 > ErrorTol ~ 0
                    )
  ) %>% 
  dplyr::filter(IsFitGood == 1) 

```


```{r, MED4PAR, fig.height=10, fig.width=10}
  
data_text <- data.frame( ParLabel=c("PAR~(µmol~photons~m^{-2}~s^{-1})"), OxygenLabel = c("Oxygen~concentration~(µM)"),Par_ue = c("30"), O2_uM = c("250"), label = c('A'))

MED4PAR <- GrowthFits %>%
   filter(Strain == "MED4",
           Par_ue %in% c(30,90,180),
          WL %in% c("WW", 450, 660),
          deltaOD_Lmu_corr == 0 |
          deltaOD_Lmu_corr != 0 & deltaOD_LseGrowthFlag == 1) %>%
  mutate(PhotoperiodLabelTitle = "Photoperiod~(h)",
         OxygenLabel = "Oxygen~concentration~(µM)",
         WLlabelTitle = "Growth~wavelength~(nm)",
         ParLabel = "PAR~(µmol~photons~m^{-2}~s^{-1})",
         WL = factor(WL, levels = c("WW", 660, 530, 450)),
         deltaOD_Lmu_corr_day = deltaOD_Lmu_corr * 24,
         deltaOD_Lmu_se_day = deltaOD_Lmu_se * 24) %>% 
  ggplot()  +
    geom_point(aes(x = Photoperiod, y = (deltaOD_Lmu_corr_day), colour = as.factor(WL)), size = 2.5, alpha = 0.75, show.legend = F) +
   geom_line(aes(x = Photoperiod, y = ReplicateMean_deltaOD_Lmu_corr_day, colour = as.factor(WL), linetype = as.factor(WL)), size = 0.5, show.legend = F) +
    geom_point(aes(x = Photoperiod, y = ReplicateMean_deltaOD_Lmu_corr_day, colour = as.factor(WL)), size = 5, alpha = 1) +
    geom_text(data=data_text, aes(x=5.5, y=0.8, label=label), size=7) +
 labs( y = "Chlorophyll specific growth rate " ~  " ("  ~ d^-1~")", x = "Photoperiod (h)") +
   geom_jitter(aes(x = Photoperiod, y = ReplicateMean_deltaOD_Lmu_corr_day, colour = as.factor(WL)), width = 0.1, size = 3, show.legend = F) +
  scale_y_continuous(breaks = c(0,0.25,  0.5, 0.75, 1.0), limits = c (0, 1.05)) +
  scale_colour_manual(values = MCMIXColours, labels = c("White LED", "660", "450" )) +
   scale_x_continuous(breaks = c(4,8, 12, 16), limits = c (4, 16)) +
  ggh4x::facet_nested(cols = vars(ParLabel, factor(Par_ue, levels = c("30", "90","180"))), rows = vars(OxygenLabel, factor(O2_uM, levels= c("250", "25","2.5"))), 
                    labeller = label_parsed) + 
 guides(linetype = "none") +
   theme_bw() +
   theme( panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
     axis.title.x.bottom = element_text(size = 16, color = "black", vjust = 1.0),
      axis.title.y = element_text(size = 16, color = "black", vjust = 1.0),
       axis.title.x.top = element_text(size = 16, color = "black", vjust = 1.0),
       axis.text.x = element_text(size = 12, color = "black", angle = 0, hjust = 0.5, vjust = 1),
        axis.text.y = element_text(size = 12, color = "black", angle = 0, hjust = 1.0),
       axis.text.x.top = element_blank(),
       axis.ticks.x.top = element_blank(),
       strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(1, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width
        # legend.title = element_text(size = 15),  #change legend title font size for right side legend placement
        # legend.text = element_text(size = 15),   #change legend text font size for right side legend placement
        legend.title = element_text(size = 16),  #change legend title font size
        legend.text = element_text(size = 12),   #change legend text font size
        legend.position = "top") +
  labs(color = "Growth wavelength (nm)",
       fill = "Growth wavelength (nm)")
MED4PAR

```


``` {r MED4GAM Plot Blue WL 250, fig.height=5, fig.width=5}
GamStrain = "MED4" 
GamColor = "Blue"
WL_nm = 450 
PlotWL <- "deltaOD"
data_text <- data.frame(label = c('450 nm, 250 µM'))

maxMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.max(fit)) #base::max does not work with package photobiology loaded simultaneously 
maxMu <- maxMu$fit

minMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.min(fit)) #base::max does not work with package photobiology loaded simultaneously 
minMu <- minMu$fit

PicoGAM_Plot_Prep <- PicoGAM_Pred %>%
  filter(Wavelength %in% PlotWL,
         Strain %in% GamStrain,
         WL %in% WL_nm) %>%
  mutate(
         Color_name = case_when(WL == "450" ~ 'Blue',
                                WL == "530" ~ 'Green',
                                WL == "660" ~ 'Red',
                                WL == "WW" ~ 'White'))

WL_O2_Colors = c(Blue = w_length2rgb(450), green = w_length2rgb(530), red = w_length2rgb(660), white= "#FFCC00")

ColourDF <- data.frame(
  ColorName = c('Blue', 'Green', 'Red', 'White'),
  WL_O2_Colors = c( w_length2rgb(450), w_length2rgb(530), w_length2rgb(660), "#FFCC00")
) %>%
  filter(ColorName %in% GamColor) %>%
  dplyr::select(WL_O2_Colors)


ContourBreaks <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL
  ) %>%
  group_by(O2_uM) %>%
  mutate(upper10 = quantile(fit, 0.9, na.rm = TRUE),
         median50 = quantile(fit, 0.5, na.rm = TRUE),
         lower10 = quantile(fit, 0.1, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::select(O2_uM, upper10, median50, lower10) %>%
  distinct() %>%
  pivot_longer(cols = c(upper10, median50, lower10), names_to = 'quantile', values_to = 'quantileValue') %>%
  mutate(quantileValue = round(quantileValue, digits = 2))


HyperChlPlot <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL,
         O2_uM == "250"
  )
ContourLines <- ContourBreaks %>%
  filter(O2_uM == "250") 
ContourLines <- ContourLines$quantileValue 

(ContourMED4BlueHigh <- ggplot(na.omit(HyperChlPlot)) + 
    geom_tile(aes(Photoperiod, Par_ue, z = fit, fill = fit), show.legend = F) +
    scale_fill_gradientn(name = bquote("µ ("~ d^-1~")"), colours=c(low = "white", intermediate = "steelblue1", high = "royalblue4"), limits  = range(minMu, 1.0), na.value = "white") +
    metR::geom_contour2(aes(Photoperiod, Par_ue, z = fit, fill = fit, label = stat(level)),
                        breaks = ContourLines,
                        skip = 0) +
    scale_x_continuous(limits = c(4, 16), breaks = c(4, 8, 12, 16)) +
    scale_y_continuous(limits = c(10, 205)) +
    geom_text(data=data_text, aes(x=10, y=205, label=label), size=4) +
    xlab("Photoperiod (h)") +
      ylab("PAR (µmol photons"~ m^-2~ ~s^-1~ ")")+ #https://stackoverflow.com/questions/15074127/use-expression-with-a-variable-r
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=14),
         axis.title.y = element_blank(),
         axis.title.x = element_blank(),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.15,0.30),
        legend.text = element_text(size=11)))

remove(ColourDF, ContourLines, HyperChlPlot, ContourBreaks, PicoGAM_Plot_Prep)
```


```{r MED4GAM Plot Blue WL 25, fig.height=5, fig.width=5}
GamStrain = "MED4" 
GamColor = "Blue"
WL_nm = 450 
PlotWL <- "deltaOD"
data_text <- data.frame(label = c('450 nm, 25 µM'))


maxMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.max(fit)) #base::max does not work with package photobiology loaded simultaneously 
maxMu <- maxMu$fit

minMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.min(fit)) #base::max does not work with package photobiology loaded simultaneously 
minMu <- minMu$fit

PicoGAM_Plot_Prep <- PicoGAM_Pred %>%
  filter(Wavelength %in% PlotWL,
         Strain %in% GamStrain,
         WL %in% WL_nm) %>%
  mutate(
         Color_name = case_when(WL == "450" ~ 'Blue',
                                WL == "530" ~ 'Green',
                                WL == "660" ~ 'Red',
                                WL == "WW" ~ 'White'))

WL_O2_Colors = c(Blue = w_length2rgb(450), green = w_length2rgb(530), red = w_length2rgb(660), white= "#FFCC00")

ColourDF <- data.frame(
  ColorName = c('Blue', 'Green', 'Red', 'White'),
  WL_O2_Colors = c( w_length2rgb(450), w_length2rgb(530), w_length2rgb(660), "#FFCC00")
) %>%
  filter(ColorName %in% GamColor) %>%
  dplyr::select(WL_O2_Colors)


ContourBreaks <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL
  ) %>%
  group_by(O2_uM) %>%
  mutate(upper10 = quantile(fit, 0.9, na.rm = TRUE),
         median50 = quantile(fit, 0.5, na.rm = TRUE),
         lower10 = quantile(fit, 0.1, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::select(O2_uM, upper10, median50, lower10) %>%
  distinct() %>%
  pivot_longer(cols = c(upper10, median50, lower10), names_to = 'quantile', values_to = 'quantileValue') %>%
  mutate(quantileValue = round(quantileValue, digits = 2))



HyperChlPlot <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL,
         O2_uM == "25"
  )
ContourLines <- ContourBreaks %>%
  filter(O2_uM == "25") 
ContourLines <- ContourLines$quantileValue 

(ContourMED4BlueInt <- ggplot(na.omit(HyperChlPlot)) + 
    geom_tile(aes(Photoperiod, Par_ue, z = fit, fill = fit)) +
    scale_fill_gradientn(name = bquote("µ ("~ d^-1~")"), colours=c(low = "white", intermediate = "steelblue1", high = "royalblue4"), limits  = range(minMu, 1.0), na.value = "white") +
    metR::geom_contour2(aes(Photoperiod, Par_ue, z = fit, fill = fit, label = stat(level)),
                        breaks = ContourLines,
                        skip = 0) +
    scale_x_continuous(limits = c(4, 16), breaks = c(4, 8, 12, 16)) +
    scale_y_continuous(limits = c(10, 205)) +
    geom_text(data=data_text, aes(x=10, y=205, label=label), size=4) +
    xlab("Photoperiod (h)") +
      ylab("PAR (µmol photons"~ m^-2~ ~s^-1~ ")")+ #https://stackoverflow.com/questions/15074127/use-expression-with-a-variable-r
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=14),
         axis.title.y = element_blank(),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.15,0.30),
        legend.text = element_text(size=11)))

remove(ColourDF, ContourLines, HyperChlPlot, ContourBreaks, PicoGAM_Plot_Prep)

```


``` {r MED4GAM Plot Red WL 250, fig.height=5, fig.width=5}
GamStrain = "MED4" 
GamColor = "Red"
WL_nm = 660 
PlotWL <- "deltaOD"
data_textB <- data.frame(label = c('B'))
data_text <- data.frame(label = c('660 nm, 250 µM'))

maxMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.max(fit)) #base::max does not work with package photobiology loaded simultaneously 
maxMu <- maxMu$fit

minMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.min(fit)) #base::max does not work with package photobiology loaded simultaneously 
minMu <- minMu$fit

PicoGAM_Plot_Prep <- PicoGAM_Pred %>%
  filter(Wavelength %in% PlotWL,
         Strain %in% GamStrain,
         WL %in% WL_nm) %>%
  mutate(
         Color_name = case_when(WL == "450" ~ 'Blue',
                                WL == "530" ~ 'Green',
                                WL == "660" ~ 'Red',
                                WL == "WW" ~ 'White'))

WL_O2_Colors = c(Blue = w_length2rgb(450), green = w_length2rgb(530), red = w_length2rgb(660), white= "#FFCC00")

ColourDF <- data.frame(
  ColorName = c('Blue', 'Green', 'Red', 'White'),
  WL_O2_Colors = c( w_length2rgb(450), w_length2rgb(530), w_length2rgb(660), "#FFCC00")
) %>%
  filter(ColorName %in% GamColor) %>%
  dplyr::select(WL_O2_Colors)


ContourBreaks <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL
  ) %>%
  group_by(O2_uM) %>%
  mutate(upper10 = quantile(fit, 0.9, na.rm = TRUE),
         median50 = quantile(fit, 0.5, na.rm = TRUE),
         lower10 = quantile(fit, 0.1, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::select(O2_uM, upper10, median50, lower10) %>%
  distinct() %>%
  pivot_longer(cols = c(upper10, median50, lower10), names_to = 'quantile', values_to = 'quantileValue') %>%
  mutate(quantileValue = round(quantileValue, digits = 2))


HyperChlPlot <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL,
         O2_uM == "250"
  )
ContourLines <- ContourBreaks %>%
  filter(O2_uM == "250") 
ContourLines <- ContourLines$quantileValue 

(ContourMED4RedHigh <- ggplot(na.omit(HyperChlPlot)) + 
    geom_tile(aes(Photoperiod, Par_ue, z = fit, fill = fit), show.legend = F) +
    scale_fill_gradientn(name = bquote("µ ("~ d^-1~")"), colours=c(low = "white", w_length2rgb(660)), limits  = range(minMu, 1.0), na.value = "white") +
    metR::geom_contour2(aes(Photoperiod, Par_ue, z = fit, fill = fit, label = stat(level)),
                        breaks = ContourLines,
                        skip = 0) +
    scale_x_continuous(limits = c(4, 16), breaks = c(4, 8, 12, 16)) +
    scale_y_continuous(limits = c(10, 205)) +
    geom_text(data=data_textB, aes(x=5, y=205, label=label), size=7) +
     geom_text(data=data_text, aes(x=10, y=205, label=label), size=4) +
    xlab("Photoperiod (h)") +
      ylab("PAR (µmol photons"~ m^-2~ ~s^-1~ ")")+ #https://stackoverflow.com/questions/15074127/use-expression-with-a-variable-r
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=14),
         axis.title.x = element_blank(),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.15,0.30),
        legend.text = element_text(size=11)))

remove(ColourDF, ContourLines, HyperChlPlot, ContourBreaks, PicoGAM_Plot_Prep)

```


``` {r MED4GAM Plot Red WL 25, fig.height=5, fig.width=5}
GamStrain = "MED4" 
GamColor = "Red"
WL_nm = 660 
PlotWL <- "deltaOD"
data_text <- data.frame(label = c('660 nm, 25 µM'))

maxMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.max(fit)) #base::max does not work with package photobiology loaded simultaneously 
maxMu <- maxMu$fit

minMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.min(fit)) #base::max does not work with package photobiology loaded simultaneously 
minMu <- minMu$fit

PicoGAM_Plot_Prep <- PicoGAM_Pred %>%
  filter(Wavelength %in% PlotWL,
         Strain %in% GamStrain,
         WL %in% WL_nm) %>%
  mutate(
         Color_name = case_when(WL == "450" ~ 'Blue',
                                WL == "530" ~ 'Green',
                                WL == "660" ~ 'Red',
                                WL == "WW" ~ 'White'))

WL_O2_Colors = c(Blue = w_length2rgb(450), green = w_length2rgb(530), red = w_length2rgb(660), white= "#FFCC00")

ColourDF <- data.frame(
  ColorName = c('Blue', 'Green', 'Red', 'White'),
  WL_O2_Colors = c( w_length2rgb(450), w_length2rgb(530), w_length2rgb(660), "#FFCC00")
) %>%
  filter(ColorName %in% GamColor) %>%
  dplyr::select(WL_O2_Colors)


ContourBreaks <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL
  ) %>%
  group_by(O2_uM) %>%
  mutate(upper10 = quantile(fit, 0.9, na.rm = TRUE),
         median50 = quantile(fit, 0.5, na.rm = TRUE),
         lower10 = quantile(fit, 0.1, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::select(O2_uM, upper10, median50, lower10) %>%
  distinct() %>%
  pivot_longer(cols = c(upper10, median50, lower10), names_to = 'quantile', values_to = 'quantileValue') %>%
  mutate(quantileValue = round(quantileValue, digits = 2))


HyperChlPlot <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL,
         O2_uM == "25"
  )
ContourLines <- ContourBreaks %>%
  filter(O2_uM == "25") 
ContourLines <- ContourLines$quantileValue 

(ContourMED4RedInt <- ggplot(na.omit(HyperChlPlot)) + 
    geom_tile(aes(Photoperiod, Par_ue, z = fit, fill = fit)) +
    scale_fill_gradientn(name = bquote("µ ("~ d^-1~")"), colours=c(low = "white", w_length2rgb(660)), limits  = range(minMu, 1.0), na.value = "white") +
    metR::geom_contour2(aes(Photoperiod, Par_ue, z = fit, fill = fit, label = stat(level)),
                        breaks = ContourLines,
                        skip = 0) +
    scale_x_continuous(limits = c(4, 16), breaks = c(4, 8, 12, 16)) +
    scale_y_continuous(limits = c(10, 205)) +
    geom_text(data=data_text, aes(x=10, y=205, label=label), size=4) +
    xlab("Photoperiod (h)") +
      ylab("PAR (µmol photons"~ m^-2~ ~s^-1~ ")")+ #https://stackoverflow.com/questions/15074127/use-expression-with-a-variable-r
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=14),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.15,0.30),
        legend.text = element_text(size=11)))

remove(ColourDF, ContourLines, HyperChlPlot, ContourBreaks, PicoGAM_Plot_Prep)

```

```{r, MED4PARGAM, fig.height = 20, fig.width=10, warning=FALSE}

MED4PARGAM <-  MED4PAR / (ContourMED4RedHigh + ContourMED4BlueHigh)/ (ContourMED4RedInt + ContourMED4BlueInt)

MED4PARGAM

remove(MED4PAR, ContourMED4RedHigh, ContourMED4BlueHigh, ContourMED4RedInt, ContourMED4BlueInt)

```

```{r save MED4PARGAM plots}
# MED4PARGAM.png for manuscript
 ggsave(file = file.path(paste(PlotsOut, sep = "/"), paste(GamStrain, "PARGAM", ".png", sep = ""), fsep = .Platform$file.sep), plot = MED4PARGAM,  height = 15, width = 10)

# MED4PARGAM is Fig4.tiff for PLOSONE submission
 ggsave(file = file.path(PlotsOutPLOS, "Fig4.tiff", fsep = .Platform$file.sep), plot = MED4PARGAM, device = NULL, scale = 1,  height = 10, width = 10, compression = "lzw")
 
```


```{r, SS120PAR, fig.height=10, fig.width=10}
  
data_text <- data.frame( ParLabel=c("PAR~(µmol~photons~m^{-2}~s^{-1})"), OxygenLabel = c("Oxygen~concentration~(µM)"),Par_ue = c("30"), O2_uM = c("250"), label = c('A'))

SS120PAR <- GrowthFits %>%
   filter(Strain == "SS120",
           Par_ue %in% c(30,90,180),
          WL %in% c("WW", 450, 660),
          deltaOD_Lmu_corr == 0 |
          deltaOD_Lmu_corr != 0 & deltaOD_LseGrowthFlag == 1) %>%
  mutate(PhotoperiodLabelTitle = "Photoperiod~(h)",
         OxygenLabel = "Oxygen~concentration~(µM)",
         WLlabelTitle = "Growth~wavelength~(nm)",
         ParLabel = "PAR~(µmol~photons~m^{-2}~s^{-1})",
         WL = factor(WL, levels = c("WW", 660, 530, 450)),
         deltaOD_Lmu_corr_day = deltaOD_Lmu_corr * 24,
         deltaOD_Lmu_se_day = deltaOD_Lmu_se * 24) %>% 
  ggplot()  +
    geom_point(aes(x = Photoperiod, y = (deltaOD_Lmu_corr_day), colour = as.factor(WL)), size = 2.5, alpha = 0.75, show.legend = F) +
   geom_line(aes(x = Photoperiod, y = ReplicateMean_deltaOD_Lmu_corr_day, colour = as.factor(WL), linetype = as.factor(WL)), size = 0.5, show.legend = F) +
    geom_point(aes(x = Photoperiod, y = ReplicateMean_deltaOD_Lmu_corr_day, colour = as.factor(WL)), size = 5, alpha = 1) +
    geom_text(data=data_text, aes(x=5.5, y=0.8, label=label), size=7) +
 labs( y = "Chlorophyll specific growth rate " ~  " ("  ~ d^-1~")", x = "Photoperiod (h)") +
   geom_jitter(aes(x = Photoperiod, y = ReplicateMean_deltaOD_Lmu_corr_day, colour = as.factor(WL)), width = 0.1, size = 3, show.legend = F) +
  scale_y_continuous(breaks = c(0,0.25,  0.5, 0.75, 1.0), limits = c (0, 1.05)) +
  # coord_cartesian(ylim = c (0, 0.07)) +
  scale_colour_manual(values = MCMIXColours, labels = c("White LED", "660", "450" )) +
   scale_x_continuous(breaks = c(4,8, 12, 16), limits = c (4, 16)) +
  ggh4x::facet_nested(cols = vars(ParLabel, factor(Par_ue, levels = c("30", "90","180"))), rows = vars(OxygenLabel, factor(O2_uM, levels= c("250", "25","2.5"))), 
                    labeller = label_parsed) + 
 guides(linetype = "none") +
   theme_bw() +
   theme( panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
     axis.title.x.bottom = element_text(size = 16, color = "black", vjust = 1.0),
      axis.title.y = element_text(size = 16, color = "black", vjust = 1.0),
       axis.title.x.top = element_text(size = 16, color = "black", vjust = 1.0),
       axis.text.x = element_text(size = 12, color = "black", angle = 0, hjust = 0.5, vjust = 1),
        axis.text.y = element_text(size = 12, color = "black", angle = 0, hjust = 1.0),
       axis.text.x.top = element_blank(),
       axis.ticks.x.top = element_blank(),
       strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(1, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width
      # legend.title = element_text(size = 15), #change legend title font size for right side legend placement
      # legend.text = element_text(size = 15),  #change legend text font size for right side legend placement
        legend.title = element_text(size = 16),  #change legend title font size
        legend.text = element_text(size = 12),   #change legend text font size
        legend.position = "top") +
  labs(color = "Growth wavelength (nm)",
       fill = "Growth wavelength (nm)")
SS120PAR

```


``` {r SS120GAM Plot Blue WL 250, fig.height=5, fig.width=5}
GamStrain = "SS120" 
GamColor = "Blue"
WL_nm = 450 
PlotWL <- "deltaOD"
data_text <- data.frame(label = c('450 nm, 250 µM'))

maxMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.max(fit)) #base::max does not work with package photobiology loaded simultaneously 
maxMu <- maxMu$fit

minMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.min(fit)) #base::max does not work with package photobiology loaded simultaneously 
minMu <- minMu$fit

PicoGAM_Plot_Prep <- PicoGAM_Pred %>%
  filter(Wavelength %in% PlotWL,
         Strain %in% GamStrain,
         WL %in% WL_nm) %>%
  mutate(
         Color_name = case_when(WL == "450" ~ 'Blue',
                                WL == "530" ~ 'Green',
                                WL == "660" ~ 'Red',
                                WL == "WW" ~ 'White'))

WL_O2_Colors = c(Blue = w_length2rgb(450), green = w_length2rgb(530), red = w_length2rgb(660), white= "#FFCC00")

ColourDF <- data.frame(
  ColorName = c('Blue', 'Green', 'Red', 'White'),
  WL_O2_Colors = c( w_length2rgb(450), w_length2rgb(530), w_length2rgb(660), "#FFCC00")
) %>%
  filter(ColorName %in% GamColor) %>%
  dplyr::select(WL_O2_Colors)


ContourBreaks <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL
  ) %>%
  group_by(O2_uM) %>%
  mutate(upper10 = quantile(fit, 0.9, na.rm = TRUE),
         median50 = quantile(fit, 0.5, na.rm = TRUE),
         lower10 = quantile(fit, 0.1, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::select(O2_uM, upper10, median50, lower10) %>%
  distinct() %>%
  pivot_longer(cols = c(upper10, median50, lower10), names_to = 'quantile', values_to = 'quantileValue') %>%
  mutate(quantileValue = round(quantileValue, digits = 2))


HyperChlPlot <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL,
         O2_uM == "250"
  )
ContourLines <- ContourBreaks %>%
  filter(O2_uM == "250") 
ContourLines <- ContourLines$quantileValue 

(ContourSS120BlueHigh <- ggplot(na.omit(HyperChlPlot)) + 
    geom_tile(aes(Photoperiod, Par_ue, z = fit, fill = fit), show.legend = F) +
    scale_fill_gradientn(name = bquote("µ ("~ d^-1~")"), colours=c(low = "white", intermediate = "steelblue1", high = "royalblue4"), limits  = range(minMu, 1.0), na.value = "white") +
    metR::geom_contour2(aes(Photoperiod, Par_ue, z = fit, fill = fit, label = stat(level)),
                        breaks = ContourLines,
                        skip = 0) +
    scale_x_continuous(limits = c(4, 16), breaks = c(4, 8, 12, 16)) +
    scale_y_continuous(limits = c(10, 205)) +
    geom_text(data=data_text, aes(x=10, y=205, label=label), size=4) +
    xlab("Photoperiod (h)") +
      ylab("PAR (µmol photons"~ m^-2~ ~s^-1~ ")")+ #https://stackoverflow.com/questions/15074127/use-expression-with-a-variable-r
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=14),
         axis.title.y = element_blank(),
         axis.title.x = element_blank(),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.15,0.30),
        legend.text = element_text(size=11)))

remove(ColourDF, ContourLines, HyperChlPlot, ContourBreaks, PicoGAM_Plot_Prep)

```


```{r SS120GAM Plot Blue WL 25, fig.height=5, fig.width=5}
GamStrain = "SS120" 
GamColor = "Blue"
WL_nm = 450 
PlotWL <- "deltaOD"
data_text <- data.frame(label = c('450 nm, 25 µM'))


maxMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.max(fit)) #base::max does not work with package photobiology loaded simultaneously 
maxMu <- maxMu$fit

minMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.min(fit)) #base::max does not work with package photobiology loaded simultaneously 
minMu <- minMu$fit

PicoGAM_Plot_Prep <- PicoGAM_Pred %>%
  filter(Wavelength %in% PlotWL,
         Strain %in% GamStrain,
         WL %in% WL_nm) %>%
  mutate(
         Color_name = case_when(WL == "450" ~ 'Blue',
                                WL == "530" ~ 'Green',
                                WL == "660" ~ 'Red',
                                WL == "WW" ~ 'White'))

WL_O2_Colors = c(Blue = w_length2rgb(450), green = w_length2rgb(530), red = w_length2rgb(660), white= "#FFCC00")

ColourDF <- data.frame(
  ColorName = c('Blue', 'Green', 'Red', 'White'),
  WL_O2_Colors = c( w_length2rgb(450), w_length2rgb(530), w_length2rgb(660), "#FFCC00")
) %>%
  filter(ColorName %in% GamColor) %>%
  dplyr::select(WL_O2_Colors)


ContourBreaks <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL
  ) %>%
  group_by(O2_uM) %>%
  mutate(upper10 = quantile(fit, 0.9, na.rm = TRUE),
         median50 = quantile(fit, 0.5, na.rm = TRUE),
         lower10 = quantile(fit, 0.1, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::select(O2_uM, upper10, median50, lower10) %>%
  distinct() %>%
  pivot_longer(cols = c(upper10, median50, lower10), names_to = 'quantile', values_to = 'quantileValue') %>%
  mutate(quantileValue = round(quantileValue, digits = 2))


HyperChlPlot <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL,
         O2_uM == "25"
  )
ContourLines <- ContourBreaks %>%
  filter(O2_uM == "25") 
ContourLines <- ContourLines$quantileValue 

(ContourSS120BlueInt <- ggplot(na.omit(HyperChlPlot)) + 
    geom_tile(aes(Photoperiod, Par_ue, z = fit, fill = fit)) +
    scale_fill_gradientn(name = bquote("µ ("~ d^-1~")"), colours=c(low = "white", intermediate = "steelblue1", high = "royalblue4"), limits  = range(minMu, 1.0), na.value = "white") +
    metR::geom_contour2(aes(Photoperiod, Par_ue, z = fit, fill = fit, label = stat(level)),
                        breaks = ContourLines,
                        skip = 0) +
    scale_x_continuous(limits = c(4, 16), breaks = c(4, 8, 12, 16)) +
    scale_y_continuous(limits = c(10, 205)) +
    geom_text(data=data_text, aes(x=10, y=205, label=label), size=4) +
    xlab("Photoperiod (h)") +
      ylab("PAR (µmol photons"~ m^-2~ ~s^-1~ ")")+ #https://stackoverflow.com/questions/15074127/use-expression-with-a-variable-r
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=14),
         axis.title.y = element_blank(),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.88,0.81),
        legend.text = element_text(size=11)))

remove(ColourDF, ContourLines, HyperChlPlot, ContourBreaks, PicoGAM_Plot_Prep)

```

``` {r SS120GAM Plot Red WL 250, fig.height=5, fig.width=5}
GamStrain = "SS120" 
GamColor = "Red"
WL_nm = 660 
PlotWL <- "deltaOD"
data_textB <- data.frame(label = c('B'))
data_text <- data.frame(label = c('660 nm, 250 µM'))

maxMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.max(fit)) #base::max does not work with package photobiology loaded simultaneously 
maxMu <- maxMu$fit

minMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.min(fit)) #base::max does not work with package photobiology loaded simultaneously 
minMu <- minMu$fit

PicoGAM_Plot_Prep <- PicoGAM_Pred %>%
  filter(Wavelength %in% PlotWL,
         Strain %in% GamStrain,
         WL %in% WL_nm) %>%
  mutate(
         Color_name = case_when(WL == "450" ~ 'Blue',
                                WL == "530" ~ 'Green',
                                WL == "660" ~ 'Red',
                                WL == "WW" ~ 'White'))

WL_O2_Colors = c(Blue = w_length2rgb(450), green = w_length2rgb(530), red = w_length2rgb(660), white= "#FFCC00")

ColourDF <- data.frame(
  ColorName = c('Blue', 'Green', 'Red', 'White'),
  WL_O2_Colors = c( w_length2rgb(450), w_length2rgb(530), w_length2rgb(660), "#FFCC00")
) %>%
  filter(ColorName %in% GamColor) %>%
  dplyr::select(WL_O2_Colors)


ContourBreaks <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL
  ) %>%
  group_by(O2_uM) %>%
  mutate(upper10 = quantile(fit, 0.9, na.rm = TRUE),
         median50 = quantile(fit, 0.5, na.rm = TRUE),
         lower10 = quantile(fit, 0.1, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::select(O2_uM, upper10, median50, lower10) %>%
  distinct() %>%
  pivot_longer(cols = c(upper10, median50, lower10), names_to = 'quantile', values_to = 'quantileValue') %>%
  mutate(quantileValue = round(quantileValue, digits = 2))


HyperChlPlot <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL,
         O2_uM == "250"
  )
ContourLines <- ContourBreaks %>%
  filter(O2_uM == "250") 
ContourLines <- ContourLines$quantileValue 

(ContourSS120RedHigh <- ggplot(na.omit(HyperChlPlot)) + 
    geom_tile(aes(Photoperiod, Par_ue, z = fit, fill = fit), show.legend = F) +
    scale_fill_gradientn(name = bquote("µ ("~ d^-1~")"), colours=c(low = "white", w_length2rgb(660)), limits  = range(minMu, 1.0), na.value = "white") +
    metR::geom_contour2(aes(Photoperiod, Par_ue, z = fit, fill = fit, label = stat(level)),
                        breaks = ContourLines,
                        skip = 0) +
    scale_x_continuous(limits = c(4, 16), breaks = c(4, 8, 12, 16)) +
    scale_y_continuous(limits = c(10, 205)) +
    geom_text(data=data_textB, aes(x = 5, y = 205, label=label), size=7) +
     geom_text(data=data_text, aes(x = 10, y = 205, label=label), size=4) +
    xlab("Photoperiod (h)") +
      ylab("PAR (µmol photons"~ m^-2~ ~s^-1~ ")")+ #https://stackoverflow.com/questions/15074127/use-expression-with-a-variable-r
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size = 14),
         axis.title.x = element_blank(),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.15,0.30),
        legend.text = element_text(size = 11)))

remove(ColourDF, ContourLines, HyperChlPlot, ContourBreaks, PicoGAM_Plot_Prep)

```


``` {r SS120GAM Plot Red WL 25, fig.height=5, fig.width=5}
GamStrain = "SS120" 
GamColor = "Red"
WL_nm = 660 
PlotWL <- "deltaOD"
data_text <- data.frame(label = c('660 nm, 25 µM'))

maxMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.max(fit)) #base::max does not work with package photobiology loaded simultaneously 
maxMu <- maxMu$fit

minMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.min(fit)) #base::max does not work with package photobiology loaded simultaneously 
minMu <- minMu$fit

PicoGAM_Plot_Prep <- PicoGAM_Pred %>%
  filter(Wavelength %in% PlotWL,
         Strain %in% GamStrain,
         WL %in% WL_nm) %>%
  mutate(
         Color_name = case_when(WL == "450" ~ 'Blue',
                                WL == "530" ~ 'Green',
                                WL == "660" ~ 'Red',
                                WL == "WW" ~ 'White'))

WL_O2_Colors = c(Blue = w_length2rgb(450), green = w_length2rgb(530), red = w_length2rgb(660), white= "#FFCC00")

ColourDF <- data.frame(
  ColorName = c('Blue', 'Green', 'Red', 'White'),
  WL_O2_Colors = c( w_length2rgb(450), w_length2rgb(530), w_length2rgb(660), "#FFCC00")
) %>%
  filter(ColorName %in% GamColor) %>%
  dplyr::select(WL_O2_Colors)


ContourBreaks <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL
  ) %>%
  group_by(O2_uM) %>%
  mutate(upper10 = quantile(fit, 0.9, na.rm = TRUE),
         median50 = quantile(fit, 0.5, na.rm = TRUE),
         lower10 = quantile(fit, 0.1, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::select(O2_uM, upper10, median50, lower10) %>%
  distinct() %>%
  pivot_longer(cols = c(upper10, median50, lower10), names_to = 'quantile', values_to = 'quantileValue') %>%
  mutate(quantileValue = round(quantileValue, digits = 2))


HyperChlPlot <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL,
         O2_uM == "25"
  )
ContourLines <- ContourBreaks %>%
  filter(O2_uM == "25") 
ContourLines <- ContourLines$quantileValue 

(ContourSS120RedInt <- ggplot(na.omit(HyperChlPlot)) + 
    geom_tile(aes(Photoperiod, Par_ue, z = fit, fill = fit)) +
    scale_fill_gradientn(name = bquote("µ ("~ d^-1~")"), colours=c(low = "white", w_length2rgb(660)), limits  = range(minMu, 1.0), na.value = "white") +
    metR::geom_contour2(aes(Photoperiod, Par_ue, z = fit, fill = fit, label = stat(level)),
                        breaks = ContourLines,
                        skip = 0) +
    scale_x_continuous(limits = c(4, 16), breaks = c(4, 8, 12, 16)) +
    scale_y_continuous(limits = c(10, 205)) +
    geom_text(data=data_text, aes(x=10, y=205, label=label), size=4) +
    xlab("Photoperiod (h)") +
      ylab("PAR (µmol photons"~ m^-2~ ~s^-1~ ")")+ #https://stackoverflow.com/questions/15074127/use-expression-with-a-variable-r
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=14),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.88,0.81),
        legend.text = element_text(size=11)))

remove(ColourDF, ContourLines, HyperChlPlot, ContourBreaks, PicoGAM_Plot_Prep)

```

```{r, SS120PARGAM, fig.height = 20, fig.width=10, warning=FALSE}

SS120PARGAM <-  SS120PAR / (ContourSS120RedHigh + ContourSS120BlueHigh)/ (ContourSS120RedInt + ContourSS120BlueInt)

SS120PARGAM

remove(SS120PAR, ContourSS120RedHigh, ContourSS120BlueHigh, ContourSS120RedInt, ContourSS120BlueInt)

```

```{r save SS120GAM plots}

# SS120PARGAM.png for manuscript
 ggsave(file = file.path(paste(PlotsOut, sep = "/"), paste(GamStrain, "PARGAM", ".png", sep = ""), fsep = .Platform$file.sep), plot = SS120PARGAM,  height = 15, width = 10)

# SS120PARGAM is Fig6.tiff for PLOSONE submission
 ggsave(file = file.path(PlotsOutPLOS, "Fig6.tiff", fsep = .Platform$file.sep), plot = LabelledCombinedGam, device = NULL, scale = 1,  height = 10, width = 10, compression = "lzw")
 
```


```{r, MIT9313PAR, fig.height=10, fig.width=10}
  
data_text <- data.frame( ParLabel=c("PAR~(µmol~photons~m^{-2}~s^{-1})"), OxygenLabel = c("Oxygen~concentration~(µM)"),Par_ue = c("30"), O2_uM = c("250"), label = c('A'))

MIT9313PAR <- GrowthFits %>%
   filter(Strain == "MIT9313",
           Par_ue %in% c(30,90,180),
          WL %in% c("WW", 450, 660),
          deltaOD_Lmu_corr == 0 |
          deltaOD_Lmu_corr != 0 & deltaOD_LseGrowthFlag == 1) %>%
  mutate(PhotoperiodLabelTitle = "Photoperiod~(h)",
         OxygenLabel = "Oxygen~concentration~(µM)",
         WLlabelTitle = "Growth~wavelength~(nm)",
         ParLabel = "PAR~(µmol~photons~m^{-2}~s^{-1})",
         WL = factor(WL, levels = c("WW", 660, 530, 450)),
         deltaOD_Lmu_corr_day = deltaOD_Lmu_corr * 24,
         deltaOD_Lmu_se_day = deltaOD_Lmu_se * 24) %>% 
  ggplot()  +
    geom_point(aes(x = Photoperiod, y = (deltaOD_Lmu_corr_day), colour = as.factor(WL)), size = 2.5, alpha = 0.75, show.legend = F) +
   geom_line(aes(x = Photoperiod, y = ReplicateMean_deltaOD_Lmu_corr_day, colour = as.factor(WL), linetype = as.factor(WL)), size = 0.5, show.legend = F) +
    geom_point(aes(x = Photoperiod, y = ReplicateMean_deltaOD_Lmu_corr_day, colour = as.factor(WL)), size = 5, alpha = 1) +
    geom_text(data=data_text, aes(x=5.5, y=0.8, label=label), size=7) +
 labs( y = "Chlorophyll specific growth rate " ~  " ("  ~ d^-1~")", x = "Photoperiod (h)") +
   geom_jitter(aes(x = Photoperiod, y = ReplicateMean_deltaOD_Lmu_corr_day, colour = as.factor(WL)), width = 0.1, size = 3, show.legend = F) +
  scale_y_continuous(breaks = c(0,0.25,  0.5, 0.75, 1.0), limits = c (0, 1.05)) +
  scale_colour_manual(values = MCMIXColours, labels = c("White LED", "660", "450" )) +
   scale_x_continuous(breaks = c(4,8, 12, 16), limits = c (4, 16)) +
  ggh4x::facet_nested(cols = vars(ParLabel, factor(Par_ue, levels = c("30", "90","180"))), rows = vars(OxygenLabel, factor(O2_uM, levels= c("250", "25","2.5"))), 
                    labeller = label_parsed) + 
 guides(linetype = "none") +
   theme_bw() +
   theme( panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
     axis.title.x.bottom = element_text(size = 16, color = "black", vjust = 1.0),
      axis.title.y = element_text(size = 16, color = "black", vjust = 1.0),
       axis.title.x.top = element_text(size = 16, color = "black", vjust = 1.0),
       axis.text.x = element_text(size = 12, color = "black", angle = 0, hjust = 0.5, vjust = 1),
        axis.text.y = element_text(size = 12, color = "black", angle = 0, hjust = 1.0),
       axis.text.x.top = element_blank(),
       axis.ticks.x.top = element_blank(),
       strip.background = element_rect(fill="white"),
        strip.text = element_text(size=12),
        legend.key.size = unit(1, 'cm'), #change legend key size
        legend.key.height = unit(1, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width
        # legend.title = element_text(size = 15),  #change legend title font size for right side legend placement
        # legend.text = element_text(size = 15),   #change legend text font size for right side legend placement
        legend.title = element_text(size = 16),  #change legend title font size
        legend.text = element_text(size = 12),   #change legend text font size
        legend.position = "top") +
  labs(color = "Growth wavelength (nm)",
       fill = "Growth wavelength (nm)")
MIT9313PAR

```


``` {r MIT9313GAM Plot Blue WL 250, fig.height=4.5, fig.width=4.5}
GamStrain = "MIT9313" 
GamColor = "Blue"
WL_nm = 450 
PlotWL <- "deltaOD"
data_text <- data.frame(label = c('450 nm, 250 µM'))

maxMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.max(fit)) #base::max does not work with package photobiology loaded simultaneously 
maxMu <- maxMu$fit

minMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.min(fit)) #base::max does not work with package photobiology loaded simultaneously 
minMu <- minMu$fit

PicoGAM_Plot_Prep <- PicoGAM_Pred %>%
  filter(Wavelength %in% PlotWL,
         Strain %in% GamStrain,
         WL %in% WL_nm) %>%
  mutate(
         Color_name = case_when(WL == "450" ~ 'Blue',
                                WL == "530" ~ 'Green',
                                WL == "660" ~ 'Red',
                                WL == "WW" ~ 'White'))

WL_O2_Colors = c(Blue = w_length2rgb(450), green = w_length2rgb(530), red = w_length2rgb(660), white= "#FFCC00")

ColourDF <- data.frame(
  ColorName = c('Blue', 'Green', 'Red', 'White'),
  WL_O2_Colors = c( w_length2rgb(450), w_length2rgb(530), w_length2rgb(660), "#FFCC00")
) %>%
  filter(ColorName %in% GamColor) %>%
  dplyr::select(WL_O2_Colors)


ContourBreaks <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL
  ) %>%
  group_by(O2_uM) %>%
  mutate(upper10 = quantile(fit, 0.9, na.rm = TRUE),
         median50 = quantile(fit, 0.5, na.rm = TRUE),
         lower10 = quantile(fit, 0.1, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::select(O2_uM, upper10, median50, lower10) %>%
  distinct() %>%
  pivot_longer(cols = c(upper10, median50, lower10), names_to = 'quantile', values_to = 'quantileValue') %>%
  mutate(quantileValue = round(quantileValue, digits = 2))


HyperChlPlot <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL,
         O2_uM == "250"
  )
ContourLines <- ContourBreaks %>%
  filter(O2_uM == "250") 
ContourLines <- ContourLines$quantileValue 

(ContourMIT9313BlueHigh <- ggplot(na.omit(HyperChlPlot)) + 
    geom_tile(aes(Photoperiod, Par_ue, z = fit, fill = fit), show.legend = F) +
    scale_fill_gradientn(name = bquote("µ ("~ d^-1~")"), colours=c(low = "white", intermediate = "steelblue1", high = "royalblue4"), limits  = range(minMu, 1.0), na.value = "white") +
    metR::geom_contour2(aes(Photoperiod, Par_ue, z = fit, fill = fit, label = stat(level)),
                        breaks = ContourLines,
                        skip = 0) +
    scale_x_continuous(limits = c(4, 16), breaks = c(4, 8, 12, 16)) +
    scale_y_continuous(limits = c(10, 205)) +
    geom_text(data=data_text, aes(x=10, y=205, label=label), size=4) +
    xlab("Photoperiod (h)") +
      ylab("PAR (µmol photons"~ m^-2~ ~s^-1~ ")")+
#https://stackoverflow.com/questions/15074127/use-expression-with-a-variable-r
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=14),
         axis.title.y = element_blank(),
         axis.title.x = element_blank(),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.15,0.30),
        legend.text = element_text(size=11)))

remove(ColourDF, ContourLines, HyperChlPlot, ContourBreaks, PicoGAM_Plot_Prep)

```


```{r MIT9313GAM Plot Blue WL 25, fig.height=4.5, fig.width=4.5}
GamStrain = "MIT9313" 
GamColor = "Blue"
WL_nm = 450 
PlotWL <- "deltaOD"
data_text <- data.frame(label = c('450 nm, 25 µM'))


maxMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.max(fit)) #base::max does not work with package photobiology loaded simultaneously 
maxMu <- maxMu$fit

minMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.min(fit)) #base::max does not work with package photobiology loaded simultaneously 
minMu <- minMu$fit

PicoGAM_Plot_Prep <- PicoGAM_Pred %>%
  filter(Wavelength %in% PlotWL,
         Strain %in% GamStrain,
         WL %in% WL_nm) %>%
  mutate(
         Color_name = case_when(WL == "450" ~ 'Blue',
                                WL == "530" ~ 'Green',
                                WL == "660" ~ 'Red',
                                WL == "WW" ~ 'White'))

WL_O2_Colors = c(Blue = w_length2rgb(450), green = w_length2rgb(530), red = w_length2rgb(660), white= "#FFCC00")

ColourDF <- data.frame(
  ColorName = c('Blue', 'Green', 'Red', 'White'),
  WL_O2_Colors = c( w_length2rgb(450), w_length2rgb(530), w_length2rgb(660), "#FFCC00")
) %>%
  filter(ColorName %in% GamColor) %>%
  dplyr::select(WL_O2_Colors)


ContourBreaks <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL
  ) %>%
  group_by(O2_uM) %>%
  mutate(upper10 = quantile(fit, 0.9, na.rm = TRUE),
         median50 = quantile(fit, 0.5, na.rm = TRUE),
         lower10 = quantile(fit, 0.1, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::select(O2_uM, upper10, median50, lower10) %>%
  distinct() %>%
  pivot_longer(cols = c(upper10, median50, lower10), names_to = 'quantile', values_to = 'quantileValue') %>%
  mutate(quantileValue = round(quantileValue, digits = 2))


HyperChlPlot <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL,
         O2_uM == "25"
  )
ContourLines <- ContourBreaks %>%
  filter(O2_uM == "25") 
ContourLines <- ContourLines$quantileValue 

(ContourMIT9313BlueInt <- ggplot(na.omit(HyperChlPlot)) + 
    geom_tile(aes(Photoperiod, Par_ue, z = fit, fill = fit), show.legend = F) +
    scale_fill_gradientn(name = bquote("µ ("~ d^-1~")"), colours=c(low = "white", intermediate = "steelblue1", high = "royalblue4"), limits  = range(minMu, 1.0), na.value = "white") +
    metR::geom_contour2(aes(Photoperiod, Par_ue, z = fit, fill = fit, label = stat(level)),
                        breaks = ContourLines,
                        skip = 0) +
    scale_x_continuous(limits = c(4, 16), breaks = c(4, 8, 12, 16)) +
    scale_y_continuous(limits = c(10, 205)) +
    geom_text(data=data_text, aes(x=10, y=205, label=label), size=4) +
      ylab("PAR (µmol photons"~ m^-2~ ~s^-1~ ")")+ #https://stackoverflow.com/questions/15074127/use-expression-with-a-variable-r
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=14),
         axis.title.y = element_blank(),
         axis.title.x = element_blank(),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.88,0.81),
        legend.text = element_text(size=11)))

remove(ColourDF, ContourLines, HyperChlPlot, ContourBreaks, PicoGAM_Plot_Prep)

```


```{r MIT9313GAM Plot Blue WL 2.5, fig.height=4.5, fig.width=4.5}
GamStrain = "MIT9313" 
GamColor = "Blue"
WL_nm = 450 
PlotWL <- "deltaOD"
data_text <- data.frame(label = c('450 nm, 2.5 µM'))


maxMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.max(fit)) #base::max does not work with package photobiology loaded simultaneously 
maxMu <- maxMu$fit

minMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.min(fit)) #base::max does not work with package photobiology loaded simultaneously 
minMu <- minMu$fit

PicoGAM_Plot_Prep <- PicoGAM_Pred %>%
  filter(Wavelength %in% PlotWL,
         Strain %in% GamStrain,
         WL %in% WL_nm) %>%
  mutate(
         Color_name = case_when(WL == "450" ~ 'Blue',
                                WL == "530" ~ 'Green',
                                WL == "660" ~ 'Red',
                                WL == "WW" ~ 'White'))

WL_O2_Colors = c(Blue = w_length2rgb(450), green = w_length2rgb(530), red = w_length2rgb(660), white= "#FFCC00")

ColourDF <- data.frame(
  ColorName = c('Blue', 'Green', 'Red', 'White'),
  WL_O2_Colors = c( w_length2rgb(450), w_length2rgb(530), w_length2rgb(660), "#FFCC00")
) %>%
  filter(ColorName %in% GamColor) %>%
  dplyr::select(WL_O2_Colors)


ContourBreaks <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL
  ) %>%
  group_by(O2_uM) %>%
  mutate(upper10 = quantile(fit, 0.9, na.rm = TRUE),
         median50 = quantile(fit, 0.5, na.rm = TRUE),
         lower10 = quantile(fit, 0.1, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::select(O2_uM, upper10, median50, lower10) %>%
  distinct() %>%
  pivot_longer(cols = c(upper10, median50, lower10), names_to = 'quantile', values_to = 'quantileValue') %>%
  mutate(quantileValue = round(quantileValue, digits = 2))


HyperChlPlot <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL,
         O2_uM == "2.5"
  )
ContourLines <- ContourBreaks %>%
  filter(O2_uM == "2.5") 
ContourLines <- ContourLines$quantileValue 

(ContourMIT9313BlueLow <- ggplot(na.omit(HyperChlPlot)) + 
    geom_tile(aes(Photoperiod, Par_ue, z = fit, fill = fit), show.legend = T) +
    scale_fill_gradientn(name = bquote("µ ("~ d^-1~")"), colours=c(low = "white", intermediate = "steelblue1", high = "royalblue4"), limits  = range(minMu, 1.0), na.value = "white") +
    metR::geom_contour2(aes(Photoperiod, Par_ue, z = fit, fill = fit, label = stat(level)),
                        breaks = ContourLines,
                        skip = 0) +
    scale_x_continuous(limits = c(4, 16), breaks = c(4, 8, 12, 16)) +
    scale_y_continuous(limits = c(10, 205)) +
    geom_text(data=data_text, aes(x=10, y=205, label=label), size=4) +
    xlab("Photoperiod (h)") +
      ylab("PAR (µmol photons"~ m^-2~ ~s^-1~ ")")+ #https://stackoverflow.com/questions/15074127/use-expression-with-a-variable-r
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=14),
         axis.title.y = element_blank(),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.88,0.76),
        legend.text = element_text(size=11)))

remove(ColourDF, ContourLines, HyperChlPlot, ContourBreaks, PicoGAM_Plot_Prep)

```

``` {r MIT9313GAM Plot Red WL 250, fig.height=4.5, fig.width=4.5}
GamStrain = "MIT9313" 
GamColor = "Red"
WL_nm = 660 
PlotWL <- "deltaOD"
data_textB <- data.frame(label = c('B'))
data_text <- data.frame(label = c('660 nm, 250 µM'))

maxMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.max(fit)) #base::max does not work with package photobiology loaded simultaneously 
maxMu <- maxMu$fit

minMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.min(fit)) #base::max does not work with package photobiology loaded simultaneously 
minMu <- minMu$fit

PicoGAM_Plot_Prep <- PicoGAM_Pred %>%
  filter(Wavelength %in% PlotWL,
         Strain %in% GamStrain,
         WL %in% WL_nm) %>%
  mutate(
         Color_name = case_when(WL == "450" ~ 'Blue',
                                WL == "530" ~ 'Green',
                                WL == "660" ~ 'Red',
                                WL == "WW" ~ 'White'))

WL_O2_Colors = c(Blue = w_length2rgb(450), green = w_length2rgb(530), red = w_length2rgb(660), white= "#FFCC00")

ColourDF <- data.frame(
  ColorName = c('Blue', 'Green', 'Red', 'White'),
  WL_O2_Colors = c( w_length2rgb(450), w_length2rgb(530), w_length2rgb(660), "#FFCC00")
) %>%
  filter(ColorName %in% GamColor) %>%
  dplyr::select(WL_O2_Colors)


ContourBreaks <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL
  ) %>%
  group_by(O2_uM) %>%
  mutate(upper10 = quantile(fit, 0.9, na.rm = TRUE),
         median50 = quantile(fit, 0.5, na.rm = TRUE),
         lower10 = quantile(fit, 0.1, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::select(O2_uM, upper10, median50, lower10) %>%
  distinct() %>%
  pivot_longer(cols = c(upper10, median50, lower10), names_to = 'quantile', values_to = 'quantileValue') %>%
  mutate(quantileValue = round(quantileValue, digits = 2))


HyperChlPlot <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL,
         O2_uM == "250"
  )
ContourLines <- ContourBreaks %>%
  filter(O2_uM == "250") 
ContourLines <- ContourLines$quantileValue 

(ContourMIT9313RedHigh <- ggplot(na.omit(HyperChlPlot)) + 
    geom_tile(aes(Photoperiod, Par_ue, z = fit, fill = fit), show.legend = F) +
    scale_fill_gradientn(name = bquote("µ ("~ d^-1~")"), colours=c(low = "white", w_length2rgb(660)), limits  = range(minMu, 1.0), na.value = "white") +
    metR::geom_contour2(aes(Photoperiod, Par_ue, z = fit, fill = fit, label = stat(level)),
                        breaks = ContourLines,
                        skip = 0) +
    scale_x_continuous(limits = c(4, 16), breaks = c(4, 8, 12, 16)) +
    scale_y_continuous(limits = c(10, 205)) +
    geom_text(data=data_textB, aes(x=5, y=205, label=label), size=7) +
    geom_text(data=data_text, aes(x=10, y=205, label=label), size=4) +
    xlab("Photoperiod (h)") +
      ylab("PAR (µmol photons"~ m^-2~ ~s^-1~ ")")+
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=14),
         axis.title.x = element_blank(),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.15,0.30),
        legend.text = element_text(size=11)))

remove(ColourDF, ContourLines, HyperChlPlot, ContourBreaks, PicoGAM_Plot_Prep)

```


``` {r MIT9313GAM Plot Red WL 25, fig.height=4.5, fig.width=4.5}
GamStrain = "MIT9313" 
GamColor = "Red"
WL_nm = 660 
PlotWL <- "deltaOD"
data_text <- data.frame(label = c('660 nm, 25 µM'))

maxMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.max(fit)) #base::max does not work with package photobiology loaded simultaneously 
maxMu <- maxMu$fit

minMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.min(fit)) #base::max does not work with package photobiology loaded simultaneously 
minMu <- minMu$fit

PicoGAM_Plot_Prep <- PicoGAM_Pred %>%
  filter(Wavelength %in% PlotWL,
         Strain %in% GamStrain,
         WL %in% WL_nm) %>%
  mutate(
         Color_name = case_when(WL == "450" ~ 'Blue',
                                WL == "530" ~ 'Green',
                                WL == "660" ~ 'Red',
                                WL == "WW" ~ 'White'))

WL_O2_Colors = c(Blue = w_length2rgb(450), green = w_length2rgb(530), red = w_length2rgb(660), white= "#FFCC00")

ColourDF <- data.frame(
  ColorName = c('Blue', 'Green', 'Red', 'White'),
  WL_O2_Colors = c( w_length2rgb(450), w_length2rgb(530), w_length2rgb(660), "#FFCC00")
) %>%
  filter(ColorName %in% GamColor) %>%
  dplyr::select(WL_O2_Colors)


ContourBreaks <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL
  ) %>%
  group_by(O2_uM) %>%
  mutate(upper10 = quantile(fit, 0.9, na.rm = TRUE),
         median50 = quantile(fit, 0.5, na.rm = TRUE),
         lower10 = quantile(fit, 0.1, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::select(O2_uM, upper10, median50, lower10) %>%
  distinct() %>%
  pivot_longer(cols = c(upper10, median50, lower10), names_to = 'quantile', values_to = 'quantileValue') %>%
  mutate(quantileValue = round(quantileValue, digits = 2))


HyperChlPlot <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL,
         O2_uM == "25"
  )
ContourLines <- ContourBreaks %>%
  filter(O2_uM == "25") 
ContourLines <- ContourLines$quantileValue 

(ContourMIT9313RedInt <- ggplot(na.omit(HyperChlPlot)) + 
    geom_tile(aes(Photoperiod, Par_ue, z = fit, fill = fit), show.legend = F) +
    scale_fill_gradientn(name = bquote("µ ("~ d^-1~")"), colours=c(low = "white", w_length2rgb(660)), limits  = range(minMu, 1.0), na.value = "white") +
    metR::geom_contour2(aes(Photoperiod, Par_ue, z = fit, fill = fit, label = stat(level)),
                        breaks = ContourLines,
                        skip = 0) +
    scale_x_continuous(limits = c(4, 16), breaks = c(4, 8, 12, 16)) +
    scale_y_continuous(limits = c(10, 205)) +
    geom_text(data=data_text, aes(x=10, y=205, label=label), size=4) +
      ylab("PAR (µmol photons"~ m^-2~ ~s^-1~ ")")+
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=14),
        axis.title.x = element_blank(),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.88,0.81),
        legend.text = element_text(size=11)))

remove(ColourDF, ContourLines, HyperChlPlot, ContourBreaks, PicoGAM_Plot_Prep)

```


``` {r MIT9313GAM Plot Red WL 2.5, fig.height=4.5, fig.width=4.5}
GamStrain = "MIT9313" 
GamColor = "Red"
WL_nm = 660 
PlotWL <- "deltaOD"
data_text <- data.frame(label = c('660 nm, 2.5 µM'))

maxMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.max(fit)) #base::max does not work with package photobiology loaded simultaneously 
maxMu <- maxMu$fit

minMu <- PicoGAM_Pred %>%
  ungroup() %>%
  filter(Wavelength %in% PlotWL) %>%
  slice(which.min(fit)) #base::max does not work with package photobiology loaded simultaneously 
minMu <- minMu$fit

PicoGAM_Plot_Prep <- PicoGAM_Pred %>%
  filter(Wavelength %in% PlotWL,
         Strain %in% GamStrain,
         WL %in% WL_nm) %>%
  mutate(
         Color_name = case_when(WL == "450" ~ 'Blue',
                                WL == "530" ~ 'Green',
                                WL == "660" ~ 'Red',
                                WL == "WW" ~ 'White'))

WL_O2_Colors = c(Blue = w_length2rgb(450), green = w_length2rgb(530), red = w_length2rgb(660), white= "#FFCC00")

ColourDF <- data.frame(
  ColorName = c('Blue', 'Green', 'Red', 'White'),
  WL_O2_Colors = c( w_length2rgb(450), w_length2rgb(530), w_length2rgb(660), "#FFCC00")
) %>%
  filter(ColorName %in% GamColor) %>%
  dplyr::select(WL_O2_Colors)


ContourBreaks <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL
  ) %>%
  group_by(O2_uM) %>%
  mutate(upper10 = quantile(fit, 0.9, na.rm = TRUE),
         median50 = quantile(fit, 0.5, na.rm = TRUE),
         lower10 = quantile(fit, 0.1, na.rm = TRUE)) %>%
  ungroup() %>%
  dplyr::select(O2_uM, upper10, median50, lower10) %>%
  distinct() %>%
  pivot_longer(cols = c(upper10, median50, lower10), names_to = 'quantile', values_to = 'quantileValue') %>%
  mutate(quantileValue = round(quantileValue, digits = 2))



HyperChlPlot <- PicoGAM_Plot_Prep %>%
  filter(
         Strain %in% GamStrain,
         Wavelength %in% PlotWL,
         O2_uM == "2.5"
  )
ContourLines <- ContourBreaks %>%
  filter(O2_uM == "2.5") 
ContourLines <- ContourLines$quantileValue 

(ContourMIT9313RedLow <- ggplot(na.omit(HyperChlPlot)) + 
    geom_tile(aes(Photoperiod, Par_ue, z = fit, fill = fit)) +
    scale_fill_gradientn(name = bquote("µ ("~ d^-1~")"), colours=c(low = "white", w_length2rgb(660)), limits  = range(minMu, 1.0), na.value = "white") +
    metR::geom_contour2(aes(Photoperiod, Par_ue, z = fit, fill = fit, label = stat(level)),
                        breaks = ContourLines,
                        skip = 0) +
    scale_x_continuous(limits = c(4, 16), breaks = c(4, 8, 12, 16)) +
    scale_y_continuous(limits = c(10, 205)) +
    geom_text(data=data_text, aes(x=10, y=205, label=label), size=4) +
    xlab("Photoperiod (h)") +
      ylab("PAR (µmol photons"~ m^-2~ ~s^-1~ ")")+ #https://stackoverflow.com/questions/15074127/use-expression-with-a-variable-r
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        axis.text = element_text(size=12),
        axis.title = element_text(size=16),
        strip.background = element_rect(fill="white"),
        strip.text = element_text(size=14),
        axis.title.x = element_text(margin=margin(t=10)),
        legend.background = element_rect(fill="transparent"),
        legend.position = c(0.88,0.76),
        legend.text = element_text(size=11)))

remove(ColourDF, ContourLines, HyperChlPlot, ContourBreaks, PicoGAM_Plot_Prep)

```


```{r, MIT9313PARGAM, fig.height = 13, fig.width=7, warning=FALSE}

MIT9313PARGAM <-  MIT9313PAR / (ContourMIT9313RedHigh + ContourMIT9313BlueHigh)/ (ContourMIT9313RedInt + ContourMIT9313BlueInt)/ (ContourMIT9313RedLow + ContourMIT9313BlueLow)

MIT9313PARGAM

remove(MIT9313PAR, ContourMIT9313RedHigh, ContourMIT9313BlueHigh, ContourMIT9313RedInt, ContourMIT9313BlueInt, ContourMIT9313RedLow, ContourMIT9313BlueLow)

```

```{r save MIT9313GAM plots}

# MIT9313PARGAM.png for manuscript
 ggsave(file = file.path(paste(PlotsOut, sep = "/"), paste(GamStrain, "PARGAM", ".png", sep = ""), fsep = .Platform$file.sep), plot = MIT9313PARGAM,  height = 16.5, width = 10)


# MIT9313PARGAM is Fig8.tiff for PLOSONE submission
 ggsave(file = file.path(PlotsOutPLOS, "Fig8.tiff", fsep = .Platform$file.sep), plot = LabelledCombinedGam, device = NULL, scale = 1,  height = 10, width = 10,  compression = "lzw")
 
```

