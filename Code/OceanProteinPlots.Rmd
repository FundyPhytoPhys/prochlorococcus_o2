---
title: "OceanProteinPlots"
---
```{r libraries}
library(readr)
library(tidyverse)
library(ggplot2)
library(grid)
library(gridExtra)
```

Import Aurora .csv large files from DropBox, save as .RDS for future use and smaller files to post to GitHub
```{r files paths}
#/Users/dcampbel/Dropbox/OceanProteinProchloro/KM1128/2020/Filtered Datasets
#poi <- read_csv(file.path("..", "..", "..","..", "Dropbox", "OceanProteinProchloro", "KM1128", "2020", "Filtered_Datasets", "poi.csv"))
#pro_proteins <- read_csv(file.path("..", "..", "..","..", "Dropbox", "OceanProteinProchloro", "KM1128", "2020", "Filtered_Datasets", "pro_proteins.csv"))

#saveRDS(poi, file = file.path("..", "Data", "ProcessedData", "poi.RDS"))
#saveRDS(pro_proteins, file = file.path("..", "Data", "ProcessedData", "pro_proteins.RDS"))

#Read in previously imported and saved data converted from large .csv to smaller .RDS
poi <- readRDS(file.path("..", "Data", "ProcessedData", "ProcessedOceanProtein", "poi.RDS"))
pro_proteins <- readRDS(file.path("..", "Data", "ProcessedData", "ProcessedOceanProtein", "pro_proteins.RDS"))
```

```{r strains}
HL<-c("AS9601", "MIT9312", "MED4", "MIT9515","MIT9215", "MIT9301", "MIT9202")
LL<-c("MIT9313", "MIT9303", "SS120", "MIT9211", "NATL1A", "NATL2A")

strains_list<-c("MED4","MIT9515","AS9601","MIT9202","MIT9215","MIT9301","MIT9312","NATL1A","NATL2A", "MIT9211","SS120","MIT9303","MIT9313")
```



```{r set depth light and O2}
#estimated from LightPhotoperiodColourImaging/WaterAttenuation.Rmd

DepthPAR <- c(130, 70, 40)
PAR <- c(30, 90, 180)
names(DepthPAR) <- PAR

DepthPAR
names(DepthPAR)

O2_uM <- c(2, 25, 250)

```


```{r string function}
#not used
#wrapper <- function(x)
#{paste(strwrap(x), collapse = "\n")}
```

To analyze for presence/absence of additional proteins like AOX need to extract EC numbers from best_hit_annotation; difficult format delimited by ';' with variable numbers of fields.
EC 1.10.3.11, ubiquinol oxidase (non-electrogenic) 	cyanide-resistant bd-type ubiquinol oxidase, cyanide-resistant ubiquinol oxidase, cytochrome bo3 ubiquinol oxidase, ubiquinol oxidase (non-electrogenic)

EC 1.10.3.11 not detected by scan
KEGG EC 1.6.5.9  not detected; issue with search terms?
```{r extract hit info}
# pro_proteins2 <- pro_proteins |>
#   mutate(EC2 = str_extract(string = best_hit_annotation, pattern = "(?<=EC:)[0-9]*"))
# 
# pro_proteins2 <- pro_proteins |>
#   mutate(EC2 = str_extract(string = best_hit_annotation, pattern = "(?<=EC:)(\\d`.`+)"))
# 
# unique(pro_proteins2$EC2)
# 
# pro_proteins2 <- pro_proteins |>
#   separate_wider_delim(cols = best_hit_annotation, delim = ";", names = c("anno1", "anno2", "anno3", "anno4", "anno5", "anno6" ,"anno7", "anno8"), too_few = "align_start", cols_remove = FALSE)
# 
# head(pro_proteins2)
# 
# #detect EC 1.10.3.11
# pro_proteins2 <- pro_proteins |>
#   mutate(AOX = str_detect(string = best_hit_annotation, pattern = "1.10.3.11"))
# 
# head(pro_proteins2)

# #detect KEGG EC 1.6.5.9  
pro_proteins2 <- pro_proteins |>
   mutate(AOX = str_detect(string = best_hit_annotation, pattern = "1.6.5.9"))
 
 head(pro_proteins2)
 unique(pro_proteins2$AOX)
```

```{r pro_proteins plots}

pro_proteins |>
  ggplot()+
  geom_point(aes(x = O2, y= depth)) +
  scale_x_continuous(limits = c(0, 260)) +
  scale_y_reverse(limits = c(260, 0)) +
  geom_vline(xintercept = O2_uM,   linewidth = 2, alpha = 0.2) +
  geom_hline(yintercept = DepthPAR, linewidth = 2, alpha = 0.2) +
  labs(title = "All detections of Prochlorococcus proteins from OceanProteinPlots.Rmd, from pro_proteins",
       caption = "Horizontals approximate experimental growth light levels; Verticals indicate experimental growth oxygen levels") +
  theme_bw()

#ggsave(plot = last_plot(), filename = (file.path("..", "OutPut", "ProchloroAllProteinsDepthO2.png")))

pro_proteins |>
    filter(strain %in% c("MIT9313","MED4", "SS120")) |>
  ggplot()+
  geom_point(aes(x = O2, y= depth)) +
  scale_x_continuous(limits = c(0, 260)) +
  scale_y_reverse(limits = c(260, 0)) +
  geom_vline(xintercept = O2_uM,   linewidth = 2, alpha = 0.2) +
  geom_hline(yintercept = DepthPAR, linewidth = 2, alpha = 0.2) +
  labs(title = "All detections of MIT9313,MED4, SS120 proteins from OceanProteinPlots.Rmd, from pro_proteins",
       caption = "Horizontals approximate experimental growth light levels; Verticals indicate experimental growth oxygen levels") +
  theme_bw()

#ggsave(plot = last_plot(), filename = (file.path("..", "OutPut", "MIT9313MED4SS120AllProteinsDepthO2.png")))


#data for all strains/clades is nearly identical;  were all strains/clades truly detected at all sampling points where any Prochlorococcus is present

poi |>
  filter(strain %in% c("MIT9313","MED4", "SS120")) |>
  ggplot()+
  geom_point(aes(x = O2, y= depth)) +
  scale_x_continuous(limits = c(0, 260)) +
  scale_y_reverse(limits = c(260, 0)) +
  geom_vline(xintercept = O2_uM,   linewidth = 2, alpha = 0.2) +
  geom_hline(yintercept = DepthPAR, linewidth = 2, alpha = 0.2) +
  facet_grid(vars(strain)) +
  theme(panel.grid.minor = element_line(size = 0), panel.grid.major = element_line(size = 2)) +
  theme_bw()

```

Add Supercomplex categories desired for plotting to poi; one column with values or separate 0/1 columns for each category?
One column better for facetting; separate 0/1 columns better for filter/grid arrange
Aurora used grid arrange
```{r}
# poi <- poi |>
#   mutate(Supercomplex = 
#            case_when(complex == "ribosome" ~ complex,
#                      complex == "psii" ~ complex,
#                      complex == "psi" ~ complex,
#                      complex == "carb" ~ complex,
#                      subunit %in% unique(grep("pcb.",poi$subunit, value = TRUE, ignore.case=TRUE)) ~ "Pcb",
#                      subunit %in% c("ftsh1", "ftsh2") ~ "FtsH12",
#                      subunit %in% c("ftsh3", "ftsh4") ~ "FtsH34",
#                      )
#          
#          ) 
# 
# 
# unique(poi$Supercomplex)

         
#          , 
#   subunit %in% atp ~ "atp",
#   subunit %in% psii ~ "psii", 
#   subunit %in% psi ~ "psi",
#   subunit %in% rbc ~ "rubisco",
#   subunit %in% pet ~ "cytb6f",
#   subunit %in% ndh ~ "ndh",
#   subunit %in% clp ~ "clp",
#   subunit %in% cpe ~ "cpe",
#   subunit %in% ycf ~ "ycf",
#   subunit %in% carb ~ "carb",
#   subunit %in% iron ~ "iron stress",
#   subunit=="ftsZ" ~ subunit,
#   subunit=="ftsh1" ~ subunit,
#   subunit=="ftsh2" ~ subunit,
#   subunit=="ftsh3" ~ subunit,
#   subunit=="ftsh4" ~ subunit,
#   subunit=="fdx" ~ subunit,
#   subunit=="pc" ~ subunit,
#   subunit=="psb28" ~ subunit,
#   subunit=="psb27" ~ subunit,
#   subunit %in% pcb ~ subunit,))
#   
#   
# rp<-unique(grep("rpl.",poi$subunit, value = TRUE, ignore.case=TRUE))
# rp<-append(rp, unique(grep("rps.",poi$subunit, value = TRUE, ignore.case=TRUE)))
# rp<-append(rp, unique(grep("rpm.",poi$subunit, value = TRUE, ignore.case=TRUE)))
# 
# atp<-unique(grep("atp.",poi$subunit, value = TRUE, ignore.case=TRUE))
# 
# pcb<-unique(grep("pcb.",poi$subunit, value = TRUE, ignore.case=TRUE))
# 
# psii<-c("psbA", "psbB", "psbC", "psbD", "psbE", "psbF", "psbJ", "psbO", "psbP", "psbV")
# 
# psi<-unique(grep("psa.",poi$subunit, value = TRUE, ignore.case=TRUE))
# 
# rbc<-unique(grep("rbc.",poi$subunit, value = TRUE, ignore.case=TRUE))
# 
# pet<-unique(grep("pet.",poi$subunit, value = TRUE, ignore.case=TRUE))
# 
# ftsh<-unique(grep("ftsh.",poi$subunit, value = TRUE, ignore.case=TRUE))
# 
# clp<-unique(grep("clp.",poi$subunit, value = TRUE, ignore.case=TRUE))
# 
# cpe<-unique(grep("cpe.",poi$subunit, value = TRUE, ignore.case=TRUE))
# 
# ycf<-unique(grep("ycf.",poi$subunit, value = TRUE, ignore.case=TRUE))
# 
# iron<-unique(grep("isi.",poi$subunit, value = TRUE, ignore.case=TRUE))
# 
# carb<-c("pgm", "glk", "pgi", "zwf", "nagB", "gnd", "prk", "rpe", "rpi", "tkt", "tal","tpi", "gapdh", "pgk", "gpmB", "eno", "pykF", "fba", "glpX", "pgi","pdhA", "pdhB", "pdhC", "lpd", "gltA", "acnB", "icd NAD", "icd NADP","ppc", "dld")
# 
# ndh<- unique(grep("ndh.", poi$subunit, ignore.case=T, value=T))
# 
# ccm<-c("csos2","csos3","cpa","cpb")
# 
# poi<-mutate(poi, complex=case_when(
#   subunit %in% rp ~ "ribosome", 
#   subunit %in% atp ~ "atp",
#   subunit %in% psii ~ "psii", 
#   subunit %in% psi ~ "psi",
#   subunit %in% rbc ~ "rubisco",
#   subunit %in% pet ~ "cytb6f",
#   subunit %in% ndh ~ "ndh",
#   subunit %in% clp ~ "clp",
#   subunit %in% cpe ~ "cpe",
#   subunit %in% ycf ~ "ycf",
#   subunit %in% carb ~ "carb",
#   subunit %in% iron ~ "iron stress",
#   subunit=="ftsZ" ~ subunit,
#   subunit=="ftsh1" ~ subunit,
#   subunit=="ftsh2" ~ subunit,
#   subunit=="ftsh3" ~ subunit,
#   subunit=="ftsh4" ~ subunit,
#   subunit=="fdx" ~ subunit,
#   subunit=="pc" ~ subunit,
#   subunit=="psb28" ~ subunit,
#   subunit=="psb27" ~ subunit,
#   subunit %in% pcb ~ subunit,
#   
#   )
# )
# ppp<-c("tkt", "gnd","pgl","tal","zwf","rpe","rpi","glpX","pgm","pgi","deoC","prpp","glk")
# ppp_enz<-filter(poi, subunit %in% ppp)
# ppp_enz<-mutate(ppp_enz, complex="ppp")
# 
# tca<-c("mqo", "mdh","icd NAD","icd NADP","fdx","sdh", "gltA","fum")
# tca_enz<-filter(poi, subunit %in% tca)
# tca_enz<-mutate(tca_enz, complex="tca")
# 
# calvin<-c("tpi", "fba","tktA", "gapdh", "glpX", "tpiA","prk","pgk","rbcL","rbcS","rpe","rpiA")
# calvin_enz<-filter(poi, subunit %in% calvin)
# calvin_enz<-mutate(calvin_enz, complex="calvin")
# 
# poi<-rbind(calvin_enz, poi)
# poi<-rbind(tca_enz, poi)
# poi<-rbind(ppp_enz, poi)
# 
# poi<-filter(poi,!is.na(poi$complex))
# unique(poi$complex)
# unique(poi$subunit)  
```


```{r depth O2 plots}

#consider including ribosomal target for photoinhibition?
#consider assembling 'pcb' supercomplex?
#https://stackoverflow.com/questions/32555531/how-to-italicize-part-one-or-two-words-of-an-axis-title

PhotosynthLabels <- c("PSII", "Cytb6f", "PSI", "ATP Synthase", "RUBISCO")
ProteinMetabLabels <- c("FtsH1", "FtsH2", "FtsH3", "FtsH4", "Ribosome")
StrainLabels <- c("MED4", "SS120", "MIT9313")

ElectronTrans <- c("psii", "cytb6f", "psi", "rubisco", "atp")

ProteinMetab <- c("ftsh1", "ftsh2", "ftsh3", "ftsh4", "ribosome")


poi |>
  filter(complex %in% ElectronTrans) |>
  filter(strain %in% StrainLabels) |>
  ggplot() +
  geom_point(aes(color=clade, x = O2, y= depth)) +
  scale_x_continuous(limits = c(0, 260)) +
  scale_y_reverse(limits = c(260, 0)) +
  geom_vline(xintercept = O2_uM,   linewidth = 2, alpha = 0.1) +
  geom_hline(yintercept = DepthPAR, linewidth = 2, alpha = 0.1) +
  facet_grid(factor(strain, levels = c("MED4", "SS120", "MIT9313")) ~ factor(complex, levels = c("psii", "cytb6f", "psi", "rubisco", "atp"), labels = PhotosynthLabels)) +
  labs(title = expression('Ocean detection of' ~italic(Prochlorococcus)~ 'photosynthesis complexes'),
       y = "Depth (m)",
       x = expression("O"[2] ~ "(µM)")) +
    # ) +
  theme_bw()

 ggsave(plot = last_plot(), filename = (file.path("..", "OutPut", "Figures", "ProchloroPhotosynthDepthO2.png")))
 ggsave(plot = last_plot(), filename = (file.path("..", "OutPut", "Figures", "ProchloroPhotosynthDepthO2.tiff")))

poi |>
  filter(complex %in% ProteinMetab) |>
  filter(strain %in% StrainLabels) |>
  ggplot() +
  geom_point(aes(color=clade, x = O2, y= depth)) +
  scale_x_continuous(limits = c(0, 260)) +
  scale_y_reverse(limits = c(260, 0)) +
  geom_vline(xintercept = O2_uM,   linewidth = 2, alpha = 0.1) +
  geom_hline(yintercept = DepthPAR, linewidth = 2, alpha = 0.1) +
  facet_grid(factor(strain, levels = c("MED4", "SS120", "MIT9313")) ~ factor(complex, levels = c("ftsh1", "ftsh2", "ftsh3", "ftsh4", "ribosome"), labels = ProteinMetabLabels)) +
   labs(y = "Depth (m)",
        x = expression("O"[2] ~ "(µM)"),
        title = expression('Ocean detection of' ~italic(Prochlorococcus)~ 'protein metabolism complexes')) +
  theme_bw()

 ggsave(plot = last_plot(), filename = (file.path("..", "OutPut", "Figures", "ProchloroProteinMetabDepthO2.png")))
 ggsave(plot = last_plot(), filename = (file.path("..", "OutPut", "Figures", "ProchloroProteinMetabDepthO2.tiff")))

  


```


